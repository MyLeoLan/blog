<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>LeoLan&#39;s Blog</title>
  <subtitle>有时候正是不报期望的人做出了人们不敢期望之事！</subtitle>
  <link href="/atom.xml" rel="self"/>
  
  <link href="https://www.leolan.top/"/>
  <updated>2017-06-05T02:49:39.994Z</updated>
  <id>https://www.leolan.top/</id>
  
  <author>
    <name>LeoLan</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>MySQL高可用之MHA</title>
    <link href="https://www.leolan.top/posts/21355/"/>
    <id>https://www.leolan.top/posts/21355/</id>
    <published>2017-06-05T02:44:32.000Z</published>
    <updated>2017-06-05T02:49:39.994Z</updated>
    
    <content type="html"><![CDATA[<script src="/assets/js/DPlayer.min.js"> </script><script src="/assets/js/APlayer.min.js"> </script><p>微信看到的文章，原样搬过来，还未试验过，有机会会试验一下。原文：<a href="http://mp.weixin.qq.com/s?mpshare=1&amp;scene=23&amp;mid=2247483680&amp;sn=85027dcad2284a007c1effc412c598b2&amp;idx=1&amp;__biz=MzI0NjgxNzYxMQ%3D%3D&amp;chksm=e9b83704decfbe12d04e9d3bf383236f44984b0dc913c9fcc011b986404adcf2649557502380&amp;srcid=0408q21kEw5mh8I5tcVzQRiK#rd" target="_blank" rel="external">MySQL高可用之MHA—部署MHA</a></p>
<p>由于MHA不会自动创建主从环境，所以要手动去部署主从环境，也可以在现有主从环境部署MHA。所有slave不要设置为只读，同时也要打开binlog。如果master故障后要切换到指定的slave上，该指定的slave打开binlog，设置可读写，其它不用设置打开binlog或设置只读也可。具体以自身架构为准。<br>        部署MySQL主从可参考：配置MySQL主从复制</p>
<h1 id="架构图"><a href="#架构图" class="headerlink" title="架构图"></a>架构图</h1><p><img src="https://image.leolan.top/mysql_MHA.png" alt="mysql_MHA"></p>
<h1 id="系统环境"><a href="#系统环境" class="headerlink" title="系统环境"></a>系统环境</h1><figure class="highlight stylus"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="selector-id">#cat</span> /etc/redhat-release</div><div class="line">CentOSrelease <span class="number">6.6</span> (Final)</div><div class="line"><span class="selector-id">#uname</span> -rm</div><div class="line"><span class="number">2.6</span>.<span class="number">32</span>-<span class="number">504</span><span class="selector-class">.el6</span><span class="selector-class">.x86_64x86_64</span></div></pre></td></tr></table></figure>
<h1 id="创建MHA用户"><a href="#创建MHA用户" class="headerlink" title="创建MHA用户"></a>创建MHA用户</h1><p>在主从环境的主上执行<br><figure class="highlight lasso"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">mysql&gt; grant <span class="literal">all</span> privileges <span class="keyword">on</span> *.* <span class="keyword">to</span> <span class="string">'mha'</span>@<span class="string">'192.168.56.%'</span> identified <span class="keyword">by</span> <span class="string">'123456'</span>;</div></pre></td></tr></table></figure></p>
<h1 id="创建软链接"><a href="#创建软链接" class="headerlink" title="创建软链接"></a>创建软链接</h1><p>如果MySQL服务不是yum安装，要在所有MySQLServer上，无论主从都要执行如下两个命令。<br><figure class="highlight vala"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="meta"># ln -s /application/mysql/bin/mysqlbinlog /usr/bin/mysqlbinlog</span></div><div class="line"><span class="meta"># ln -s /application/mysql/bin/mysql /usr/bin/mysql</span></div></pre></td></tr></table></figure></p>
<h1 id="配置SSH公钥认证"><a href="#配置SSH公钥认证" class="headerlink" title="配置SSH公钥认证"></a>配置SSH公钥认证</h1><p>几台服务器进行相同操作，仅分发到的服务不同而已，这里仅列出一台。</p>
<h1 id="添加统一用户"><a href="#添加统一用户" class="headerlink" title="添加统一用户"></a>添加统一用户</h1><p>在生产环境下使用root用户不安全，也不规范。并且环境统一也比较方便管理，因此可以创建统一的普通用户来进行。</p>
<h1 id="创建密钥对"><a href="#创建密钥对" class="headerlink" title="创建密钥对"></a>创建密钥对</h1><figure class="highlight autoit"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root<span class="symbol">@mha</span>-manager ~]<span class="meta"># ssh-keygen -t dsa</span></div></pre></td></tr></table></figure>
<h1 id="将公钥分发到各个主机上"><a href="#将公钥分发到各个主机上" class="headerlink" title="将公钥分发到各个主机上"></a>将公钥分发到各个主机上</h1><figure class="highlight lsl"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">[root@mha-manager ~]# ssh-copy-id -i .ssh/id_dsa.pub root@<span class="number">192.168</span><span class="number">.56</span><span class="number">.12</span></div><div class="line">[root@mha-manager ~]# ssh-copy-id -i .ssh/id_dsa.pub root@<span class="number">192.168</span><span class="number">.56</span><span class="number">.13</span></div><div class="line">[root@mha-manager ~]# ssh-copy-id -i .ssh/id_dsa.pub root@<span class="number">192.168</span><span class="number">.56</span><span class="number">.14</span></div></pre></td></tr></table></figure>
<h1 id="验证"><a href="#验证" class="headerlink" title="验证"></a>验证</h1><figure class="highlight livescript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">[root@mha-manager ~]<span class="comment"># ssh root@192.168.56.12</span></div><div class="line">Last login: Thu May <span class="number">19</span> <span class="number">21</span>:<span class="number">05</span>:<span class="number">07</span> <span class="number">2016</span> <span class="keyword">from</span> mysql-master</div><div class="line">[root@mysql-master ~]<span class="comment"># exit</span></div><div class="line">[root@mha-manager ~]<span class="comment"># ssh root@192.168.56.13</span></div><div class="line">Last login: Wed May <span class="number">18</span> <span class="number">12</span>:<span class="number">43</span>:<span class="number">20</span> <span class="number">2016</span> <span class="keyword">from</span> <span class="number">172.16</span>.<span class="number">1.1</span></div><div class="line">[root@mysql-slave01 ~]<span class="comment"># exit</span></div><div class="line">[root@mha-manager ~]<span class="comment"># ssh root@192.168.56.14</span></div><div class="line">Last login: Wed May <span class="number">18</span> <span class="number">17</span>:<span class="number">56</span>:<span class="number">40</span> <span class="number">2016</span> <span class="keyword">from</span> <span class="number">172.16</span>.<span class="number">1.1</span></div><div class="line">[root@mysql-slave02 ~]<span class="comment"># exit</span></div></pre></td></tr></table></figure>
<h1 id="配置hosts"><a href="#配置hosts" class="headerlink" title="配置hosts"></a>配置hosts</h1><figure class="highlight x86asm"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">[root@mha-manager ~]# vim /etc/hosts</div><div class="line"><span class="number">192.168</span><span class="meta">.56</span><span class="meta">.11</span>  mha-manager</div><div class="line"><span class="number">192.168</span><span class="meta">.56</span><span class="meta">.12</span>  mysql-master</div><div class="line"><span class="number">192.168</span><span class="meta">.56</span><span class="meta">.13</span>  mysql-slave01</div><div class="line"><span class="number">192.168</span><span class="meta">.56</span><span class="meta">.14</span>  mysql-slave02</div><div class="line">root@mha-manager ~]# scp /etc/hosts root@<span class="number">192.168</span><span class="meta">.56</span><span class="meta">.12</span>:/etc/</div><div class="line">hosts                                                   <span class="number">100</span>%  <span class="number">271</span>     <span class="number">0.</span>3KB/s   <span class="number">00</span>:<span class="number">00</span>    </div><div class="line">[root@mha-manager ~]# scp /etc/hosts root@<span class="number">192.168</span><span class="meta">.56</span><span class="meta">.13</span>:/etc/</div><div class="line">hosts                                                   <span class="number">100</span>%  <span class="number">271</span>     <span class="number">0.</span>3KB/s   <span class="number">00</span>:<span class="number">00</span>    </div><div class="line">[root@mha-manager ~]# scp /etc/hosts root@<span class="number">192.168</span><span class="meta">.56</span><span class="meta">.14</span>:/etc/</div><div class="line">hosts                                                   <span class="number">100</span>%  <span class="number">271</span>     <span class="number">0.</span>3KB/s   <span class="number">00</span>:<span class="number">00</span></div></pre></td></tr></table></figure>
<h1 id="部署MHA-Node"><a href="#部署MHA-Node" class="headerlink" title="部署MHA Node"></a>部署MHA Node</h1><p>在所有运行MySQL服务的服务器上运行MHA Node，无论是master还是slave。由于MHA　Manager需要MHA　Node，因此在运行MHA　Manager的服务器上也需要安装MHA　Node。当然也可以在任意一个slave上运行MHA　Manager。因为部署步骤相同，所以就列出一个安装步骤（在mha-manager服务器上）。</p>
<h1 id="创建目录"><a href="#创建目录" class="headerlink" title="创建目录"></a>创建目录</h1><figure class="highlight autoit"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root<span class="symbol">@mha</span>-manager ~]<span class="meta"># mkdir /soft</span></div></pre></td></tr></table></figure>
<h1 id="安装MHA-Node"><a href="#安装MHA-Node" class="headerlink" title="安装MHA Node"></a>安装MHA Node</h1><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">[root@mha-manager ~]<span class="comment"># rpm -ivh http://dl.fedoraproject.org/pub/epel/6/x86_64/epel-release-6-8.noarch.rpm</span></div><div class="line">[root@mha-manager ~]<span class="comment"># yum install -y perl-DBD-MySQL perl-DBI cpan</span></div><div class="line"><span class="comment">#perl-Module-Install </span></div><div class="line">[root@mha-manager ~]<span class="comment"># cd /softs/</span></div><div class="line">[root@mha-manager softs]<span class="comment"># git clone https://github.com/kevin-hao/mha-node.git</span></div><div class="line">[root@mha-manager softs]<span class="comment"># cd mha-node/</span></div><div class="line">[root@mha-manager mha-<span class="keyword">node</span><span class="title">]# perl</span> Makefile.PL</div><div class="line">[root@mha-manager mha-<span class="keyword">node</span><span class="title">]# make</span> &amp;&amp; make install</div><div class="line">[root@mha-manager mha-<span class="keyword">node</span><span class="title">]# cd</span></div></pre></td></tr></table></figure>
<p>其它MySQL服务器上的部署步骤一样，再次省略。</p>
<h1 id="安装MHA-Manager"><a href="#安装MHA-Manager" class="headerlink" title="安装MHA Manager"></a>安装MHA Manager</h1><figure class="highlight vim"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">[root@mha-manager ~]# yum install -<span class="keyword">y</span> <span class="keyword">perl</span> <span class="keyword">perl</span>-Config-Tiny <span class="keyword">perl</span>-Email-Date-Forma <span class="keyword">perl</span>-Log-Dispatch <span class="keyword">perl</span>-MIME-Lite <span class="keyword">perl</span>-MIME-Types <span class="keyword">perl</span>-Mail-Sender <span class="keyword">perl</span>-Mail-Sendmail <span class="keyword">perl</span>-MailTools <span class="keyword">perl</span>-Parallel-ForkManager <span class="keyword">perl</span>-Params-Validate <span class="keyword">perl</span>-Time-HiRes <span class="keyword">perl</span>-TimeDate</div><div class="line">#perl-Config-Tiny <span class="keyword">perl</span>-Log-Dispatch <span class="keyword">perl</span>-Parallel-ForkManager <span class="keyword">perl</span>-Time-HiRes</div><div class="line">[root@mha-manager ~]# <span class="keyword">cd</span> /softs/</div><div class="line">[root@mha-manager softs]# git clone http<span class="variable">s:</span>//github.<span class="keyword">com</span>/kevin-hao/mha-manager.git</div><div class="line">[root@mha-manager softs]# <span class="keyword">cd</span> mha-manager/</div><div class="line">[root@mha-manager mha-manager]# <span class="keyword">perl</span> Makefile.PL</div><div class="line">[root@mha-manager mha-manager]# <span class="keyword">make</span> &amp;&amp; <span class="keyword">make</span> install</div><div class="line">[root@mha-manager mha-manager]# <span class="keyword">cd</span></div></pre></td></tr></table></figure>
<h1 id="规范MHA目录"><a href="#规范MHA目录" class="headerlink" title="规范MHA目录"></a>规范MHA目录</h1><figure class="highlight vim"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">[root@mha-manager ~]# <span class="built_in">mkdir</span> -<span class="keyword">p</span> /application/mha/<span class="keyword">conf</span> </div><div class="line">[root@mha-manager ~]# <span class="keyword">cp</span> /softs/mha-manager/samples/<span class="keyword">conf</span>/* /application/mha/<span class="keyword">conf</span></div></pre></td></tr></table></figure>
<h1 id="配置app1-cnf"><a href="#配置app1-cnf" class="headerlink" title="配置app1.cnf"></a>配置app1.cnf</h1><figure class="highlight ini"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="section">[root@mha-manager ~]</span><span class="comment"># mkdir -p /application/mha/workstatus/app1</span></div><div class="line"><span class="section">[root@mha-manager ~]</span><span class="comment"># cd /application/mha/conf/</span></div><div class="line"><span class="section">[root@mha-manager conf]</span><span class="comment"># cp app1.cnf app1.cnf.ori</span></div><div class="line"><span class="section">[root@mha-manager conf]</span><span class="comment"># vim app1.cnf</span></div><div class="line"><span class="section">[server default]</span></div><div class="line"><span class="attr">port</span>=<span class="number">3306</span></div><div class="line"><span class="attr">user</span>=mha</div><div class="line"><span class="attr">password</span>=<span class="number">123456</span></div><div class="line"><span class="attr">repl_user</span>=repuser</div><div class="line"><span class="attr">repl_password</span>=<span class="number">123456</span></div><div class="line"><span class="attr">remote_workdir</span>=/var/log/mha/app1</div><div class="line"><span class="attr">master_binlog_dir</span>=/data/mysql_log/</div><div class="line"><span class="attr">manager_workdir</span>=/application/mha/workstatus/app1</div><div class="line"><span class="attr">manager_log</span>= /application/mha/logs/app1.log</div><div class="line"><span class="section"></span></div><div class="line">[server1]</div><div class="line"><span class="attr">hostname</span>=mysql-master</div><div class="line"><span class="section"></span></div><div class="line">[server2]</div><div class="line"><span class="attr">hostname</span>=mysql-slave01</div><div class="line"><span class="attr">candidate_master</span>=<span class="number">1</span></div><div class="line"><span class="section"></span></div><div class="line">[server3]</div><div class="line"><span class="attr">hostname</span>=mysql-slave02</div><div class="line"><span class="attr">candidate_master</span>=<span class="number">1</span></div></pre></td></tr></table></figure>
<h1 id="配置全局配置文件"><a href="#配置全局配置文件" class="headerlink" title="配置全局配置文件"></a>配置全局配置文件</h1><figure class="highlight ini"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="section">[root@mha-manager conf]</span><span class="comment"># cp masterha_default.cnf masterha_default.cnf.ori</span></div><div class="line"><span class="section">[root@mha-manager conf]</span><span class="comment"># vim masterha_default.cnf</span></div><div class="line"><span class="section">[server default]</span></div><div class="line"><span class="attr">log-level</span>=debug</div><div class="line"><span class="attr">check_repl_delay</span>=<span class="number">1</span></div><div class="line"><span class="attr">check_repl_filter</span>=<span class="number">1</span></div><div class="line"><span class="attr">ping_interval</span>=<span class="number">5</span></div><div class="line"><span class="attr">ping_type</span>=CONNECT</div><div class="line"><span class="section">[root@mha-manager conf]</span><span class="comment"># cd</span></div></pre></td></tr></table></figure>
<h1 id="检查配置"><a href="#检查配置" class="headerlink" title="检查配置"></a>检查配置</h1><p>操作在mha-manager上进行</p>
<h1 id="检查SSH连接性"><a href="#检查SSH连接性" class="headerlink" title="检查SSH连接性"></a>检查SSH连接性</h1><figure class="highlight scheme"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">[<span class="name">root@mha-manager</span> ~]# masterha_check_ssh --conf=/application/mha/conf/app1.cnf</div><div class="line">Wed May <span class="number">25</span> <span class="number">23</span>:12:39 <span class="number">2016</span> - [<span class="name">warning</span>] Global configuration file /etc/masterha_default.cnf not found. Skipping.</div><div class="line">Wed May <span class="number">25</span> <span class="number">23</span>:12:39 <span class="number">2016</span> - [<span class="name">info</span>] Reading application default configuration from /application/mha/conf/app1.cnf..</div><div class="line">Wed May <span class="number">25</span> <span class="number">23</span>:12:39 <span class="number">2016</span> - [<span class="name">info</span>] Reading server configuration from /application/mha/conf/app1.cnf..</div><div class="line">Wed May <span class="number">25</span> <span class="number">23</span>:12:39 <span class="number">2016</span> - [<span class="name">info</span>] Starting SSH connection tests..</div><div class="line">Wed May <span class="number">25</span> <span class="number">23</span>:12:40 <span class="number">2016</span> - [<span class="name">debug</span>] </div><div class="line">Wed May <span class="number">25</span> <span class="number">23</span>:12:39 <span class="number">2016</span> - [<span class="name">debug</span>]  Connecting via SSH from root@mysql-master(<span class="name">192.168.56.12:22</span>) to root@mysql-slave01(<span class="name">192.168.56.13:22</span>)..</div><div class="line">Wed May <span class="number">25</span> <span class="number">23</span>:12:40 <span class="number">2016</span> - [<span class="name">debug</span>]   ok.</div><div class="line">Wed May <span class="number">25</span> <span class="number">23</span>:12:40 <span class="number">2016</span> - [<span class="name">debug</span>]  Connecting via SSH from root@mysql-master(<span class="name">192.168.56.12:22</span>) to root@mysql-slave02(<span class="name">192.168.56.14:22</span>)..</div><div class="line">Wed May <span class="number">25</span> <span class="number">23</span>:12:40 <span class="number">2016</span> - [<span class="name">debug</span>]   ok.</div><div class="line">Wed May <span class="number">25</span> <span class="number">23</span>:12:41 <span class="number">2016</span> - [<span class="name">debug</span>] </div><div class="line">Wed May <span class="number">25</span> <span class="number">23</span>:12:40 <span class="number">2016</span> - [<span class="name">debug</span>]  Connecting via SSH from root@mysql-slave01(<span class="name">192.168.56.13:22</span>) to root@mysql-master(<span class="name">192.168.56.12:22</span>)..</div><div class="line">Wed May <span class="number">25</span> <span class="number">23</span>:12:40 <span class="number">2016</span> - [<span class="name">debug</span>]   ok.</div><div class="line">Wed May <span class="number">25</span> <span class="number">23</span>:12:40 <span class="number">2016</span> - [<span class="name">debug</span>]  Connecting via SSH from root@mysql-slave01(<span class="name">192.168.56.13:22</span>) to root@mysql-slave02(<span class="name">192.168.56.14:22</span>)..</div><div class="line">Wed May <span class="number">25</span> <span class="number">23</span>:12:41 <span class="number">2016</span> - [<span class="name">debug</span>]   ok.</div><div class="line">Wed May <span class="number">25</span> <span class="number">23</span>:12:41 <span class="number">2016</span> - [<span class="name">debug</span>] </div><div class="line">Wed May <span class="number">25</span> <span class="number">23</span>:12:40 <span class="number">2016</span> - [<span class="name">debug</span>]  Connecting via SSH from root@mysql-slave02(<span class="name">192.168.56.14:22</span>) to root@mysql-master(<span class="name">192.168.56.12:22</span>)..</div><div class="line">Wed May <span class="number">25</span> <span class="number">23</span>:12:41 <span class="number">2016</span> - [<span class="name">debug</span>]   ok.</div><div class="line">Wed May <span class="number">25</span> <span class="number">23</span>:12:41 <span class="number">2016</span> - [<span class="name">debug</span>]  Connecting via SSH from root@mysql-slave02(<span class="name">192.168.56.14:22</span>) to root@mysql-slave01(<span class="name">192.168.56.13:22</span>)..</div><div class="line">Wed May <span class="number">25</span> <span class="number">23</span>:12:41 <span class="number">2016</span> - [<span class="name">debug</span>]   ok.</div><div class="line">Wed May <span class="number">25</span> <span class="number">23</span>:12:41 <span class="number">2016</span> - [<span class="name">info</span>] All SSH connection tests passed successfully.</div></pre></td></tr></table></figure>
<h1 id="检查主从复制状态"><a href="#检查主从复制状态" class="headerlink" title="检查主从复制状态"></a>检查主从复制状态</h1><figure class="highlight scheme"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">[<span class="name">root@mha-manager</span> ~]# masterha_check_repl --conf=/application/mha/conf/app1.cnf</div><div class="line">***********中间省略*************</div><div class="line">Wed May <span class="number">25</span> <span class="number">23</span>:13:19 <span class="number">2016</span> - [<span class="name">info</span>] </div><div class="line">mysql-master(<span class="name">192.168.56.12:3306</span>) (<span class="name">current</span> master)</div><div class="line"> +--mysql-slave01(<span class="name">192.168.56.13:3306</span>)</div><div class="line"> +--mysql-slave02(<span class="name">192.168.56.14:3306</span>)</div><div class="line"></div><div class="line">Wed May <span class="number">25</span> <span class="number">23</span>:13:19 <span class="number">2016</span> - [<span class="name">info</span>] Checking replication health on mysql-slave01..</div><div class="line">Wed May <span class="number">25</span> <span class="number">23</span>:13:19 <span class="number">2016</span> - [<span class="name">info</span>]  ok.</div><div class="line">Wed May <span class="number">25</span> <span class="number">23</span>:13:19 <span class="number">2016</span> - [<span class="name">info</span>] Checking replication health on mysql-slave02..</div><div class="line">Wed May <span class="number">25</span> <span class="number">23</span>:13:19 <span class="number">2016</span> - [<span class="name">info</span>]  ok.</div><div class="line">Wed May <span class="number">25</span> <span class="number">23</span>:13:19 <span class="number">2016</span> - [<span class="name">warning</span>] master_ip_failover_script is not defined.</div><div class="line">Wed May <span class="number">25</span> <span class="number">23</span>:13:19 <span class="number">2016</span> - [<span class="name">warning</span>] shutdown_script is not defined.</div><div class="line">Wed May <span class="number">25</span> <span class="number">23</span>:13:19 <span class="number">2016</span> - [<span class="name">info</span>] Got exit code <span class="number">0</span> (<span class="name">Not</span> master dead).</div><div class="line">MySQL Replication Health is OK.   &lt;=====表明当前app1的主从环境正常</div></pre></td></tr></table></figure>
<h1 id="启动manager"><a href="#启动manager" class="headerlink" title="启动manager"></a>启动manager</h1><figure class="highlight autoit"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">[root<span class="symbol">@mha</span>-manager ~]<span class="meta"># mkdir /application/mha/logs</span></div><div class="line">[root<span class="symbol">@mha</span>-manager ~]<span class="meta"># masterha_manager --conf=/application/mha/conf/app1.cnf &gt;/dev/null 2&gt;&amp;1 &amp;</span></div></pre></td></tr></table></figure>
<h1 id="检查manager状态"><a href="#检查manager状态" class="headerlink" title="检查manager状态"></a>检查manager状态</h1><figure class="highlight scheme"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">[<span class="name">root@mha-manager</span> ~]# masterha_check_status --conf=/application/mha/conf/app1.cnf</div><div class="line">app1 (<span class="name">pid:27335</span>) is running(<span class="name">0:PING_OK</span>), master:mysql-master</div></pre></td></tr></table></figure>
<h1 id="master-故障切换测试"><a href="#master-故障切换测试" class="headerlink" title="master 故障切换测试"></a>master 故障切换测试</h1><h2 id="停止master服务"><a href="#停止master服务" class="headerlink" title="停止master服务"></a>停止master服务</h2><p>在master上停止mysqld进程，然后查看log可以看出进行了切换。<br><figure class="highlight scheme"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">[<span class="name">root@mysql-master</span> ~]# /etc/init.d/mysqld stop</div><div class="line">[<span class="name">root@mha-manager</span> ~]# tail -F /application/mha/logs/app1.log</div><div class="line">----- Failover Report -----</div><div class="line"></div><div class="line">app1: MySQL Master failover mysql-master(<span class="name">192.168.56.12:3306</span>) to mysql-slave01(<span class="name">192.168.56.13:3306</span>) succeeded</div><div class="line"></div><div class="line">Master mysql-master(<span class="name">192.168.56.12:3306</span>) is down!</div><div class="line"></div><div class="line">Check MHA Manager logs at mha-manager:/application/mha/logs/app1.log for details.</div><div class="line"></div><div class="line">Started automated(<span class="name">non-interactive</span>) failover.</div><div class="line">The latest slave mysql-slave01(<span class="name">192.168.56.13:3306</span>) has all relay logs for recovery.</div><div class="line">Selected mysql-slave01(<span class="name">192.168.56.13:3306</span>) as a new master.</div><div class="line">mysql-slave01(<span class="name">192.168.56.13:3306</span>): OK: Applying all logs succeeded.</div><div class="line">mysql-slave02(<span class="name">192.168.56.14:3306</span>): This host has the latest relay log events.</div><div class="line">Generating relay diff files from the latest slave succeeded.</div><div class="line">mysql-slave02(<span class="name">192.168.56.14:3306</span>): OK: Applying all logs succeeded. Slave started, replicating from mysql-slave01(<span class="name">192.168.56.13:3306</span>)</div><div class="line">mysql-slave01(<span class="name">192.168.56.13:3306</span>): Resetting slave info succeeded.</div><div class="line">Master failover to mysql-slave01(<span class="name">192.168.56.13:3306</span>) completed successfully.</div></pre></td></tr></table></figure></p>
<h2 id="在mysql-slave02上查看"><a href="#在mysql-slave02上查看" class="headerlink" title="在mysql-slave02上查看"></a>在mysql-slave02上查看</h2><figure class="highlight yaml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div></pre></td><td class="code"><pre><div class="line">[root@mysql-slave02 ~]<span class="comment"># mysql -uroot -p123456 -e "show slave status\G"</span></div><div class="line"><span class="attr">Warning:</span> Using a password on the command line interface can be insecure.</div><div class="line">*************************** <span class="number">1.</span> row ***************************</div><div class="line"><span class="attr">               Slave_IO_State:</span> Waiting for master to send event</div><div class="line"><span class="attr">                  Master_Host:</span> <span class="number">192.168</span><span class="number">.56</span><span class="number">.13</span>    //master改变了</div><div class="line"><span class="attr">                  Master_User:</span> repuser</div><div class="line"><span class="attr">                  Master_Port:</span> <span class="number">3306</span></div><div class="line"><span class="attr">                Connect_Retry:</span> <span class="number">60</span></div><div class="line"><span class="attr">              Master_Log_File:</span> mysql-bin<span class="number">.000001</span></div><div class="line"><span class="attr">          Read_Master_Log_Pos:</span> <span class="number">120</span></div><div class="line"><span class="attr">               Relay_Log_File:</span> mysql-relay-bin<span class="number">.000002</span></div><div class="line"><span class="attr">                Relay_Log_Pos:</span> <span class="number">283</span></div><div class="line"><span class="attr">        Relay_Master_Log_File:</span> mysql-bin<span class="number">.000001</span></div><div class="line"><span class="attr">             Slave_IO_Running:</span> <span class="literal">Yes</span></div><div class="line"><span class="attr">            Slave_SQL_Running:</span> <span class="literal">Yes</span></div><div class="line"><span class="attr">              Replicate_Do_DB:</span> </div><div class="line"><span class="attr">          Replicate_Ignore_DB:</span> </div><div class="line"><span class="attr">           Replicate_Do_Table:</span> </div><div class="line"><span class="attr">       Replicate_Ignore_Table:</span> </div><div class="line"><span class="attr">      Replicate_Wild_Do_Table:</span> </div><div class="line"><span class="attr">  Replicate_Wild_Ignore_Table:</span> </div><div class="line"><span class="attr">                   Last_Errno:</span> <span class="number">0</span></div><div class="line"><span class="attr">                   Last_Error:</span> </div><div class="line"><span class="attr">                 Skip_Counter:</span> <span class="number">0</span></div><div class="line"><span class="attr">          Exec_Master_Log_Pos:</span> <span class="number">120</span></div><div class="line"><span class="attr">              Relay_Log_Space:</span> <span class="number">456</span></div><div class="line"><span class="attr">              Until_Condition:</span> None</div><div class="line"><span class="attr">               Until_Log_File:</span> </div><div class="line"><span class="attr">                Until_Log_Pos:</span> <span class="number">0</span></div><div class="line"><span class="attr">           Master_SSL_Allowed:</span> <span class="literal">No</span></div><div class="line"><span class="attr">           Master_SSL_CA_File:</span> </div><div class="line"><span class="attr">           Master_SSL_CA_Path:</span> </div><div class="line"><span class="attr">              Master_SSL_Cert:</span> </div><div class="line"><span class="attr">            Master_SSL_Cipher:</span> </div><div class="line"><span class="attr">               Master_SSL_Key:</span></div><div class="line"><span class="attr">        Seconds_Behind_Master:</span> <span class="number">0</span></div><div class="line"><span class="attr">Master_SSL_Verify_Server_Cert:</span> <span class="literal">No</span></div><div class="line"><span class="attr">                Last_IO_Errno:</span> <span class="number">0</span></div><div class="line"><span class="attr">                Last_IO_Error:</span> </div><div class="line"><span class="attr">               Last_SQL_Errno:</span> <span class="number">0</span></div><div class="line"><span class="attr">               Last_SQL_Error:</span> </div><div class="line"><span class="attr">  Replicate_Ignore_Server_Ids:</span> </div><div class="line"><span class="attr">             Master_Server_Id:</span> <span class="number">2</span></div><div class="line"><span class="attr">                  Master_UUID:</span> bdb7e690<span class="bullet">-20</span>cb<span class="bullet">-11e6</span>-a8b6<span class="bullet">-000</span>c291242c7</div><div class="line"><span class="attr">             Master_Info_File:</span> /data/mysql_data/master.info</div><div class="line"><span class="attr">                    SQL_Delay:</span> <span class="number">0</span></div><div class="line"><span class="attr">          SQL_Remaining_Delay:</span> <span class="literal">NULL</span></div><div class="line"><span class="attr">      Slave_SQL_Running_State:</span> Slave has read all relay log; waiting for the slave I/O thread to update it</div><div class="line"><span class="attr">           Master_Retry_Count:</span> <span class="number">86400</span></div><div class="line"><span class="attr">                  Master_Bind:</span> </div><div class="line"><span class="attr">      Last_IO_Error_Timestamp:</span> </div><div class="line"><span class="attr">     Last_SQL_Error_Timestamp:</span> </div><div class="line"><span class="attr">               Master_SSL_Crl:</span> </div><div class="line"><span class="attr">           Master_SSL_Crlpath:</span> </div><div class="line"><span class="attr">           Retrieved_Gtid_Set:</span> </div><div class="line"><span class="attr">            Executed_Gtid_Set:</span> </div><div class="line"><span class="attr">                Auto_Position:</span> <span class="number">0</span></div></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      &lt;script src=&quot;/assets/js/DPlayer.min.js&quot;&gt; &lt;/script&gt;&lt;script src=&quot;/assets/js/APlayer.min.js&quot;&gt; &lt;/script&gt;&lt;p&gt;微信看到的文章，原样搬过来，还未试验过，有机会会试验一下。原文：&lt;a hr
    
    </summary>
    
    
      <category term="MySQL高可用之MHA" scheme="https://www.leolan.top/tags/MySQL%E9%AB%98%E5%8F%AF%E7%94%A8%E4%B9%8BMHA/"/>
    
  </entry>
  
  <entry>
    <title>PHP配置</title>
    <link href="https://www.leolan.top/posts/25/"/>
    <id>https://www.leolan.top/posts/25/</id>
    <published>2017-06-05T02:39:25.000Z</published>
    <updated>2017-06-05T02:49:40.000Z</updated>
    
    <content type="html"><![CDATA[<script src="/assets/js/DPlayer.min.js"> </script><script src="/assets/js/APlayer.min.js"> </script><p>一直以来，PHP都是用的默认配置，接触到的业务对网站并没有什么特殊要求，本人比较懒，一般都是用一键环境，都是已经优化好了。很少去改动配置文件，但之后自己搭建平台时就遇到了很多问题，某些插件没有啊，缓存设置不当啊，等等，所以也打算积累一些PHP相关的知识。</p>
<h1 id="几个有用的PHP-ini配置项-路径和目录（网上看到的，还未进行测试）"><a href="#几个有用的PHP-ini配置项-路径和目录（网上看到的，还未进行测试）" class="headerlink" title="几个有用的PHP.ini配置项-路径和目录（网上看到的，还未进行测试）"></a>几个有用的PHP.ini配置项-路径和目录（网上看到的，还未进行测试）</h1><p>路径和目录<br>1、include_path = string<br>作用域：PHP_INI_ALL<br>默认值：NULL<br>此参数指定的路径是include()、require()和fopen_with_path()等函数使用的基本路径。若存在多个目录，用分号分隔。</p>
<p>2、doc_root = string<br>作用域：PHP_INI_SYSTEM<br>默认值：NULL<br>此参数确定提供所有PHP脚本的默认位置。非空时才生效。</p>
<p>3、user_dir = string<br>作用域：PHP_INI_SYSTEM<br>默认值：NULL<br>指定在使用/~usesrname约定打开文件时PHP所使用的绝对目录。例如：当user_dir设置为/home/users时，如果一个用户试图打开文件~/gilmore/book.txt，PHP就会知道绝对路径/home/users/gilmore/book.txt。</p>
<p>4、extension_dir = string<br>作用域：PHP_INI_SYSTEM<br>默认值：./（在windows上，默认为ext）<br>告诉PHP可加载扩展模块的位置。</p>
<p>5、enable_dl = On | Off<br>作用域：PHP_INI_SYSTEM<br>默认值：Off<br>允许用户在运行时加载PHP扩展，即在脚本运行期间加载。</p>
<hr>
]]></content>
    
    <summary type="html">
    
      &lt;script src=&quot;/assets/js/DPlayer.min.js&quot;&gt; &lt;/script&gt;&lt;script src=&quot;/assets/js/APlayer.min.js&quot;&gt; &lt;/script&gt;&lt;p&gt;一直以来，PHP都是用的默认配置，接触到的业务对网站并没有什么特殊要求，本
    
    </summary>
    
    
      <category term="PHP配置" scheme="https://www.leolan.top/tags/PHP%E9%85%8D%E7%BD%AE/"/>
    
  </entry>
  
  <entry>
    <title>firewall防火墙</title>
    <link href="https://www.leolan.top/posts/8419/"/>
    <id>https://www.leolan.top/posts/8419/</id>
    <published>2017-06-05T02:39:12.000Z</published>
    <updated>2017-06-05T02:49:40.002Z</updated>
    
    <content type="html"><![CDATA[<script src="/assets/js/DPlayer.min.js"> </script><script src="/assets/js/APlayer.min.js"> </script><h1 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h1><p>CentOS 7 中，引入了一个新的服务，Firewalld，下面一张图，让大家明确的了解 Firewall 与 iptables 之间的关系与区别。<br><img src="https://image.leolan.top/firewall_stack.png" alt="firewall_stack"></p>
<p>防火墙守护 firewalld 服务引入了一个信任级别的概念来管理与之相关联的连接与接口。它支持 ipv4 与 ipv6，并支持网桥，采用 firewall-cmd (command) 或 firewall-config (gui) 来动态的管理 kernel netfilter 的临时或永久的接口规则，并实时生效而无需重启服务。</p>
<h2 id="zone"><a href="#zone" class="headerlink" title="zone"></a>zone</h2><p>Firewall 能将不同的网络连接归类到不同的信任级别，Zone 提供了以下几个级别</p>
<ul>
<li>drop: 丢弃所有进入的包，而不给出任何响应</li>
<li>block: 拒绝所有外部发起的连接，允许内部发起的连接</li>
<li>public: 允许指定的进入连接</li>
<li>external: 同上，对伪装的进入连接，一般用于路由转发</li>
<li>dmz: 允许受限制的进入连接</li>
<li>work: 允许受信任的计算机被限制的进入连接，类似 workgroup</li>
<li>home: 同上，类似 homegroup</li>
<li>internal: 同上，范围针对所有互联网用户</li>
<li>trusted: 信任所有连接</li>
</ul>
<h2 id="过滤规则"><a href="#过滤规则" class="headerlink" title="过滤规则"></a>过滤规则</h2><ul>
<li>source: 根据源地址过滤</li>
<li>interface: 根据网卡过滤</li>
<li>service: 根据服务名过滤</li>
<li>port: 根据端口过滤</li>
<li>icmp-block: icmp 报文过滤，按照 icmp 类型配置</li>
<li>masquerade: ip 地址伪装</li>
<li>forward-port: 端口转发</li>
<li><p>rule: 自定义规则<br>其中，过滤规则的优先级遵循如下顺序</p>
<ol>
<li>source</li>
<li>interface</li>
<li>firewalld.conf</li>
</ol>
</li>
</ul>
<hr>
<h1 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h1><p>如果是CentOS7的话是默认已经安装了firewall，其他情况可以看看服务状态，没安装的话就安装。</p>
<figure class="highlight cmake"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">yum <span class="keyword">install</span> firewalld</div></pre></td></tr></table></figure>
<p>如果需要图形界面的话，则再安装<br><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">yum <span class="keyword">install </span>firewall-<span class="built_in">config</span></div></pre></td></tr></table></figure></p>
<hr>
<h1 id="使用方法"><a href="#使用方法" class="headerlink" title="使用方法"></a>使用方法</h1><figure class="highlight gauss"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">systemctl start firewalld         <span class="meta"># 启动,</span></div><div class="line">systemctl <span class="keyword">enable</span> firewalld        <span class="meta"># 开机启动</span></div><div class="line">systemctl <span class="keyword">stop</span> firewalld          <span class="meta"># 关闭</span></div><div class="line">systemctl <span class="keyword">disable</span> firewalld       <span class="meta"># 取消开机启动</span></div></pre></td></tr></table></figure>
<p>具体的规则管理，可以使用 firewall-cmd，具体的使用方法可以<br><figure class="highlight haml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">firewall-cmd --help</div><div class="line"></div><div class="line">-<span class="ruby">-zone=NAME                         <span class="comment"># 指定 zone</span></span></div><div class="line">-<span class="ruby">-permanent                         <span class="comment"># 永久修改，--reload 后生效</span></span></div><div class="line">-<span class="ruby">-timeout=seconds                   <span class="comment"># 持续效果，到期后自动移除，用于调试，不能与 --permanent 同时使用</span></span></div></pre></td></tr></table></figure></p>
<hr>
<p><strong>简单用法，开80端口</strong><br><figure class="highlight brainfuck"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="comment">firewall</span><span class="literal">-</span><span class="comment">cmd</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">zone=public</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">add</span><span class="literal">-</span><span class="comment">port=80/tcp</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">permanent</span></div></pre></td></tr></table></figure></p>
<p>出现success表明添加成功<br>命令含义：<br><figure class="highlight haml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">-<span class="ruby">-zone <span class="comment">#作用域</span></span></div><div class="line">-<span class="ruby">-add-port=<span class="number">80</span>/tcp  <span class="comment">#添加端口，格式为：端口/通讯协议</span></span></div><div class="line">-<span class="ruby">-permanent   <span class="comment">#永久生效，没有此参数重启后会失效</span></span></div></pre></td></tr></table></figure></p>
<hr>
<h1 id="查看规则"><a href="#查看规则" class="headerlink" title="查看规则"></a>查看规则</h1><p>查看运行状态<br><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">firewall-<span class="keyword">cmd</span><span class="bash"> --state</span></div></pre></td></tr></table></figure></p>
<p>查看已被激活的 Zone 信息（查看区域信息）<br><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">firewall-<span class="keyword">cmd</span><span class="bash"> --get-active-zones</span></div><div class="line">public</div><div class="line">  interfaces: eth0 eth1</div></pre></td></tr></table></figure></p>
<p>查看指定接口的 Zone 信息（接口所属区域）<br><figure class="highlight cs"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">firewall-cmd --<span class="keyword">get</span>-zone-of-<span class="keyword">interface</span>=eth0</div><div class="line"><span class="keyword">public</span></div></pre></td></tr></table></figure></p>
<p>查看指定级别的接口<br><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">firewall-<span class="keyword">cmd</span><span class="bash"> --zone=public --list-interfaces</span></div><div class="line">eth0</div></pre></td></tr></table></figure></p>
<p>查看指定级别的所有信息，譬如 public<br><figure class="highlight vim"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">firewall-cmd --zone=public --<span class="keyword">list</span>-<span class="keyword">all</span></div><div class="line">public (default, active)</div><div class="line">  interface<span class="variable">s:</span> eth0</div><div class="line">  <span class="keyword">source</span><span class="variable">s:</span></div><div class="line">  service<span class="variable">s:</span> dhcpv6-client http ssh</div><div class="line">  port<span class="variable">s:</span></div><div class="line">  masquerade: <span class="keyword">no</span></div><div class="line">  forward-port<span class="variable">s:</span></div><div class="line">  icmp-block<span class="variable">s:</span></div><div class="line">  rich rule<span class="variable">s:</span></div></pre></td></tr></table></figure></p>
<p>查看所有级别被允许的信息<br><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">firewall-<span class="keyword">cmd</span><span class="bash"> --get-service</span></div></pre></td></tr></table></figure></p>
<p>查看重启后所有 Zones 级别中被允许的服务，即永久放行的服务<br><figure class="highlight brainfuck"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="comment">firewall</span><span class="literal">-</span><span class="comment">cmd</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">get</span><span class="literal">-</span><span class="comment">service</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">permanent</span></div></pre></td></tr></table></figure></p>
<hr>
<h1 id="管理规则"><a href="#管理规则" class="headerlink" title="管理规则"></a>管理规则</h1><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">firewall-<span class="keyword">cmd</span><span class="bash"> --panic-on           <span class="comment"># 丢弃所有包</span></span></div><div class="line">firewall-<span class="keyword">cmd</span><span class="bash"> --panic-off          <span class="comment"># 取消丢弃</span></span></div><div class="line">firewall-<span class="keyword">cmd</span><span class="bash"> --query-panic        <span class="comment"># 查看丢弃状态</span></span></div><div class="line">firewall-<span class="keyword">cmd</span><span class="bash"> --reload             <span class="comment"># 更新规则，不重启服务</span></span></div><div class="line">firewall-<span class="keyword">cmd</span><span class="bash"> --complete-reload    <span class="comment"># 更新规则，重启服务</span></span></div></pre></td></tr></table></figure>
<p>添加某接口至某信任等级，譬如添加 eth0 至 public，永久修改<br><figure class="highlight cs"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">firewall-cmd --zone=<span class="keyword">public</span> --<span class="keyword">add</span>-<span class="keyword">interface</span>=eth0 --permanent</div></pre></td></tr></table></figure></p>
<p>设置 public 为默认的信任级别<br><figure class="highlight actionscript"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">firewall-cmd --<span class="keyword">set</span>-<span class="keyword">default</span>-zone=<span class="keyword">public</span></div></pre></td></tr></table></figure></p>
<h2 id="管理端口"><a href="#管理端口" class="headerlink" title="管理端口"></a>管理端口</h2><p>列出 dmz 级别的被允许的进入端口<br><figure class="highlight brainfuck"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="comment">firewall</span><span class="literal">-</span><span class="comment">cmd</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">zone=dmz</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">list</span><span class="literal">-</span><span class="comment">ports</span></div></pre></td></tr></table></figure></p>
<p>允许 tcp 端口 8080 至 dmz 级别<br><figure class="highlight brainfuck"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="comment">firewall</span><span class="literal">-</span><span class="comment">cmd</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">zone=dmz</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">add</span><span class="literal">-</span><span class="comment">port=8080/tcp</span></div></pre></td></tr></table></figure></p>
<p>允许某范围的 udp 端口至 public 级别，并永久生效<br><figure class="highlight brainfuck"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="comment">firewall</span><span class="literal">-</span><span class="comment">cmd</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">zone=public</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">add</span><span class="literal">-</span><span class="comment">port=5060</span><span class="literal">-</span><span class="comment">5059/udp</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">permanent</span></div></pre></td></tr></table></figure></p>
<h2 id="网卡接口"><a href="#网卡接口" class="headerlink" title="网卡接口"></a>网卡接口</h2><p>列出 public zone 所有网卡<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">firewall-cmd --zone=<span class="keyword">public</span> --<span class="built_in">list</span>-interfaces</div></pre></td></tr></table></figure></p>
<p>将 eth0 添加至 public zone，永久<br><figure class="highlight cs"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">firewall-cmd --zone=<span class="keyword">public</span> --permanent --<span class="keyword">add</span>-<span class="keyword">interface</span>=eth0</div></pre></td></tr></table></figure></p>
<p>eth0 存在与 public zone，将该网卡添加至 work zone，并将之从 public zone 中删除<br><figure class="highlight brainfuck"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="comment">firewall</span><span class="literal">-</span><span class="comment">cmd</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">zone=work</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">permanent</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">change</span><span class="literal">-</span><span class="comment">interface=eth0</span></div></pre></td></tr></table></figure></p>
<p>删除 public zone 中的 eth0，永久<br><figure class="highlight cs"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">firewall-cmd --zone=<span class="keyword">public</span> --permanent --<span class="keyword">remove</span>-<span class="keyword">interface</span>=eth0</div></pre></td></tr></table></figure></p>
<h2 id="管理服务"><a href="#管理服务" class="headerlink" title="管理服务"></a>管理服务</h2><p>添加 smtp 服务至 work zone<br><figure class="highlight brainfuck"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="comment">firewall</span><span class="literal">-</span><span class="comment">cmd</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">zone=work</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">add</span><span class="literal">-</span><span class="comment">service=smtp</span></div></pre></td></tr></table></figure></p>
<p>移除 work zone 中的 smtp 服务<br><figure class="highlight brainfuck"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="comment">firewall</span><span class="literal">-</span><span class="comment">cmd</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">zone=work</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">remove</span><span class="literal">-</span><span class="comment">service=smtp</span></div></pre></td></tr></table></figure></p>
<h2 id="配置-external-zone-中的-ip-地址伪装"><a href="#配置-external-zone-中的-ip-地址伪装" class="headerlink" title="配置 external zone 中的 ip 地址伪装"></a>配置 external zone 中的 ip 地址伪装</h2><p>查看<br><figure class="highlight brainfuck"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="comment">firewall</span><span class="literal">-</span><span class="comment">cmd</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">zone=external</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">query</span><span class="literal">-</span><span class="comment">masquerade</span></div></pre></td></tr></table></figure></p>
<p>打开伪装<br><figure class="highlight brainfuck"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="comment">firewall</span><span class="literal">-</span><span class="comment">cmd</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">zone=external</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">add</span><span class="literal">-</span><span class="comment">masquerade</span></div></pre></td></tr></table></figure></p>
<p>关闭伪装<br><figure class="highlight brainfuck"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="comment">firewall</span><span class="literal">-</span><span class="comment">cmd</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">zone=external</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">remove</span><span class="literal">-</span><span class="comment">masquerade</span></div></pre></td></tr></table></figure></p>
<h2 id="配置-public-zone-的端口转发"><a href="#配置-public-zone-的端口转发" class="headerlink" title="配置 public zone 的端口转发"></a>配置 public zone 的端口转发</h2><p>要打开端口转发，则需要先<br><figure class="highlight brainfuck"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="comment">firewall</span><span class="literal">-</span><span class="comment">cmd</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">zone=public</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">add</span><span class="literal">-</span><span class="comment">masquerade</span></div></pre></td></tr></table></figure></p>
<p>然后转发 tcp 22 端口至 3753<br><figure class="highlight elixir"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">firewall-cmd --zone=public --add-forward-port=port=<span class="number">22</span><span class="symbol">:proto=tcp</span><span class="symbol">:toport=</span><span class="number">3753</span></div></pre></td></tr></table></figure></p>
<p>转发 22 端口数据至另一个 ip 的相同端口上<br><figure class="highlight x86asm"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">firewall-cmd --zone=<span class="meta">public</span> --<span class="keyword">add</span>-forward-port=port=<span class="number">22</span>:proto=tcp:toaddr=<span class="number">192.168</span><span class="meta">.1</span><span class="meta">.100</span></div></pre></td></tr></table></figure></p>
<p>转发 22 端口数据至另一 ip 的 2055 端口上<br><figure class="highlight elixir"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">firewall-cmd --zone=public --add-forward-port=port=<span class="number">22</span><span class="symbol">:proto=tcp</span><span class="symbol">:toport=</span><span class="number">2055</span><span class="symbol">:toaddr=</span><span class="number">192.168</span>.<span class="number">1.100</span></div></pre></td></tr></table></figure></p>
<h2 id="配置-public-zone-的-icmp"><a href="#配置-public-zone-的-icmp" class="headerlink" title="配置 public zone 的 icmp"></a>配置 public zone 的 icmp</h2><p>查看所有支持的 icmp 类型<br><figure class="highlight dos"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">firewall-<span class="built_in">cmd</span> --get-icmptypes</div><div class="line">destination-unreachable <span class="built_in">echo</span>-reply <span class="built_in">echo</span>-request parameter-problem redirect router-advertisement router-solicitation source-quench <span class="built_in">time</span>-exceeded</div></pre></td></tr></table></figure></p>
<p>列出<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">firewall-cmd --zone=<span class="keyword">public</span> --<span class="built_in">list</span>-icmp-blocks</div></pre></td></tr></table></figure></p>
<p>添加 echo-request 屏蔽<br><figure class="highlight brainfuck"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="comment">firewall</span><span class="literal">-</span><span class="comment">cmd</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">zone=public</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">add</span><span class="literal">-</span><span class="comment">icmp</span><span class="literal">-</span><span class="comment">block=echo</span><span class="literal">-</span><span class="comment">request</span> <span class="title">[</span><span class="literal">-</span><span class="literal">-</span><span class="comment">timeout=seconds</span><span class="title">]</span></div></pre></td></tr></table></figure></p>
<p>移除 echo-reply 屏蔽<br><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">firewall-<span class="keyword">cmd</span><span class="bash"> --zone=public --remove-icmp-block=<span class="built_in">echo</span>-reply</span></div></pre></td></tr></table></figure></p>
<h2 id="IP-封禁"><a href="#IP-封禁" class="headerlink" title="IP 封禁"></a>IP 封禁</h2><figure class="highlight dsconfig"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="string">firewall-cmd </span><span class="built_in">--permanent</span> <span class="built_in">--add-rich-rule="rule</span> <span class="string">family=</span><span class="string">'ipv4'</span> <span class="string">source </span><span class="string">address=</span><span class="string">'222.222.222.222'</span> <span class="string">reject"</span></div></pre></td></tr></table></figure>
<p>当然，我们仍然可以通过 ipset 来封禁 ip</p>
<p>封禁 ip<br><figure class="highlight brainfuck"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment">firewall</span><span class="literal">-</span><span class="comment">cmd</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">permanent</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">zone=public</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">new</span><span class="literal">-</span><span class="comment">ipset=blacklist</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">type=hash:ip</span></div><div class="line"><span class="comment">firewall</span><span class="literal">-</span><span class="comment">cmd</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">permanent</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">zone=public</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">ipset=blacklist</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">add</span><span class="literal">-</span><span class="comment">entry=222</span><span class="string">.</span><span class="comment">222</span><span class="string">.</span><span class="comment">222</span><span class="string">.</span><span class="comment">222</span></div></pre></td></tr></table></figure></p>
<p>封禁网段<br><figure class="highlight brainfuck"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment">firewall</span><span class="literal">-</span><span class="comment">cmd</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">permanent</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">zone=public</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">new</span><span class="literal">-</span><span class="comment">ipset=blacklist</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">type=hash:net</span></div><div class="line"><span class="comment">firewall</span><span class="literal">-</span><span class="comment">cmd</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">permanent</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">zone=public</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">ipset=blacklist</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">add</span><span class="literal">-</span><span class="comment">entry=222</span><span class="string">.</span><span class="comment">222</span><span class="string">.</span><span class="comment">222</span><span class="string">.</span><span class="comment">0/24</span></div></pre></td></tr></table></figure></p>
<p>倒入 ipset 规则<br><figure class="highlight gradle"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">firewall-cmd --permanent --zone=<span class="keyword">public</span> --<span class="keyword">new</span>-ipset-<span class="keyword">from</span>-<span class="keyword">file</span>=<span class="regexp">/path/</span>blacklist.xml</div></pre></td></tr></table></figure></p>
<p>然后封禁 blacklist<br><figure class="highlight brainfuck"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="comment">firewall</span><span class="literal">-</span><span class="comment">cmd</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">permanent</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">zone=public</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">add</span><span class="literal">-</span><span class="comment">rich</span><span class="literal">-</span><span class="comment">rule='rule</span> <span class="comment">source</span> <span class="comment">ipset=blacklist</span> <span class="comment">drop'</span></div></pre></td></tr></table></figure></p>
<p>重新载入以生效<br><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">firewall-<span class="keyword">cmd</span><span class="bash"> --reload</span></div></pre></td></tr></table></figure></p>
<p>以上都是一些常用方法，更多高级方法，请参考：</p>
<p><a href="https://access.redhat.com/documentation/en-US/Red_Hat_Enterprise_Linux/7/html/Security_Guide/sec-Using_Firewalls.html" target="_blank" rel="external">https://access.redhat.com/documentation/en-US/Red_Hat_Enterprise_Linux/7/html/Security_Guide/sec-Using_Firewalls.html</a><br><a href="https://fedoraproject.org/wiki/FirewallD" target="_blank" rel="external">https://fedoraproject.org/wiki/FirewallD</a></p>
]]></content>
    
    <summary type="html">
    
      &lt;script src=&quot;/assets/js/DPlayer.min.js&quot;&gt; &lt;/script&gt;&lt;script src=&quot;/assets/js/APlayer.min.js&quot;&gt; &lt;/script&gt;&lt;h1 id=&quot;简介&quot;&gt;&lt;a href=&quot;#简介&quot; class=&quot;headerl
    
    </summary>
    
    
      <category term="firewall防火墙" scheme="https://www.leolan.top/tags/firewall%E9%98%B2%E7%81%AB%E5%A2%99/"/>
    
  </entry>
  
  <entry>
    <title>JIRA</title>
    <link href="https://www.leolan.top/posts/40506/"/>
    <id>https://www.leolan.top/posts/40506/</id>
    <published>2017-06-05T02:38:52.000Z</published>
    <updated>2017-06-05T02:49:39.997Z</updated>
    
    <content type="html"><![CDATA[<script src="/assets/js/DPlayer.min.js"> </script><script src="/assets/js/APlayer.min.js"> </script><h1 id="JIRA-SoftWare"><a href="#JIRA-SoftWare" class="headerlink" title="JIRA SoftWare"></a>JIRA SoftWare</h1><p>JIRA SoftWare是一款很强大的项目管理软件。收费的，很贵。关于JIRA 的安装、迁移、管理</p>
<p><a href="http://wiki.52wcm.com/pages/viewpage.action?pageId=2261388" target="_blank" rel="external">http://wiki.52wcm.com/pages/viewpage.action?pageId=2261388</a><br>使用MySQL数据库需要这个组件mysql-connect.jar:<a href="https://dev.mysql.com/downloads/connector/j/" target="_blank" rel="external">https://dev.mysql.com/downloads/connector/j/</a></p>
<hr>
<h1 id="Atlassian-Confluence"><a href="#Atlassian-Confluence" class="headerlink" title="Atlassian Confluence"></a>Atlassian Confluence</h1><p>Atlassian Confluence是一个知识管理平台（WiKi）</p>
]]></content>
    
    <summary type="html">
    
      &lt;script src=&quot;/assets/js/DPlayer.min.js&quot;&gt; &lt;/script&gt;&lt;script src=&quot;/assets/js/APlayer.min.js&quot;&gt; &lt;/script&gt;&lt;h1 id=&quot;JIRA-SoftWare&quot;&gt;&lt;a href=&quot;#JIRA-So
    
    </summary>
    
    
      <category term="JIRA" scheme="https://www.leolan.top/tags/JIRA/"/>
    
  </entry>
  
  <entry>
    <title>负载均衡原理与实现</title>
    <link href="https://www.leolan.top/posts/6464/"/>
    <id>https://www.leolan.top/posts/6464/</id>
    <published>2017-06-05T02:38:38.000Z</published>
    <updated>2017-06-05T02:49:40.006Z</updated>
    
    <content type="html"><![CDATA[<script src="/assets/js/DPlayer.min.js"> </script><script src="/assets/js/APlayer.min.js"> </script><p>看了一些博文，有了大概的了解，稍微做做笔记。</p>
<h1 id="Web负载均衡原理与实现"><a href="#Web负载均衡原理与实现" class="headerlink" title="Web负载均衡原理与实现"></a>Web负载均衡原理与实现</h1><p>所谓的“均衡”不能狭义地理解为分配给所有实际服务器一样多的工作量，因为多台服务器的承载能力各不相同，这可能体现在硬件配置、网络带宽的差异，也可能因为某台服务器身兼多职，我们所说的“均衡”，也就是希望所有服务器都不要过载，并且能够最大程序地发挥作用。</p>
<h2 id="http重定向"><a href="#http重定向" class="headerlink" title="http重定向"></a>http重定向</h2><p>当http代理（比如浏览器）向web服务器请求某个URL后，web服务器可以通过http响应头信息中的Location标记来返回一个新的URL。这意味着HTTP代理需要继续请求这个新的URL，完成自动跳转。</p>
<p>性能缺陷：<br>1、吞吐率限制<br>主站点服务器的吞吐率平均分配到了被转移的服务器。现假设使用RR（Round Robin）调度策略，子服务器的最大吞吐率为1000reqs/s，那么主服务器的吞吐率要达到3000reqs/s才能完全发挥三台子服务器的作用，那么如果有100台子服务器，那么主服务器的吞吐率可想而知得有大？相反，如果主服务的最大吞吐率为6000reqs/s，那么平均分配到子服务器的吞吐率为2000reqs/s，而现子服务器的最大吞吐率为1000reqs/s，因此就得增加子服务器的数量，增加到6个才能满足。</p>
<p>2、重定向访问深度不同<br>有的重定向一个静态页面，有的重定向相比复杂的动态页面，那么实际服务器的负载差异是不可预料的，而主站服务器却一无所知。因此整站使用重定向方法做负载均衡不太好。</p>
<p>我们需要权衡转移请求的开销和处理实际请求的开销，前者相对于后者越小，那么重定向的意义就越大，例如下载。你可以去很多镜像下载网站试下，会发现基本下载都使用了Location做了重定向。</p>
<hr>
<h2 id="DNS负载均衡"><a href="#DNS负载均衡" class="headerlink" title="DNS负载均衡"></a>DNS负载均衡</h2><p>DNS负责提供域名解析服务，当访问某个站点时，实际上首先需要通过该站点域名的DNS服务器来获取域名指向的IP地址，在这一过程中，DNS服务器完成了域名到IP地址的映射，同样，这样映射也可以是一对多的，这时候，DNS服务器便充当了负载均衡调度器，它就像http重定向转换策略一样，将用户的请求分散到多台服务器上，但是它的实现机制完全不同。</p>
<p>使用dig命令来看下”baidu”的DNS设置<br><img src="https://image.leolan.top/%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A11.jpg" alt=""><br>可见baidu拥有四个A记录</p>
<p>相比http重定向，基于DNS的负载均衡完全节省了所谓的主站点，或者说DNS服务器已经充当了主站点的职能。但不同的是，作为调度器，DNS服务器本身的性能几乎不用担心。因为DNS记录可以被用户浏览器或者互联网接入服务商的各级DNS服务器缓存，只有当缓存过期后才会重新向域名的DNS服务器请求解析。也说是DNS不存在http的吞吐率限制，理论上可以无限增加实际服务器的数量。</p>
<p>特性:<br>1、可以根据用户IP来进行智能解析。DNS服务器可以在所有可用的A记录中寻找离用记最近的一台服务器。<br>2、动态DNS：在每次IP地址变更时，及时更新DNS服务器。当然，因为缓存，一定的延迟不可避免。</p>
<p>不足：</p>
<ul>
<li>1、没有用户能直接看到DNS解析到了哪一台实际服务器，加服务器运维人员的调试带来了不便。</li>
<li>2、策略的局限性。例如你无法将HTTP请求的上下文引入到调度策略中，而在前面介绍的基于HTTP重定向的负载均衡系统中，调度器工作在HTTP层面，它可以充分理解HTTP请求后根据站点的应用逻辑来设计调度策略，比如根据请求不同的URL来进行合理的过滤和转移。</li>
<li>3、如果要根据实际服务器的实时负载差异来调整调度策略，这需要DNS服务器在每次解析操作时分析各服务器的健康状态，对于DNS服务器来说，这种自定义开发存在较高的门槛，更何况大多数站点只是使用第三方DNS服务。</li>
<li>4、DNS记录缓存，各级节点的DNS服务器不同程序的缓存会让你晕头转向。</li>
<li>5、基于以上几点，DNS服务器并不能很好地完成工作量均衡分配，最后，是否选择基于DNS的负载均衡方式完全取决于你的需要。</li>
</ul>
<hr>
<h2 id="反向代理负载均衡"><a href="#反向代理负载均衡" class="headerlink" title="反向代理负载均衡"></a>反向代理负载均衡</h2><p>这个肯定大家都有所接触，因为几乎所有主流的Web服务器都热衷于支持基于反向代理的负载均衡。它的核心工作就是转发HTTP请求。</p>
<p>相比前面的HTTP重定向和DNS解析，反向代理的调度器扮演的是用户和实际服务器中间人的角色：<br>1、任何对于实际服务器的HTTP请求都必须经过调度器</p>
<p>2、调度器必须等待实际服务器的HTTP响应，并将它反馈给用户（前两种方式不需要经过调度反馈，是实际服务器直接发送给用户）</p>
<p>特性：</p>
<ul>
<li>1、调度策略丰富。例如可以为不同的实际服务器设置不同的权重，以达到能者多劳的效果。</li>
<li>2、对反向代理服务器的并发处理能力要求高，因为它工作在HTTP层面。</li>
<li>3、反向代理服务器进行转发操作本身是需要一定开销的，比如创建线程、与后端服务器建立TCP连接、接收后端服务器返回的处理结果、分析HTTP头部信息、用户空间和内核空间的频繁切换等，虽然这部分时间并不长，但是当后端服务器处理请求的时间非常短时，转发的开销就显得尤为突出。例如请求静态文件，更适合使用前面介绍的基于DNS的负载均衡方式。</li>
<li>4、反向代理服务器可以监控后端服务器，比如系统负载、响应时间、是否可用、TCP连接数、流量等，从而根据这些数据调整负载均衡的策略。</li>
<li>5、反射代理服务器可以让用户在一次会话周期内的所有请求始终转发到一台特定的后端服务器上（粘滞会话），这样的好处一是保持session的本地访问，二是防止后端服务器的动态内存缓存的资源浪费。</li>
</ul>
<hr>
<h2 id="IP负载均衡-LVS-NAT"><a href="#IP负载均衡-LVS-NAT" class="headerlink" title="IP负载均衡(LVS-NAT)"></a>IP负载均衡(LVS-NAT)</h2><p>因为反向代理服务器工作在HTTP层，其本身的开销就已经严重制约了可扩展性，从而也限制了它的性能极限。那能否在HTTP层面以下实现负载均衡呢？</p>
<p>NAT服务器:它工作在传输层，它可以修改发送来的IP数据包，将数据包的目标地址修改为实际服务器地址。</p>
<p>从Linux2.4内核开始，其内置的Neftilter模块在内核中维护着一些数据包过滤表，这些表包含了用于控制数据包过滤的规则。可喜的是，Linux提供了iptables来对过滤表进行插入、修改和删除等操作。更加令人振奋的是，Linux2.6.x内核中内置了IPVS模块，它的工作性质类型于Netfilter模块，不过它更专注于实现IP负载均衡。</p>
<p>想知道你的服务器内核是否已经安装了IPVS模块，可以<br><img src="https://image.leolan.top/20141121164600671.jpg" alt=""><br>有输出意味着IPVS已经安装了。IPVS的管理工具是ipvsadm，它为提供了基于命令行的配置界面，可以通过它快速实现负载均衡系统。这就是大名鼎鼎的LVS(Linux Virtual Server，Linux虚拟服务器)。</p>
<p>1、打开调度器的数据包转发选项<br><figure class="highlight awk"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">echo <span class="number">1</span> &gt; <span class="regexp">/proc/</span>sys<span class="regexp">/net/i</span>pv4<span class="regexp">/ip_forward</span></div></pre></td></tr></table></figure></p>
<p>2、检查实际服务器是否已经将NAT服务器作为自己的默认网关，如果不是，如添加<br><figure class="highlight stylus"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">route add default gw xx<span class="selector-class">.xx</span><span class="selector-class">.xx</span><span class="selector-class">.xx</span></div></pre></td></tr></table></figure></p>
<p>3、使用ipvsadm配置<br><figure class="highlight css"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="selector-tag">ipvsadm</span> <span class="selector-tag">-A</span> <span class="selector-tag">-t</span> 111<span class="selector-class">.11</span><span class="selector-class">.11</span><span class="selector-class">.11</span><span class="selector-pseudo">:80</span> <span class="selector-tag">-s</span> <span class="selector-tag">rr</span></div></pre></td></tr></table></figure></p>
<p>添加一台虚拟服务器，-t 后面是服务器的外网ip和端口，-s rr是指采用简单轮询的RR调度策略（这属于静态调度策略，除此之外，LVS还提供了系列的动态调度策略，比如最小连接（LC）、带权重的最小连接（WLC），最短期望时间延迟（SED）等）<br><figure class="highlight css"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="selector-tag">ipvsadm</span> <span class="selector-tag">-a</span> <span class="selector-tag">-t</span> 111<span class="selector-class">.11</span><span class="selector-class">.11</span><span class="selector-class">.11</span><span class="selector-pseudo">:80</span> <span class="selector-tag">-r</span> 10<span class="selector-class">.10</span><span class="selector-class">.120</span><span class="selector-class">.210</span><span class="selector-pseudo">:8000</span> <span class="selector-tag">-m</span>  </div><div class="line"></div><div class="line"><span class="selector-tag">ipvsadm</span> <span class="selector-tag">-a</span> <span class="selector-tag">-t</span> 111<span class="selector-class">.11</span><span class="selector-class">.11</span><span class="selector-class">.11</span><span class="selector-pseudo">:80</span> <span class="selector-tag">-r</span> 10<span class="selector-class">.10</span><span class="selector-class">.120</span><span class="selector-class">.211</span><span class="selector-pseudo">:8000</span> <span class="selector-tag">-m</span></div></pre></td></tr></table></figure></p>
<p>添加两台实际服务器（不需要有外网ip），-r后面是实际服务器的内网ip和端口，-m表示采用NAT方式来转发数据包</p>
<p>运行<code>ipvsadm -L -n</code>可以查看实际服务器的状态。这样就大功告成了。</p>
<p>实验证明使用基于NAT的负载均衡系统。作为调度器的NAT服务器可以将吞吐率提升到一个新的高度，几乎是反向代理服务器的两倍以上，这大多归功于在内核中进行请求转发的较低开销。但是一旦请求的内容过大时，不论是基于反向代理还是NAT，负载均衡的整体吞吐量都差距不大，这说明对于一睦开销较大的内容，使用简单的反向代理来搭建负载均衡系统是值考虑的。</p>
<p>这么强大的系统还是有它的瓶颈，那就是NAT服务器的网络带宽，包括内部网络和外部网络。当然如果你不差钱，可以去花钱去购买千兆交换机或万兆交换机，甚至负载均衡硬件设备，但如果你是个屌丝，咋办？</p>
<p>一个简单有效的办法就是将基于NAT的集群和前面的DNS混合使用，比如５个100Mbps出口宽带的集群，然后通过DNS来将用户请求均衡地指向这些集群，同时，你还可以利用DNS智能解析实现地域就近访问。这样的配置对于大多数业务是足够了，但是对于提供下载或视频等服务的大规模站点，NAT服务器还是不够出色。</p>
<hr>
<h2 id="直接路由-LVS-DR"><a href="#直接路由-LVS-DR" class="headerlink" title="直接路由(LVS-DR)"></a>直接路由(LVS-DR)</h2><p>NAT是工作在网络分层模型的传输层（第四层），而直接路由是工作在数据链路层（第二层），貌似更屌些。它通过修改数据包的目标MAC地址（没有修改目标IP），将数据包转发到实际服务器上，不同的是，实际服务器的响应数据包将直接发送给客户羰，而不经过调度器。</p>
<p>1、网络设置</p>
<p>这里假设一台负载均衡调度器，两台实际服务器，购买三个外网ip，一台机一个，三台机的默认网关需要相同，最后再设置同样的ip别名，这里假设别名为10.10.120.193。这样一来，将通过10.10.120.193这个IP别名来访问调度器，你可以将站点的域名指向这个IP别名。</p>
<p>2、将ip别名添加到回环接口lo上</p>
<p>这是为了让实际服务器不要去寻找其他拥有这个IP别名的服务器，在实际服务器中运行：<br><img src="https://image.leolan.top/20141121180709578.jpg" alt=""><br>另外还要防止实际服务器响应来自网络中针对IP别名的ARP广播，为此还要执行：<br><figure class="highlight dts"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">echo <span class="string">"1"</span> &gt; <span class="meta-keyword">/proc/</span>sys<span class="meta-keyword">/net/</span>ipv4<span class="meta-keyword">/conf/</span>lo/arp_ignore</div><div class="line"></div><div class="line">echo <span class="string">"2"</span> &gt; <span class="meta-keyword">/proc/</span>sys<span class="meta-keyword">/net/</span>ipv4<span class="meta-keyword">/conf/</span>lo/arp_announce</div><div class="line"></div><div class="line">echo <span class="string">"1"</span> &gt; <span class="meta-keyword">/proc/</span>sys<span class="meta-keyword">/net/</span>ipv4<span class="meta-keyword">/conf/</span>all/arp_ignore</div><div class="line"></div><div class="line">echo <span class="string">"1"</span> &gt; <span class="meta-keyword">/proc/</span>sys<span class="meta-keyword">/net/</span>ipv4<span class="meta-keyword">/conf/</span>all/arp_announce</div></pre></td></tr></table></figure></p>
<p>配置完了就可以使用ipvsadm配置LVS-DR集群了<br><figure class="highlight css"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="selector-tag">ipvsadm</span> <span class="selector-tag">-A</span> <span class="selector-tag">-t</span> 10<span class="selector-class">.10</span><span class="selector-class">.120</span><span class="selector-class">.193</span><span class="selector-pseudo">:80</span> <span class="selector-tag">-s</span> <span class="selector-tag">rr</span>  </div><div class="line"></div><div class="line"><span class="selector-tag">ipvsadm</span> <span class="selector-tag">-a</span> <span class="selector-tag">-t</span> 10<span class="selector-class">.10</span><span class="selector-class">.120</span><span class="selector-class">.193</span><span class="selector-pseudo">:80</span> <span class="selector-tag">-r</span> 10<span class="selector-class">.10</span><span class="selector-class">.120</span><span class="selector-class">.210</span><span class="selector-pseudo">:8000</span> <span class="selector-tag">-g</span>  </div><div class="line"></div><div class="line"><span class="selector-tag">ipvsadm</span> <span class="selector-tag">-a</span> <span class="selector-tag">-t</span> 10<span class="selector-class">.10</span><span class="selector-class">.120</span><span class="selector-class">.193</span><span class="selector-pseudo">:80</span> <span class="selector-tag">-r</span> 10<span class="selector-class">.10</span><span class="selector-class">.120</span><span class="selector-class">.211</span><span class="selector-pseudo">:8000</span> <span class="selector-tag">-g</span></div></pre></td></tr></table></figure></p>
<p><strong>-g</strong>就意味着使用直接路由的方式转发数据包</p>
<p>LVS-DR 相较于LVS-NAT的最大优势在于LVS-DR不受调度器宽带的限制，例如假设三台服务器在WAN交换机出口宽带都限制为10Mbps，只要对于连接调度器和两台实际服务器的LAN交换机没有限速，那么，使用LVS-DR理论上可以达到20Mbps的最大出口宽带，因为它的实际服务器的响应数据包可以不经过调度器而直接发往用户端啊，所以它与调度器的出口宽带没有关系，只能自身的有关系。而如果使用LVS-NAT，集群只能最大使用10Mbps的宽带。所以，越是响应数据包远远超过请求数据包的服务，就越应该降低调度器转移请求的开销，也就越能提高整体的扩展能力，最终也就越依赖于WAN出口宽带。</p>
<p>总的来说，LVS-DR适合搭建可扩展的负载均衡系统，不论是Web服务器还是文件服务器，以及视频服务器，它都拥有出色的性能。前提是你必须为实际器购买一系列的合法IP地址。</p>
<hr>
<h2 id="IP隧道-LVS-TUN"><a href="#IP隧道-LVS-TUN" class="headerlink" title="IP隧道(LVS-TUN)"></a>IP隧道(LVS-TUN)</h2><p>基于IP隧道的请求转发机制：将调度器收到的IP数据包封装在一个新的IP数据包中，转交给实际服务器，然后实际服务器的响应数据包可以直接到达用户端。目前Linux大多支持，可以用LVS来实现，称为LVS-TUN，与LVS-DR不同的是，实际服务器可以和调度器不在同一个WANt网段，调度器通过IP隧道技术来转发请求到实际服务器，所以实际服务器也必须拥有合法的IP地址。</p>
<p>总体来说，LVS-DR和LVS-TUN都适合响应和请求不对称的Web服务器，如何从它们中做出选择，取决于你的网络部署需要，因为LVS-TUN可以将实际服务器根据需要部署在不同的地域，并且根据就近访问的原则来转移请求，所以有类似这种需求的，就应该选择LVS-TUN。</p>
<p>参考：<a href="http://blog.csdn.net/asqi1/article/details/41478111" target="_blank" rel="external">http://blog.csdn.net/asqi1/article/details/41478111</a></p>
<hr>
<hr>
<h1 id="基于服务器的负载均衡"><a href="#基于服务器的负载均衡" class="headerlink" title="基于服务器的负载均衡"></a>基于服务器的负载均衡</h1><p>拿LVS 3种负载均衡简单梳理一下</p>
<h2 id="3种LVS模式："><a href="#3种LVS模式：" class="headerlink" title="3种LVS模式："></a>3种LVS模式：</h2><ul>
<li>LVS-NAT（地址转换技术），硬件负载均衡F5大致原理。</li>
<li>LVS-IP-TUN（ip隧道技术）</li>
<li>LVS-DR（直接路由）</li>
</ul>
<h2 id="几种负载均衡算法："><a href="#几种负载均衡算法：" class="headerlink" title="几种负载均衡算法："></a>几种负载均衡算法：</h2><ul>
<li>RR（round robin）轮询</li>
<li>WRR（weighted Round Robin）加权轮询</li>
<li>LC（Least Connections）最少连接</li>
<li>WLC（Weighted Least Connections）加权最少连接</li>
<li>DH（Destination Hashing）目的地址hash</li>
<li>SH（Source Hashing）源地址hash</li>
</ul>
<hr>
<p>1，LVS-NAT<br><img src="https://image.leolan.top/150931663lvs1.png" alt=""><br> 通过网络地址转换调度器重写请求报文的目的地址，根据预设的调度算法，将请求分配给后端的真实服务器；真实服务器的响应报文通过调度器时，报文的源地址被重写,再返回给用户，完成整个调度过程。<br>优点：节省ip地址，能对内部就行伪装<br>缺点：效率低，因为大量的返回用户的数据流量都要经过调度器。</p>
<hr>
<p>2，LVS-IP-TUN<br><img src="https://image.leolan.top/150442245lvs2.png" alt=""><br>为了解决调度器的处理能力瓶颈，调度器可以把请求报文通过ip隧道转发至真实服务器，再由真实服务器直接将响应数据返回给用户，这样调度服务器只需要处理用户的请求报文。前提是，调度机lvs和真实服务器都必须支持ip-tun技术。</p>
<hr>
<p>3，LVS-DR<br><img src="https://image.leolan.top/150215849lvs3.png" alt=""><br>通过改写请求报文的mac地址，将请求发送到真实服务器，再由真实服务器将响应直接返回给用户。前提是lvs调度机器和提供服务的真实服务器在同一个网段，当调度机器lvs收到请求报文时直接发送到真实服务器节点。相对于ip-tun来说，没有ip隧道的开销。</p>
<p>参考：<br><a href="http://dsxwjhf.iteye.com/blog/2219060" target="_blank" rel="external">http://dsxwjhf.iteye.com/blog/2219060</a><br><a href="http://monkeyzhu.blog.51cto.com/5764358/1329102" target="_blank" rel="external">http://monkeyzhu.blog.51cto.com/5764358/1329102</a><br><a href="http://virtualadc.blog.51cto.com/3027116/615836" target="_blank" rel="external">http://virtualadc.blog.51cto.com/3027116/615836</a></p>
<hr>
]]></content>
    
    <summary type="html">
    
      &lt;script src=&quot;/assets/js/DPlayer.min.js&quot;&gt; &lt;/script&gt;&lt;script src=&quot;/assets/js/APlayer.min.js&quot;&gt; &lt;/script&gt;&lt;p&gt;看了一些博文，有了大概的了解，稍微做做笔记。&lt;/p&gt;
&lt;h1 id=&quot;We
    
    </summary>
    
    
      <category term="负载均衡原理与实现" scheme="https://www.leolan.top/tags/%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E5%8E%9F%E7%90%86%E4%B8%8E%E5%AE%9E%E7%8E%B0/"/>
    
  </entry>
  
  <entry>
    <title>策略路由</title>
    <link href="https://www.leolan.top/posts/61863/"/>
    <id>https://www.leolan.top/posts/61863/</id>
    <published>2017-06-05T02:38:17.000Z</published>
    <updated>2017-06-05T02:49:40.007Z</updated>
    
    <content type="html"><![CDATA[<script src="/assets/js/DPlayer.min.js"> </script><script src="/assets/js/APlayer.min.js"> </script><h1 id="梅林固件"><a href="#梅林固件" class="headerlink" title="梅林固件"></a>梅林固件</h1><p>梅林固件中的策略路由、科学上网<br>参考：<br><a href="http://koolshare.cn/forum.php?mod=viewthread&amp;tid=46687&amp;highlight=%E7%AD%96%E7%95%A5%E8%B7%AF%E7%94%B1" target="_blank" rel="external">http://koolshare.cn/forum.php?mod=viewthread&amp;tid=46687&amp;highlight=%E7%AD%96%E7%95%A5%E8%B7%AF%E7%94%B1</a><br><a href="http://koolshare.cn/forum.php?mod=viewthread&amp;tid=6388&amp;highlight=%E7%AD%96%E7%95%A5%E8%B7%AF%E7%94%B1" target="_blank" rel="external">http://koolshare.cn/forum.php?mod=viewthread&amp;tid=6388&amp;highlight=%E7%AD%96%E7%95%A5%E8%B7%AF%E7%94%B1</a></p>
<p><a href="http://koolshare.cn/forum.php?mod=viewthread&amp;tid=66514&amp;highlight=%E7%AD%96%E7%95%A5%E8%B7%AF%E7%94%B1" target="_blank" rel="external">http://koolshare.cn/forum.php?mod=viewthread&amp;tid=66514&amp;highlight=%E7%AD%96%E7%95%A5%E8%B7%AF%E7%94%B1</a><br><a href="http://koolshare.cn/thread-4631-1-1.html" target="_blank" rel="external">http://koolshare.cn/thread-4631-1-1.html</a></p>
]]></content>
    
    <summary type="html">
    
      &lt;script src=&quot;/assets/js/DPlayer.min.js&quot;&gt; &lt;/script&gt;&lt;script src=&quot;/assets/js/APlayer.min.js&quot;&gt; &lt;/script&gt;&lt;h1 id=&quot;梅林固件&quot;&gt;&lt;a href=&quot;#梅林固件&quot; class=&quot;hea
    
    </summary>
    
    
      <category term="策略路由" scheme="https://www.leolan.top/tags/%E7%AD%96%E7%95%A5%E8%B7%AF%E7%94%B1/"/>
    
  </entry>
  
  <entry>
    <title>web性能测试</title>
    <link href="https://www.leolan.top/posts/9286/"/>
    <id>https://www.leolan.top/posts/9286/</id>
    <published>2017-06-05T02:38:03.000Z</published>
    <updated>2017-06-05T02:49:40.005Z</updated>
    
    <content type="html"><![CDATA[<script src="/assets/js/DPlayer.min.js"> </script><script src="/assets/js/APlayer.min.js"> </script><h1 id="Siege"><a href="#Siege" class="headerlink" title="Siege"></a>Siege</h1><p>Siege是一个压力测试和评测工具，设计用于WEB开发这评估应用在压力下的承受能力：可以根据配置对一个WEB站点进行多用户的并发访问，记录每个用户所有请求过程的相应时间，并在一定数量的并发访问下重复进行。</p>
<p>官网：<a href="https://www.joedog.org/" target="_blank" rel="external">https://www.joedog.org/</a></p>
<h2 id="安装Siege"><a href="#安装Siege" class="headerlink" title="安装Siege"></a>安装Siege</h2><p>Centos或Ubuntu直接用yum或apt安装就行了<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">yum <span class="keyword">install</span> siege -y</div><div class="line">apt-<span class="keyword">get</span> <span class="keyword">install</span> siege -y</div></pre></td></tr></table></figure></p>
<p><strong>源码安装</strong><br>下载：<a href="http://download.joedog.org/siege/" target="_blank" rel="external">http://download.joedog.org/siege/</a><br><figure class="highlight gauss"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">yum install gcc -y</div><div class="line">wget http:<span class="comment">//download.joedog.org/siege/siege-latest.tar.gz</span></div><div class="line">tar -zxvf siege-latest.tar.gz</div><div class="line">cd siege-latest</div><div class="line">./configure</div><div class="line"><span class="built_in">make</span> &amp;&amp; <span class="built_in">make</span> install</div><div class="line">siege -V   <span class="meta">#安装成功就能看到版本了</span></div></pre></td></tr></table></figure></p>
<h2 id="开始测试"><a href="#开始测试" class="headerlink" title="开始测试"></a>开始测试</h2><figure class="highlight nginx"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="attribute">siege</span> -h        <span class="comment">#查看帮助</span></div><div class="line">siege -c <span class="number">5</span> -r <span class="number">2</span> https://baidu.com</div><div class="line">参数说明： -c 是并发量，并发数为<span class="number">5</span>,  -r 是重复次数， 重复<span class="number">2</span>次</div></pre></td></tr></table></figure>
<p>运行结果：<br><figure class="highlight avrasm"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="symbol">Transactions:</span>		          <span class="number">30</span> hits        <span class="meta">## 完成处理数30</span></div><div class="line"><span class="symbol">Availability:</span>		      <span class="number">100.00</span> %           <span class="meta">## 可用，成功率100%</span></div><div class="line">Elapsed time:		        <span class="number">4.67</span> secs        <span class="meta">## 耗时4.67秒</span></div><div class="line">Data transferred:	        <span class="number">0.07</span> MB          <span class="meta">## 数据传输0.07MB</span></div><div class="line">Response time:		        <span class="number">0.50</span> secs        <span class="meta">## 响应时间0.50秒</span></div><div class="line">Transaction rate:	        <span class="number">6.42</span> trans/<span class="keyword">sec</span>   <span class="meta">## 每秒完成6.42个处理</span></div><div class="line"><span class="symbol">Throughput:</span>		        <span class="number">0.01</span> MB/<span class="keyword">sec</span>      <span class="meta">## 吞吐量，每秒传输0.01MB</span></div><div class="line"><span class="symbol">Concurrency:</span>		        <span class="number">3.21</span>             <span class="meta">## 实际最高并发连接数</span></div><div class="line">Successful transactions:          <span class="number">30</span>             <span class="meta">## 成功完成处理30次</span></div><div class="line">Failed transactions:	           <span class="number">0</span>             <span class="meta">## 失败0次</span></div><div class="line">Longest transaction:	        <span class="number">2.25</span>             <span class="meta">## 每次传输所花最长时间</span></div><div class="line">Shortest transaction:	        <span class="number">0.37</span>             <span class="meta">## 每次传输所花最短时间</span></div></pre></td></tr></table></figure></p>
<h2 id="Siege常用参数"><a href="#Siege常用参数" class="headerlink" title="Siege常用参数"></a>Siege常用参数</h2><p>Siege常用的参数有如下几个：<br><figure class="highlight haml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">-<span class="ruby">c 或者 --concurrent=NUM : 用于指定并发人数</span></div><div class="line">-<span class="ruby">r 或者 --reps=NUM       : 用于指定重复次数</span></div><div class="line">-<span class="ruby">d 或者 --delay=NUM      : 用于指定延迟时间</span></div><div class="line">-<span class="ruby">f 或者 --file=FILE      : 用于指定URL列表的文件，可以一次对多个路径进行测试</span></div><div class="line">-<span class="ruby">t 或者 --time=NUMm      : 用于指定测试持续时间。例如： -t10S (<span class="number">10</span>秒)  -t5M(<span class="number">5</span>分钟)  -t1H(<span class="number">1</span>小时)</span></div><div class="line">-<span class="ruby">l 或者 --log[=FILE]     : 用于记录结果日志</span></div></pre></td></tr></table></figure></p>
<p>参考：<a href="https://my.oschina.net/wangmengjun/blog/913745" target="_blank" rel="external">https://my.oschina.net/wangmengjun/blog/913745</a></p>
<hr>
]]></content>
    
    <summary type="html">
    
      &lt;script src=&quot;/assets/js/DPlayer.min.js&quot;&gt; &lt;/script&gt;&lt;script src=&quot;/assets/js/APlayer.min.js&quot;&gt; &lt;/script&gt;&lt;h1 id=&quot;Siege&quot;&gt;&lt;a href=&quot;#Siege&quot; class=&quot;h
    
    </summary>
    
    
      <category term="web性能测试" scheme="https://www.leolan.top/tags/web%E6%80%A7%E8%83%BD%E6%B5%8B%E8%AF%95/"/>
    
  </entry>
  
  <entry>
    <title>ssl</title>
    <link href="https://www.leolan.top/posts/50900/"/>
    <id>https://www.leolan.top/posts/50900/</id>
    <published>2017-06-05T02:37:44.000Z</published>
    <updated>2017-06-05T02:49:40.003Z</updated>
    
    <content type="html"><![CDATA[<script src="/assets/js/DPlayer.min.js"> </script><script src="/assets/js/APlayer.min.js"> </script><h1 id="Let’s-Encrypt-证书"><a href="#Let’s-Encrypt-证书" class="headerlink" title="Let’s Encrypt 证书"></a>Let’s Encrypt 证书</h1><p>Let’s Encrypt 证书是免费的，3个月有效，只需要到期前续一下时间就能延长到3个月。</p>
<p>这里一共有3种方法。其中两种是依赖于Python环境的（letsencrypt自动脚本），需要安装很多组件且对pip有版本要求，在大天朝是无法安装的。这里介绍一种简单的方法<br>打开：<a href="https://certbot.eff.org" target="_blank" rel="external">https://certbot.eff.org</a><br>选择适合你的系统和web的选项<br><img src="https://image.leolan.top/SSL.png" alt=""><br>然后按提示运行Install栏的那些命令，其他不要运行。</p>
<p>安装完成后，开始获取证书<br><figure class="highlight stylus"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">certbot certonly --webroot -w /var/html/www -d www<span class="selector-class">.leolan</span><span class="selector-class">.top</span>,leolan.<span class="attribute">top</span></div></pre></td></tr></table></figure></p>
<p>运行该命令后会自动获取证书，并保存到<strong>/etc/letsencrypt/live/</strong>下。如果是一机多站的这种情况可能是会报错的，只有第一个能获取证书，之后的其他都获取不了，这时先停止第一个网站（把ssl的相关配置从配置文件中删掉，等获取后再配置回去），再运行命令，成功之后再启动网站。</p>
<p>然后修改虚拟主机配置文件，在server栏加入以下部分(对应的路径改为你自己的路径):<br><figure class="highlight nginx"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="attribute">listen</span>  <span class="number">443</span> default ssl;</div><div class="line"></div><div class="line"><span class="attribute">ssl_certificate</span> /etc/letsencrypt/live/www.leolan.top/fullchain.pem;</div><div class="line"><span class="attribute">ssl_certificate_key</span> /etc/letsencrypt/live/www.leolan.top/privkey.pem;</div><div class="line"><span class="attribute">ssl_ciphers</span> <span class="string">"EECDH+AESGCM:EDH+AESGCM:AES256+EECDH:AES256+EDH"</span>;</div><div class="line"><span class="attribute">ssl_protocols</span> TLSv1 TLSv1.<span class="number">1</span> TLSv1.<span class="number">2</span>;</div><div class="line"><span class="attribute">ssl_prefer_server_ciphers</span> <span class="literal">on</span>;</div><div class="line"><span class="attribute">ssl_session_cache</span> shared:SSL:<span class="number">10m</span>;</div></pre></td></tr></table></figure></p>
<p>保存重启Nginx就应该生效了，如果网页中引用了http资源，也是没有小绿标的，可以写一句话测试用的html文件进行测试。<br>之后续期再次运行获取证书的命令就行了，会自动续期的，可以添加到定时任务中（增加到定时任务要注意一机多站这种情况）。<br>关于续期,官方提供了命令：先用这个命令测试：<code>certbot renew --dry-run</code>，没有问题的话运行这个命令续期：<code>certbot renew</code>。一切正常的话就可以加入到计划任务里面了。</p>
<hr>
<p>常用命令：<br><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">certbot <span class="keyword">run</span><span class="bash">             <span class="comment">#（默认）运行在当前的Web服务器中获取并安装证书</span></span></div><div class="line">certbot certonly        <span class="comment">#获取或续订证书，但不要安装</span></div><div class="line">certbot renew           <span class="comment">#续订续订所有以前获得的近期到期的证书</span></div><div class="line"></div><div class="line">certbot certificates    <span class="comment">#证书显示有关Certbot的证书信息</span></div><div class="line">certbot revoke          <span class="comment">#撤销吊销证书（提供--cert-path）</span></div><div class="line">certbot delete          <span class="comment">#删除证书</span></div></pre></td></tr></table></figure></p>
<hr>
<p>参考：<br><a href="http://www.laozuo.org/7676.html" target="_blank" rel="external">http://www.laozuo.org/7676.html</a><br><a href="http://www.laozuo.org/5571.html" target="_blank" rel="external">http://www.laozuo.org/5571.html</a><br><a href="http://m.blog.csdn.net/article/details?id=50997606" target="_blank" rel="external">http://m.blog.csdn.net/article/details?id=50997606</a><br><a href="http://www.tuicool.com/articles/iqyERrr" target="_blank" rel="external">http://www.tuicool.com/articles/iqyERrr</a></p>
<hr>
<h1 id="StartSSL证书"><a href="#StartSSL证书" class="headerlink" title="StartSSL证书"></a>StartSSL证书</h1><p>StartSSL证书有效期是一年的，但是到期后必须手工续期，且申请流程复杂，不建议。<br>StartSSL申请全过程：<a href="http://www.laozuo.org/2823.html" target="_blank" rel="external">http://www.laozuo.org/2823.html</a></p>
<hr>
<h1 id="SSL的相关参数"><a href="#SSL的相关参数" class="headerlink" title="SSL的相关参数"></a>SSL的相关参数</h1><h2 id="ssl"><a href="#ssl" class="headerlink" title="ssl"></a>ssl</h2><p>语法：ssl [on|off]<br>默认值：ssl off<br>使用字段：main, server<br>开启HTTPS。</p>
<h2 id="ssl-certificate"><a href="#ssl-certificate" class="headerlink" title="ssl_certificate"></a>ssl_certificate</h2><p>语法：ssl_certificate file<br>默认值：ssl_certificate cert.pem<br>使用字段：main, server<br>为这个虚拟主机指定PEM格式的证书文件，这个文件可以包含其他的证书和服务器私钥，同样，密钥也必须是PEM格式，0.6.7版本以后，这里的路径为相对于nginx.conf的路径，而不是编译时的prefix路径。</p>
<h2 id="ssl-certificate-key"><a href="#ssl-certificate-key" class="headerlink" title="ssl_certificate_key"></a>ssl_certificate_key</h2><p>语法：ssl_certificate_key file<br>默认值：ssl_certificate_key cert.pem<br>使用字段：main, server<br>为这个虚拟主机指定PEM格式的私钥，0.6.7版本以后，这里的路径为相对于nginx.conf的路径，而不是编译时的prefix路径。</p>
<h2 id="ssl-client-certificate"><a href="#ssl-client-certificate" class="headerlink" title="ssl_client_certificate"></a>ssl_client_certificate</h2><p>语法：ssl_client_certificate file<br>默认值：none<br>使用字段：main, server<br>指出包含PEM格式的CA（root）证书，它将用于检查客户端证书。</p>
<h2 id="ssl-dhparam"><a href="#ssl-dhparam" class="headerlink" title="ssl_dhparam"></a>ssl_dhparam</h2><p>语法：ssl_dhparam file<br>默认值：none<br>使用字段：main, server<br>该指令指定了一个PEM格式的文件，其中包含的Diffie-Hellman密钥协商协议密码参数，它将用于服务器和客户端之间的会话密钥交换。</p>
<h2 id="ssl-ciphers"><a href="#ssl-ciphers" class="headerlink" title="ssl_ciphers"></a>ssl_ciphers</h2><p>语法：ssl_ciphers file<br>默认值：ssl_ciphers ALL:!ADH:RC4+RSA:+HIGH:+MEDIUM:+LOW:+SSLv2:+EXP<br>使用字段：main, server<br>指出为建立安全连接，服务器所允许的密码格式列表，密码指定为OpenSSL支持的格式，如：<br>ssl_ciphers  ALL:!ADH:!EXPORT56:RC4+RSA:+HIGH:+MEDIUM:+LOW:+SSLv2:+EXP;<br>查看当前安装的OpenSSL版本所支持的密码列表，可以使用下列命令：<code>openssl ciphers</code></p>
<h2 id="ssl-crl"><a href="#ssl-crl" class="headerlink" title="ssl_crl"></a>ssl_crl</h2><p>语法：ssl_crl file<br>默认值：none<br>使用字段：http, server<br>指令可用于0.8.7以后版本，用于指定一个证书吊销列表的文件名，使用PEM格式，它将用于检查证书吊销状态。</p>
<h2 id="ssl-prefer-server-ciphers"><a href="#ssl-prefer-server-ciphers" class="headerlink" title="ssl_prefer_server_ciphers"></a>ssl_prefer_server_ciphers</h2><p>语法：ssl_prefer_server_ciphers [on|off]<br>默认值：ssl_prefer_server_ciphers off<br>使用字段：main, server<br>依赖SSLv3和TLSv1协议的服务器密码将优先于客户端密码。</p>
<h2 id="ssl-protocols"><a href="#ssl-protocols" class="headerlink" title="ssl_protocols"></a>ssl_protocols</h2><p>语法：ssl_protocols [SSLv2] [SSLv3] [TLSv1]<br>默认值：ssl_protocols SSLv2 SSLv3 TLSv1<br>使用字段：main, server<br>指定要开启的SSL协议。</p>
<h2 id="ssl-verify-client"><a href="#ssl-verify-client" class="headerlink" title="ssl_verify_client"></a>ssl_verify_client</h2><p>语法：ssl_verify_client on|off|optional<br>默认值：ssl_verify_client off<br>使用字段：main, server<br>启用客户端身份验证，参数“optional”将使用客户端提供的证书检查它的权限(0.8.7与0.7.63版本之前为”ask”)。</p>
<h2 id="ssl-verify-depth"><a href="#ssl-verify-depth" class="headerlink" title="ssl_verify_depth"></a>ssl_verify_depth</h2><p>语法：ssl_verify_depth number<br>默认值：ssl_verify_depth 1<br>使用字段：main, server<br>设置服务器按顺序检查客户端提供的证书链的长度。</p>
<h2 id="ssl-session-cache"><a href="#ssl-session-cache" class="headerlink" title="ssl_session_cache"></a>ssl_session_cache</h2><p>语法：ssl_session_cache off|none|builtin:size and/or shared:name:size<br>默认值：ssl_session_cache off<br>使用字段： main, server<br>设置储存SSL会话的缓存类型和大小。</p>
<p>缓存类型为：<br>off - 强制关闭：nginx告诉客户端这个会话已经不能被再次使用。<br>none - 非强制关闭：nginx告诉客户端这个会话可以被再次使用，但是nginx实际上并不使用它们，这是为某些使用ssl_session_cache的邮件客户端提供的一种变通方案，可以使用在邮件代理和HTTP服务器中。</p>
<p>builtin - 内建OpenSSL缓存，仅能用在一个工作进程中，缓存大小在会话总数中指定，注意：如果要使用这个类型可能会引起内存碎片问题，具体请查看下文中参考文档。</p>
<p>shared - 缓存在所有的工作进程中共享，缓存大小指定单位为字节，1MB缓存大概保存4000个会话，每个共享的缓存必须有自己的名称，相同名称的缓存可以使用在不同的虚拟主机中。<br>可以同时使用两个缓存类型，内建和共享，如：<br><figure class="highlight css"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="selector-tag">ssl_session_cache</span>  <span class="selector-tag">builtin</span><span class="selector-pseudo">:1000</span>  <span class="selector-tag">shared</span><span class="selector-pseudo">:SSL</span><span class="selector-pseudo">:10m</span>;</div></pre></td></tr></table></figure></p>
<p>但是，使用共享缓存而不使用内建缓存将更为有效。<br>0.8.34版本之前如果ssl_verify_client设置为’on’或者’optional’时这里不能设置为none或off。<br>注意，为了让缓存恢复工作，你需要在服务器为SSL socket配置默认服务器，例如：<br><figure class="highlight css"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="selector-tag">listen</span> <span class="selector-attr">[::]</span><span class="selector-pseudo">:443</span> <span class="selector-tag">ssl</span> <span class="selector-tag">default_server</span>;</div></pre></td></tr></table></figure></p>
<p>这是因为缓存的重用发生在任何TLS扩展启用之前，即服务器名称认证（Server Name Identification (SNI)），来自一个指定IP地址（服务器）的ClientHello信息请求一个会话ID，为了使其工作，默认（default）服务器必须被设置。<br>最好的方法是将ssl_session_cache放到http字段，这样下面配置的server/虚拟主机字段都将得到相同的SSL缓存配置。</p>
<h2 id="ssl-session-timeout"><a href="#ssl-session-timeout" class="headerlink" title="ssl_session_timeout"></a>ssl_session_timeout</h2><p>语法：ssl_session_timeout time<br>默认值：ssl_session_timeout 5m<br>使用字段： main, server<br>设置客户端能够反复使用储存在缓存中的会话参数时间。</p>
<h2 id="ssl-engine"><a href="#ssl-engine" class="headerlink" title="ssl_engine"></a>ssl_engine</h2><p>语法：ssl_engine<br>指定使用的OpenSSL引擎，如Padlock，例如PadLock，下列命令可以查看你的OpenSSL支持的引擎：openssl engine</p>
<p>Debian系统在版本0.9.8o的OpenSSL运行后返回：<br><figure class="highlight ebnf"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="attribute">openssl engine</span></div></pre></td></tr></table></figure></p>
<p>(padlock) VIA PadLock (no-RNG, no-ACE)<br>(dynamic) Dynamic engine loading support</p>
<h2 id="内置变量"><a href="#内置变量" class="headerlink" title="内置变量"></a>内置变量</h2><p>ngx_http_ssl_module模块支持下列内建变量：<br>$ssl_cipher - 返回建立的SSL连接中那些使用的密码字段。<br>$ssl_client_serial - 返回建立的SSL连接中客户端证书的序列号。<br>$ssl_client_s_dn - 返回建立的SSL连接中客户端证书的DN主题字段。<br>$ssl_client_i_dn - 返回建立的SSL连接中客户端证书的DN发行者字段。<br>$ssl_protocol - 返回建立的SSL连接中使用的协议。<br>$ssl_session_id - 需要0.8.20以上版本。<br>$ssl_client_cert<br>$ssl_client_raw_cert<br>$ssl_client_verify - 如果客户端证书审核通过，这个变量为“SUCCESS”。</p>
<h2 id="非标准错误代码"><a href="#非标准错误代码" class="headerlink" title="非标准错误代码"></a>非标准错误代码</h2><p>这个模块支持一些非标准的HTTP错误代码，可以借助error_page指令用于调试：<br>495 - 检查客户端证书时发生错误。<br>496 - 客户端无法提供必须的证书。<br>497 - 传送到HTTPS的普通请求。<br>在请求完整的废除后调试完成，并取得一些内置变量，如：$request_uri, $uri, $arg等。</p>
<hr>
<p>参考：<br>安装SSL证书：<a href="http://zh.wikihow.com/%E5%AE%89%E8%A3%85SSL%E8%AF%81%E4%B9%A6" target="_blank" rel="external">http://zh.wikihow.com/%E5%AE%89%E8%A3%85SSL%E8%AF%81%E4%B9%A6</a><br>在Docker里的web开启SSL:<a href="https://en.abnerchou.me/Blog/75027340" target="_blank" rel="external">https://en.abnerchou.me/Blog/75027340</a></p>
<hr>
]]></content>
    
    <summary type="html">
    
      &lt;script src=&quot;/assets/js/DPlayer.min.js&quot;&gt; &lt;/script&gt;&lt;script src=&quot;/assets/js/APlayer.min.js&quot;&gt; &lt;/script&gt;&lt;h1 id=&quot;Let’s-Encrypt-证书&quot;&gt;&lt;a href=&quot;#Let’
    
    </summary>
    
    
      <category term="ssl" scheme="https://www.leolan.top/tags/ssl/"/>
    
  </entry>
  
  <entry>
    <title>博客迁移</title>
    <link href="https://www.leolan.top/posts/53348/"/>
    <id>https://www.leolan.top/posts/53348/</id>
    <published>2017-05-09T16:21:04.000Z</published>
    <updated>2018-10-08T07:20:38.646Z</updated>
    
    <content type="html"><![CDATA[<script src="/assets/js/DPlayer.min.js"> </script><script src="/assets/js/APlayer.min.js"> </script><p>由于平台等多重原因，实在折腾的比较心累，决定把博客迁移到新的平台，由Hexo转Typecho，新站点请访问<font color="#ff0000">新版博客：<a href="https://www.leolan.top">www.leolan.top</a></font>。本博客依然能够用访问：<font color="#ff0000">旧版博客：<a href="https://old.leolan.top" target="_blank" rel="external">old.leolan.top</a></font> 但可能不再更新。非常抱歉。</p>
<p>由于Markdown语法的差异，迁移文章带来了许多麻烦，但是新的博客将会逐渐完善，非常感谢！</p>
]]></content>
    
    <summary type="html">
    
      &lt;script src=&quot;/assets/js/DPlayer.min.js&quot;&gt; &lt;/script&gt;&lt;script src=&quot;/assets/js/APlayer.min.js&quot;&gt; &lt;/script&gt;&lt;p&gt;由于平台等多重原因，实在折腾的比较心累，决定把博客迁移到新的平台，由Hex
    
    </summary>
    
    
      <category term="博客迁移" scheme="https://www.leolan.top/tags/%E5%8D%9A%E5%AE%A2%E8%BF%81%E7%A7%BB/"/>
    
  </entry>
  
  <entry>
    <title>关于评论,统一回复</title>
    <link href="https://www.leolan.top/posts/50249/"/>
    <id>https://www.leolan.top/posts/50249/</id>
    <published>2017-04-18T01:40:38.000Z</published>
    <updated>2017-04-18T02:03:09.485Z</updated>
    
    <content type="html"><![CDATA[<script src="/assets/js/DPlayer.min.js"> </script><script src="/assets/js/APlayer.min.js"> </script><p>关于评论系统的问题，今天无意间登陆后台才发现有如此多的<strong>垃圾评论</strong>，不知是多说出了问题还是我的设置有问题，之前是能接收到通知的，但不知什么时候开始就无法接收到通知了。<br><img src="http://ofyfogrgx.bkt.clouddn.com/image/20170418/094303232.png" alt="mark"><br><img src="http://ofyfogrgx.bkt.clouddn.com/image/20170418/094407024.png" alt="mark"><br><img src="http://ofyfogrgx.bkt.clouddn.com/image/20170418/094431552.png" alt="mark"></p>
<p>关于回复，不管是善意还是恶意，对于没能及时回复感到抱歉。多说于6月停止服务，没有更适合的评论系统，所以博客决定进行整改，应该会在7月前完成。</p>
<p>对于博客内容，主要是工作中遇到的内容更新的比较快，其他的瞎折腾要有时间才会去更新，但是都会尽量的写详细，对于没能及时回复感到抱歉，可以给我发邮件：842632422@qq.com（基本每天都会查收邮件）；有什么好的建议欢迎提出来，非常感谢！</p>
<p>另外非常感谢今天Archonz同学的打赏（应该是来自于博客，我只有在博客留过二维码），要不是支付宝有提醒，我也不会来看多说后台（以前多说有新评论都会受到邮件通知的，现在没有了@_@~）。</p>
<p>本博客的主要目的是个人整理思路，方便本人。最好是能给大家一点思路，技术的价值在于分享，没有什么装逼嫌疑，希望某些用户留点口德，非常感谢！</p>
]]></content>
    
    <summary type="html">
    
      &lt;script src=&quot;/assets/js/DPlayer.min.js&quot;&gt; &lt;/script&gt;&lt;script src=&quot;/assets/js/APlayer.min.js&quot;&gt; &lt;/script&gt;&lt;p&gt;关于评论系统的问题，今天无意间登陆后台才发现有如此多的&lt;strong&gt;垃圾
    
    </summary>
    
    
      <category term="关于评论" scheme="https://www.leolan.top/tags/%E5%85%B3%E4%BA%8E%E8%AF%84%E8%AE%BA/"/>
    
  </entry>
  
  <entry>
    <title>FTP</title>
    <link href="https://www.leolan.top/posts/10719/"/>
    <id>https://www.leolan.top/posts/10719/</id>
    <published>2017-04-14T05:45:43.000Z</published>
    <updated>2018-10-08T07:11:51.137Z</updated>
    
    <content type="html"><![CDATA[<script src="/assets/js/DPlayer.min.js"> </script><script src="/assets/js/APlayer.min.js"> </script><h1 id="Centos-不完整，待完成"><a href="#Centos-不完整，待完成" class="headerlink" title="Centos 不完整，待完成"></a>Centos 不完整，待完成</h1><figure class="highlight cmake"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">yum <span class="keyword">install</span> vsftpd -y</div></pre></td></tr></table></figure>
<p>修改配置<br><figure class="highlight nix"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">vim /etc/vsftpd/vsftpd.conf</div><div class="line"></div><div class="line"><span class="comment">#修改以下项目 </span></div><div class="line"><span class="attr">anonymous_enable=NO</span>     <span class="comment">#关闭匿名登录</span></div><div class="line"><span class="attr">chroot_local_user=YES</span>   <span class="comment">#禁止跳出家目录</span></div></pre></td></tr></table></figure></p>
<p>创建用户<br><figure class="highlight dts"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">useradd -s <span class="meta-keyword">/sbin/</span>nologin -d <span class="meta-keyword">/var/</span>www/html(指定家目录) ftp_username</div><div class="line"></div><div class="line">passwd ftp_username</div><div class="line">chmod o+w <span class="meta-keyword">/var/</span>www/html(家目录)</div></pre></td></tr></table></figure></p>
<p>要关闭selinux(修改配置文件要重启生效)，现在立刻生效：<code>setenforce 0</code></p>
<figure class="highlight applescript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#Centos 6</span></div><div class="line">service vsftpd restart</div><div class="line">chkconfig vsftpd <span class="keyword">on</span></div><div class="line"></div><div class="line"><span class="comment">#Centos 7</span></div><div class="line">systemctl restart vsftpd</div><div class="line">systemctl enable vsftpd</div></pre></td></tr></table></figure>
<p>注意要开启防火墙的端口。<strong>如果是被动模式，要开1024以上的端口若干个，并且配置文件中指定</strong></p>
<p>参考：<br><a href="http://www.centoscn.com/CentosServer/ftp/2013/0730/816.html" target="_blank" rel="external">http://www.centoscn.com/CentosServer/ftp/2013/0730/816.html</a><br><a href="http://www.linuxidc.com/Linux/2013-09/90562.htm" target="_blank" rel="external">http://www.linuxidc.com/Linux/2013-09/90562.htm</a><br><a href="http://www.linuxidc.com/Linux/2013-09/90560.htm" target="_blank" rel="external">http://www.linuxidc.com/Linux/2013-09/90560.htm</a></p>
<hr>
<h1 id="Windows"><a href="#Windows" class="headerlink" title="Windows"></a>Windows</h1><p>在Windows上安装FTP可以在服务器里添加角色，或者下载第三方FTP服务端，注意设置时如果是被动模式要开启1024以上的端口若干个，路由开放这些端口。</p>
<hr>
]]></content>
    
    <summary type="html">
    
      &lt;script src=&quot;/assets/js/DPlayer.min.js&quot;&gt; &lt;/script&gt;&lt;script src=&quot;/assets/js/APlayer.min.js&quot;&gt; &lt;/script&gt;&lt;h1 id=&quot;Centos-不完整，待完成&quot;&gt;&lt;a href=&quot;#Centos
    
    </summary>
    
      <category term="环境搭建" scheme="https://www.leolan.top/categories/%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/"/>
    
    
      <category term="FTP" scheme="https://www.leolan.top/tags/FTP/"/>
    
  </entry>
  
  <entry>
    <title>Linux备份恢复</title>
    <link href="https://www.leolan.top/posts/32881/"/>
    <id>https://www.leolan.top/posts/32881/</id>
    <published>2017-04-08T17:39:56.000Z</published>
    <updated>2017-04-10T01:54:46.440Z</updated>
    
    <content type="html"><![CDATA[<script src="/assets/js/DPlayer.min.js"> </script><script src="/assets/js/APlayer.min.js"> </script><h1 id="文件备份恢复"><a href="#文件备份恢复" class="headerlink" title="文件备份恢复"></a>文件备份恢复</h1><hr>
<h1 id="Linux系统的备份恢复"><a href="#Linux系统的备份恢复" class="headerlink" title="Linux系统的备份恢复"></a>Linux系统的备份恢复</h1><h2 id="tar命令"><a href="#tar命令" class="headerlink" title="tar命令"></a>tar命令</h2><h3 id="备份整个系统"><a href="#备份整个系统" class="headerlink" title="备份整个系统"></a>备份整个系统</h3><p>注意根目录下要有充足的可用空间用于备份。<br><figure class="highlight stylus"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">cd /</div><div class="line"><span class="selector-id">#tar</span>.gz格式</div><div class="line">tar cvpzf system_backup<span class="selector-class">.tar</span><span class="selector-class">.gz</span> / --exclude=/proc --exclude=/lost+found --exclude=/system_backup<span class="selector-class">.tar</span><span class="selector-class">.gz</span> --exclude=/mnt --exclude=/sys</div><div class="line"></div><div class="line"><span class="selector-id">#tar</span>.bz2格式</div><div class="line">tar cvpjf system_backup<span class="selector-class">.tar</span><span class="selector-class">.bz2</span> / --exclude=/proc --exclude=/lost+found --exclude=/system_backup<span class="selector-class">.tar</span><span class="selector-class">.bz2</span> --exclude=/mnt --exclude=/sys</div></pre></td></tr></table></figure></p>
<hr>
<h3 id="恢复系统"><a href="#恢复系统" class="headerlink" title="恢复系统"></a>恢复系统</h3><figure class="highlight tcl"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">cd</span> /</div><div class="line"><span class="comment">#上传文件到根目录下</span></div><div class="line">tar xvpfz system_backup.tar.gz -C /</div><div class="line">或</div><div class="line">tar xvpfj system_backup.tar.bz2 -C /</div><div class="line"></div><div class="line"><span class="comment">#创建备份时排除的目录</span></div><div class="line">mkdir <span class="keyword">proc</span><span class="title"></span></div><div class="line">mkdir lost+found<span class="title"></span></div><div class="line">mkdir mnt<span class="title"></span></div><div class="line">mkdir sys</div></pre></td></tr></table></figure>
<ul>
<li>/proc 权限：文件所有者：root群组：root 所有者：读取 执行 群组：读取 执行 其它：读取 执行</li>
<li>/lost+found 权限：文件所有者：root群组：root 所有者：读取 写入 执行 群组：读取 执行 其它：读取 执行</li>
<li>/mnt 权限：文件所有者：root群组：root 所有者：读取 写入 执行 群组：读取 执行 其它：读取 执行</li>
<li>/sys 权限：文件所有者：root群组：root 所有者：读取 写入 执行 群组：读取 执行 其它：读取 执行</li>
</ul>
<p>恢复完成重启以后，所以的事情都会和你备份的时候一模一样。</p>
<hr>
<h2 id="rsync命令"><a href="#rsync命令" class="headerlink" title="rsync命令"></a>rsync命令</h2><p>注意目标分区的格式最好是NTFS、FAT、EXT之类的格式，避免遇到大于4G的文件无法备份的问题。<br><figure class="highlight gradle"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">#最好有其他分区或外接存储设备，挂载好，df -lh看挂载点。</div><div class="line">#备份</div><div class="line">rsync -Pa <span class="regexp">/ /m</span>edia<span class="regexp">/usb/</span>backup_20170410 --<span class="keyword">exclude</span>=<span class="regexp">/media/</span>* --<span class="keyword">exclude</span>=<span class="regexp">/sys/</span>* --<span class="keyword">exclude</span>=<span class="regexp">/proc/</span>* --<span class="keyword">exclude</span>=<span class="regexp">/mnt/</span>* --<span class="keyword">exclude</span>=<span class="regexp">/tmp/</span>*</div><div class="line"></div><div class="line">#恢复</div><div class="line">rsync -Pa <span class="regexp">/media/u</span>sb<span class="regexp">/backup_20170410 /</span></div></pre></td></tr></table></figure></p>
<hr>
<h2 id="dd命令"><a href="#dd命令" class="headerlink" title="dd命令"></a>dd命令</h2><p>dd命令属于扇区克隆，目标分区要比备份分区要大，即使没有使用的空间也会被原样克隆下来，会比较慢。<br><figure class="highlight crystal"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#备份</span></div><div class="line">df -h   <span class="comment">#查看系统所在分区</span></div><div class="line">dd <span class="keyword">if</span>=<span class="regexp">/dev/sda</span>1 <span class="keyword">of</span>=<span class="regexp">/dev/sdb</span>3     <span class="comment">#备份sda1到sdb3中</span></div><div class="line"></div><div class="line"><span class="comment">#恢复</span></div><div class="line">dd <span class="keyword">if</span>=<span class="regexp">/dev/sdb</span>3 <span class="keyword">of</span>=<span class="regexp">/dev/sda</span>1     <span class="comment">#恢复sdb3到sdb1中</span></div></pre></td></tr></table></figure></p>
<hr>
<h2 id="CloneZilla-再生龙"><a href="#CloneZilla-再生龙" class="headerlink" title="CloneZilla(再生龙)"></a>CloneZilla(再生龙)</h2><p>此款软件需要另外下载，支持几乎所有主流系统，可通过U盘启动</p>
<hr>
]]></content>
    
    <summary type="html">
    
      &lt;script src=&quot;/assets/js/DPlayer.min.js&quot;&gt; &lt;/script&gt;&lt;script src=&quot;/assets/js/APlayer.min.js&quot;&gt; &lt;/script&gt;&lt;h1 id=&quot;文件备份恢复&quot;&gt;&lt;a href=&quot;#文件备份恢复&quot; class=
    
    </summary>
    
      <category term="系统管理" scheme="https://www.leolan.top/categories/%E7%B3%BB%E7%BB%9F%E7%AE%A1%E7%90%86/"/>
    
    
      <category term="Linux备份恢复" scheme="https://www.leolan.top/tags/Linux%E5%A4%87%E4%BB%BD%E6%81%A2%E5%A4%8D/"/>
    
  </entry>
  
  <entry>
    <title>PostgreSQL数据库</title>
    <link href="https://www.leolan.top/posts/53623/"/>
    <id>https://www.leolan.top/posts/53623/</id>
    <published>2017-04-08T17:36:30.000Z</published>
    <updated>2017-04-10T01:54:46.412Z</updated>
    
    <content type="html"><![CDATA[<script src="/assets/js/DPlayer.min.js"> </script><script src="/assets/js/APlayer.min.js"> </script><h1 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h1><p>官网安装教程：<a href="https://www.postgresql.org/download/linux/redhat/" target="_blank" rel="external">https://www.postgresql.org/download/linux/redhat/</a></p>
<p><a href="http://www.cnblogs.com/qiyebao/p/4562557.html" target="_blank" rel="external">http://www.cnblogs.com/qiyebao/p/4562557.html</a></p>
<hr>
]]></content>
    
    <summary type="html">
    
      &lt;script src=&quot;/assets/js/DPlayer.min.js&quot;&gt; &lt;/script&gt;&lt;script src=&quot;/assets/js/APlayer.min.js&quot;&gt; &lt;/script&gt;&lt;h1 id=&quot;安装&quot;&gt;&lt;a href=&quot;#安装&quot; class=&quot;headerl
    
    </summary>
    
      <category term="数据库" scheme="https://www.leolan.top/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/"/>
    
    
      <category term="PostgreSQL数据库" scheme="https://www.leolan.top/tags/PostgreSQL%E6%95%B0%E6%8D%AE%E5%BA%93/"/>
    
  </entry>
  
  <entry>
    <title>OpenWRT-LEDE</title>
    <link href="https://www.leolan.top/posts/23851/"/>
    <id>https://www.leolan.top/posts/23851/</id>
    <published>2017-04-08T17:11:27.000Z</published>
    <updated>2017-04-10T01:54:46.441Z</updated>
    
    <content type="html"><![CDATA[<script src="/assets/js/DPlayer.min.js"> </script><script src="/assets/js/APlayer.min.js"> </script><h1 id="OpenWrt"><a href="#OpenWrt" class="headerlink" title="OpenWrt"></a>OpenWrt</h1><p>官网：<a href="https://openwrt.org" target="_blank" rel="external">https://openwrt.org</a><br>项目地址：:<a href="https://github.com/openwrt/openwrt" target="_blank" rel="external">https://github.com/openwrt/openwrt</a><br>固件：<a href="https://downloads.openwrt.org/chaos_calmer/15.05.1/" target="_blank" rel="external">https://downloads.openwrt.org/chaos_calmer/15.05.1/</a></p>
<hr>
<h1 id="LEDE"><a href="#LEDE" class="headerlink" title="LEDE"></a>LEDE</h1><p>官网：<a href="https://lede-project.org/zh/start" target="_blank" rel="external">https://lede-project.org/zh/start</a><br>项目地址：<a href="https://lede-project.org/docs/guide-developer/the-source-code" target="_blank" rel="external">https://lede-project.org/docs/guide-developer/the-source-code</a><br>固件：<a href="https://downloads.lede-project.org/snapshots/targets" target="_blank" rel="external">https://downloads.lede-project.org/snapshots/targets</a></p>
<hr>
]]></content>
    
    <summary type="html">
    
      &lt;script src=&quot;/assets/js/DPlayer.min.js&quot;&gt; &lt;/script&gt;&lt;script src=&quot;/assets/js/APlayer.min.js&quot;&gt; &lt;/script&gt;&lt;h1 id=&quot;OpenWrt&quot;&gt;&lt;a href=&quot;#OpenWrt&quot; clas
    
    </summary>
    
      <category term="路由" scheme="https://www.leolan.top/categories/%E8%B7%AF%E7%94%B1/"/>
    
    
      <category term="OpenWRT-LEDE" scheme="https://www.leolan.top/tags/OpenWRT-LEDE/"/>
    
  </entry>
  
  <entry>
    <title>Shell技巧</title>
    <link href="https://www.leolan.top/posts/39984/"/>
    <id>https://www.leolan.top/posts/39984/</id>
    <published>2017-04-08T16:30:44.000Z</published>
    <updated>2017-04-10T01:54:46.412Z</updated>
    
    <content type="html"><![CDATA[<script src="/assets/js/DPlayer.min.js"> </script><script src="/assets/js/APlayer.min.js"> </script><h1 id="Shell快捷键"><a href="#Shell快捷键" class="headerlink" title="Shell快捷键"></a>Shell快捷键</h1><hr>
<h2 id="编辑命令"><a href="#编辑命令" class="headerlink" title="编辑命令"></a>编辑命令</h2><p>Ctrl + a ：移到命令行首<br>Ctrl + e ：移到命令行尾<br>Ctrl + f ：按字符前移（右向）<br>Ctrl + b ：按字符后移（左向）<br>Alt + f ：按单词前移（右向）<br>Alt + b ：按单词后移（左向）<br>Ctrl + xx：在命令行首和光标之间移动<br>Ctrl + u ：从光标处删除至命令行首<br>Ctrl + k ：从光标处删除至命令行尾<br>Ctrl + w ：从光标处删除至字首<br>Alt + d ：从光标处删除至字尾<br>Ctrl + d ：删除光标处的字符<br>Ctrl + h ：删除光标前的字符<br>Ctrl + y ：粘贴至光标后<br>Alt + c ：从光标处更改为首字母大写的单词<br>Alt + u ：从光标处更改为全部大写的单词<br>Alt + l ：从光标处更改为全部小写的单词<br>Ctrl + t ：交换光标处和之前的字符<br>Alt + t ：交换光标处和之前的单词<br>Alt + Backspace：与 Ctrl + w <del>相同</del>类似，分隔符有些差别 [感谢 rezilla 指正]</p>
<hr>
<h2 id="重新执行命令"><a href="#重新执行命令" class="headerlink" title="重新执行命令"></a>重新执行命令</h2><p>Ctrl + r：逆向搜索命令历史<br>Ctrl + g：从历史搜索模式退出<br>Ctrl + p：历史中的上一条命令<br>Ctrl + n：历史中的下一条命令<br>Alt + .：使用上一条命令的最后一个参数</p>
<hr>
<h2 id="控制命令"><a href="#控制命令" class="headerlink" title="控制命令"></a>控制命令</h2><p>Ctrl + l：清屏<br>Ctrl + o：执行当前命令，并选择上一条命令<br>Ctrl + s：阻止屏幕输出<br>Ctrl + q：允许屏幕输出<br>Ctrl + c：终止命令<br>Ctrl + z：挂起命令<br>Bang (!) 命令</p>
<hr>
<p><strong>!!</strong>：执行上一条命令<br><strong>!blah</strong>：执行最近的以 blah 开头的命令，如 !ls<br><strong>!blah:p</strong>：仅打印输出，而不执行<br><strong>!\$</strong>：上一条命令的最后一个参数，与 Alt + . 相同<br><strong>!\$:p</strong>：打印输出 !$ 的内容<br><strong>!*</strong>：上一条命令的所有参数<br><strong>!*:p</strong>：打印输出 !<em> 的内容<br><strong>^blah</strong>：删除上一条命令中的 blah<br><em>*^blah^foo</em></em>：将上一条命令中的 blah 替换为 foo<br>^blah^foo^：将上一条命令中所有的 blah 都替换为 foo</p>
<hr>
<p>友情提示_：</p>
<ul>
<li>以上介绍的大多数 Bash 快捷键仅当在 emacs 编辑模式时有效，若你将 Bash 配置为 vi 编辑模式，那将遵循 vi 的按键绑定。Bash 默认为 emacs 编辑模式。如果你的 Bash 不在 emacs 编辑模式，可通过 <code>set -o emacs</code> 设置。</li>
<li>^S、^Q、^C、^Z 是由终端设备处理的，可用 stty 命令设置。</li>
</ul>
<p>原文：<a href="https://linuxtoy.org/archives/bash-shortcuts.html" target="_blank" rel="external">https://linuxtoy.org/archives/bash-shortcuts.html</a></p>
<hr>
<h1 id="脚本调试"><a href="#脚本调试" class="headerlink" title="脚本调试"></a>脚本调试</h1><p>参考：<br><a href="http://blog.csdn.net/mupenghaha/article/details/8835956?locationNum=2&amp;fps=1" target="_blank" rel="external">http://blog.csdn.net/mupenghaha/article/details/8835956?locationNum=2&amp;fps=1</a><br><a href="http://blog.csdn.net/Jerry_1126/article/details/52096886?locationNum=3&amp;fps=1" target="_blank" rel="external">http://blog.csdn.net/Jerry_1126/article/details/52096886?locationNum=3&amp;fps=1</a></p>
<hr>
<h1 id="脚本攻略"><a href="#脚本攻略" class="headerlink" title="脚本攻略"></a>脚本攻略</h1><p>参考：<a href="http://man.linuxde.net/shell-script" target="_blank" rel="external">http://man.linuxde.net/shell-script</a></p>
<hr>
]]></content>
    
    <summary type="html">
    
      &lt;script src=&quot;/assets/js/DPlayer.min.js&quot;&gt; &lt;/script&gt;&lt;script src=&quot;/assets/js/APlayer.min.js&quot;&gt; &lt;/script&gt;&lt;h1 id=&quot;Shell快捷键&quot;&gt;&lt;a href=&quot;#Shell快捷键&quot; cl
    
    </summary>
    
      <category term="Shell" scheme="https://www.leolan.top/categories/Shell/"/>
    
    
      <category term="Shell技巧" scheme="https://www.leolan.top/tags/Shell%E6%8A%80%E5%B7%A7/"/>
    
  </entry>
  
  <entry>
    <title>TFS代码管理</title>
    <link href="https://www.leolan.top/posts/37588/"/>
    <id>https://www.leolan.top/posts/37588/</id>
    <published>2017-04-08T07:09:59.000Z</published>
    <updated>2017-04-25T09:17:49.875Z</updated>
    
    <content type="html"><![CDATA[<script src="/assets/js/DPlayer.min.js"> </script><script src="/assets/js/APlayer.min.js"> </script><p>TFS（Team Foundation Server）是一种代码管理工具，工作原理类似于SVN。</p>
<p>安装TFS还是比较简单的，在Windows Server服务器环境下安装是很简单的，TFS依赖SQL数据库，一般SQL2014及以上版本都需要.NET 4.5以上的版本。所以最好先安装.NET 4.5，不然一定会报错的。</p>
<hr>
<h1 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h1><p><strong>Microsoft .NET Framework 4</strong><br><a href="https://www.microsoft.com/zh-cn/download/confirmation.aspx?id=17718" target="_blank" rel="external">https://www.microsoft.com/zh-cn/download/confirmation.aspx?id=17718</a></p>
<p><strong>Microsoft .NET Framework 4.5</strong><br><a href="https://www.microsoft.com/zh-cn/download/confirmation.aspx?id=30653" target="_blank" rel="external">https://www.microsoft.com/zh-cn/download/confirmation.aspx?id=30653</a></p>
<hr>
<p><strong>SQL 2014 下载</strong><br><a href="https://www.microsoft.com/zh-CN/download/details.aspx?id=42299" target="_blank" rel="external">https://www.microsoft.com/zh-CN/download/details.aspx?id=42299</a><br>选择有Management的64位版本，如：SQLManagementStudio_x64_CHS.exe</p>
<hr>
<p><strong>TFS 2015 下载</strong><br><a href="https://www.microsoft.com/zh-cn/download/details.aspx?id=48260" target="_blank" rel="external">https://www.microsoft.com/zh-cn/download/details.aspx?id=48260</a></p>
<p>参考：<a href="http://m.blog.csdn.net/article/details?id=41447989" target="_blank" rel="external">http://m.blog.csdn.net/article/details?id=41447989</a></p>
<p>安装完TFS后按提示简单配置之后就可以使用了，Web管理界面是：<strong>localhost:8080</strong></p>
<hr>
<h1 id="计划备份"><a href="#计划备份" class="headerlink" title="计划备份"></a>计划备份</h1><p>强烈建议大家用TFS自带的备份功能进行备份，用Windows做服务器翻车只是迟早的问题，没有备份后悔都来不及。</p>
<p>设置计划备份时如果报错，使用的Administrator用户，依然提示：“网络路径没有权限”之类的，这个不知道什么原因，死活解决不了，用普通账户（有读写那个网络共享文件夹的权限）就能正常使用了。</p>
<hr>
<h1 id="异地迁移"><a href="#异地迁移" class="headerlink" title="异地迁移"></a>异地迁移</h1><p>难免服务器出现问题或者需要数据迁移，在源服务器遭病毒破坏无法使用时，要在新的服务器上重新部署，在安装好TFS和SQL Server之后，直接用TFS还原在异地备份的数据（这种方法会出现一些棘手的问题，不知道还有没有更好的方法），恢复之后发现无法登陆，要修改服务器主机名和源服务器的主机名一样（貌似是要校验源主机名的）。</p>
<p>重启之后应该是只可以用win管理员administrator登陆的；其他用户都无法登陆，这时在全局权限里的管理员组添加用户就能登陆了；但是这样每一个人都可以看到所有的项目，他本身的项目是已经打了勾的了，这个是来自于第二层的权限认证。目前我还没有找到怎么让普通用户能登陆的办法。</p>
<p>接着在VS中连接TFS服务器（一般是没什么的问题的），但是，如果你在使用源TFS后，你自己的电脑的主机名改过了；之后源TFS出了问题才还原到新主机上的；发现会提示“创建工作区映射”，这是因为数据库中的主机名多对应的工作空间和你当前主机名不同，无法确保是不是同一个项目。这时就随便映射一下新的工作空间，然后在数据库中查询改主机名，可以看到有一个计算机的ID（复制下来），把新的记录删掉，把ID替换掉旧的，VS就可以映射原来的工作空间了。</p>
<p>这里不得不吐槽TFS是奇葩的存在，虽然我第一次用TFS，安装是很简单，但是各种设置简直奇葩再奇葩，遇到问题，基本找不到资料；官方的问题完全就是敷衍式骗好评的网页；根本解决不了问题；需要有极大的耐心来解决。貌似所有项目是共用一个版本库的，自己没有自己的代码历史版本，只有全局的版本，差git十万八千里（为什么这么说呢，等服务器宕机一次你就明白有多难整了），原理有点像SVN，一旦宕机其他人就完全没法工作了。一大帮开发人员围着你问什么时候弄好@_@~,那简直想死的心都有了。</p>
<p>留一些网址，有空的时候研究一下：<br><a href="https://support.microsoft.com/zh-cn/help/909264/naming-conventions-in-active-directory-for-computers-domains-sites-and-ous" target="_blank" rel="external">https://support.microsoft.com/zh-cn/help/909264/naming-conventions-in-active-directory-for-computers-domains-sites-and-ous</a><br><a href="https://msdn.microsoft.com/zh-cn/library/ms252458(d=printer).aspx" target="_blank" rel="external">https://msdn.microsoft.com/zh-cn/library/ms252458(d=printer).aspx</a><br><a href="https://msdn.microsoft.com/zh-cn/library/ms404869.aspx" target="_blank" rel="external">https://msdn.microsoft.com/zh-cn/library/ms404869.aspx</a><br><a href="https://msdn.microsoft.com/zh-cn/library/ms404883.aspx?f=255&amp;MSPPError=-2147217396" target="_blank" rel="external">https://msdn.microsoft.com/zh-cn/library/ms404883.aspx?f=255&amp;MSPPError=-2147217396</a><br><a href="https://msdn.microsoft.com/zh-cn/library/vs/alm/jj620932" target="_blank" rel="external">https://msdn.microsoft.com/zh-cn/library/vs/alm/jj620932</a><br><a href="http://developer.51cto.com/art/201010/229066.htm" target="_blank" rel="external">http://developer.51cto.com/art/201010/229066.htm</a><br><a href="http://blog.csdn.net/hrabeyond/article/details/7324611" target="_blank" rel="external">http://blog.csdn.net/hrabeyond/article/details/7324611</a></p>
<hr>
]]></content>
    
    <summary type="html">
    
      &lt;script src=&quot;/assets/js/DPlayer.min.js&quot;&gt; &lt;/script&gt;&lt;script src=&quot;/assets/js/APlayer.min.js&quot;&gt; &lt;/script&gt;&lt;p&gt;TFS（Team Foundation Server）是一种代码管理工具，
    
    </summary>
    
      <category term="环境搭建" scheme="https://www.leolan.top/categories/%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/"/>
    
    
      <category term="TFS代码管理" scheme="https://www.leolan.top/tags/TFS%E4%BB%A3%E7%A0%81%E7%AE%A1%E7%90%86/"/>
    
  </entry>
  
  <entry>
    <title>邮件服务器、第三方邮件服务</title>
    <link href="https://www.leolan.top/posts/26298/"/>
    <id>https://www.leolan.top/posts/26298/</id>
    <published>2017-04-08T04:16:50.000Z</published>
    <updated>2018-10-08T07:11:51.127Z</updated>
    
    <content type="html"><![CDATA[<script src="/assets/js/DPlayer.min.js"> </script><script src="/assets/js/APlayer.min.js"> </script><h1 id="域名解析"><a href="#域名解析" class="headerlink" title="域名解析"></a>域名解析</h1><h2 id="第三方接管域名"><a href="#第三方接管域名" class="headerlink" title="第三方接管域名"></a>第三方接管域名</h2><p><strong>这种情况适合域名由第三方接管的情况下。</strong><br><img src="http://ofyfogrgx.bkt.clouddn.com/youjianjiexi.png" alt=""><br>目前的设置是这样的，就是MX记录指向<strong>mail.域名</strong>，最后通过A记录指向IP。这种情况下访问<strong>mail.域名</strong>也会跳转到IP:80的网站上。<br>@ ---》MX ---》mail.域名<br>mail ---》A ---》IP</p>
<hr>
<h2 id="域名未被第三方接管"><a href="#域名未被第三方接管" class="headerlink" title="域名未被第三方接管"></a>域名未被第三方接管</h2><p><strong>这种情况(域名在原营运商的DNS下[没有被第三方DNS接管的情况下])</strong>：<br>第三方DNS接管之后，即使没有开启<strong>mail.域名</strong>的解析也会被解析到DNS的主服务器上，导致发送到该邮件地址时导向到了DNS的服务器IP上，找不到邮件服务器的IP，于是变成了退信，无法接收。<br><img src="http://ofyfogrgx.bkt.clouddn.com/%E9%82%AE%E4%BB%B6%E8%A7%A3%E6%9E%902.png" alt=""><br>这种情况下<strong>有@ —》A记录指向了IP</strong>则不需要<strong>mail —》A记录指向了IP</strong>如果域名已经备案过了，可以设置<strong>隐性跳转</strong>（看图红字）；这访问<strong>mail.域名</strong>时就能打开网页版的邮箱。</p>
<p>域名后面的点是自动加的，不同的DNS解析方式不同，有的会自动加点，有的不会，没有影响。</p>
<hr>
<p>TXT记录一般用来做反垃圾邮件，格式有很多种：</p>
<ul>
<li>“v=spf1 include:spf.mail.域名 ~all”</li>
<li>“v=spf1 ip4:邮件服务器的IP ~all”</li>
</ul>
<hr>
<h2 id="DNS反向解析（PTR）"><a href="#DNS反向解析（PTR）" class="headerlink" title="DNS反向解析（PTR）"></a>DNS反向解析（PTR）</h2><p>解析测试：<a href="https://mxtoolbox.com/SuperTool.aspx" target="_blank" rel="external">https://mxtoolbox.com/SuperTool.aspx</a><br>输入邮件服务器的域名检测<br><img src="http://ofyfogrgx.bkt.clouddn.com/image/20170413/155031547.png" alt="mark"><br>如果是没有设置DNS反向解析，有些邮件服务器是不接受没有PTR的邮件的，会拒收，导致无法发送给对方，也会导致部分邮件丢件。</p>
<p>这时需要联系ISP（提供公网固定IP的服务商），叫他们添加DNS反向解析，把邮件服务器IP，指向到你的邮件域名。如果ISP无法帮你设置，在<strong>群晖Synology</strong>中可以把网线直连NAS，不要经过路由，在NAS中获取IP，然后搭建DNS服务器。在<strong>Win_Server</strong>中也可以添加DNS服务器后添加反向解析，具体方法请自行搜索。</p>
<hr>
<h2 id="域名解析测试验证"><a href="#域名解析测试验证" class="headerlink" title="域名解析测试验证"></a>域名解析测试验证</h2><p>win中用nslookup测试：<a href="http://jingyan.baidu.com/article/ce09321b2bae742bfe858f59.html" target="_blank" rel="external">http://jingyan.baidu.com/article/ce09321b2bae742bfe858f59.html</a><br>只要符合<strong>@ ---》MX ---》mail.域名 ---》A ---》IP</strong>这样的话应该是正确的，能够正常收发邮件。</p>
<p><a href="http://www.cnblogs.com/moonvan/archive/2010/08/24/1807003.html" target="_blank" rel="external">http://www.cnblogs.com/moonvan/archive/2010/08/24/1807003.html</a><br><a href="http://www.docin.com/p-580267583.html" target="_blank" rel="external">http://www.docin.com/p-580267583.html</a></p>
<hr>
<h1 id="邮件服务器的搭建"><a href="#邮件服务器的搭建" class="headerlink" title="邮件服务器的搭建"></a>邮件服务器的搭建</h1><p>一定要注意路由的端口转发有没有开启<br><strong>邮件服务的端口</strong>：<br>SMTP(发):25 　　SSL:465　　TLS:587<br>IMAP(收):143　　SSL:993<br>POP3(收):110　　SSL:995</p>
<hr>
<h1 id="群晖DSM搭建邮件服务器"><a href="#群晖DSM搭建邮件服务器" class="headerlink" title="群晖DSM搭建邮件服务器"></a>群晖DSM搭建邮件服务器</h1><p>群晖里自带了邮件服务器的套件，安装之后简单设置就可以使用了。<br><img src="http://ofyfogrgx.bkt.clouddn.com/1111132435363.png" alt=""><br>主机名（FQDN）:填域名就行，最后的邮件地址就是：<strong>user_name@域名</strong>；如果填的是<strong>mail.域名</strong>，则最后得到的邮件地址是：<strong>user_name@mail.域名</strong></p>
<ul>
<li>IMAP/POP3 功能全部开启。</li>
<li>控制面板中安全性中最好开启<strong>自动封锁</strong>（邮件服务器很容易遭受攻击）</li>
<li>控制面板安全性中默认没有开启防火墙的，如果需要路由的端口转发的话即使不开防火墙也是比较安全的（云服务器默认是开启全部端口，这时就需要防火墙来保护了）。</li>
<li>设置完成后，记得设置端口转发，在win下用<code>telnet “IP” “port”</code>测试是否能通。</li>
</ul>
<p><strong>邮件客户端</strong>：</p>
<ul>
<li>网页版的做好把80端口映射到群晖的80端口，这个访问web版的mail就可以直接使用：<strong>http(s)://IP/mail</strong> 就能访问，登录账号密码就是系统中设置的用户的账户密码（不是用邮件地址登录）</li>
<li>第三方邮件客户端登录时看清是邮件地址还是账户，邮件地址是：<strong>user_name@域名</strong> 用户：user_name 密码：user_passwd<br>地址是：<strong>smtp.域名、imap.域名、pop3.域名</strong>   对应的的端口看你是不是用SSL。</li>
</ul>
<hr>
<h1 id="Windsws-Server搭建邮件服务器"><a href="#Windsws-Server搭建邮件服务器" class="headerlink" title="Windsws_Server搭建邮件服务器"></a>Windsws_Server搭建邮件服务器</h1><p>不建议使用什么破解版的邮件服务器软件（免费版的还是可以的免费版不是破解版），非常不安全。预算充足的话可以考虑收费的服务。</p>
<p><font color="#A52A2A">看参考，但不要一步一步设置，全部看完再设置。</font><strong>参考</strong>：<br><a href="http://liujb.blog.51cto.com/269257/1784870" target="_blank" rel="external">http://liujb.blog.51cto.com/269257/1784870</a><br><a href="http://www.2cto.com/os/201604/498893.html" target="_blank" rel="external">http://www.2cto.com/os/201604/498893.html</a><br><a href="http://www.mamicode.com/info-detail-1370549.html" target="_blank" rel="external">http://www.mamicode.com/info-detail-1370549.html</a><br><a href="http://www.360doc.com/content/09/0924/12/32573_6370328.shtml" target="_blank" rel="external">http://www.360doc.com/content/09/0924/12/32573_6370328.shtml</a><br><a href="https://msdn.microsoft.com/zh-cn/library/dn292550.aspx" target="_blank" rel="external">https://msdn.microsoft.com/zh-cn/library/dn292550.aspx</a></p>
<p><img src="http://ofyfogrgx.bkt.clouddn.com/image/20170410/130228027.png" alt="mark"><br><img src="http://ofyfogrgx.bkt.clouddn.com/image/20170410/130242002.png" alt="mark"><br><img src="http://ofyfogrgx.bkt.clouddn.com/image/20170410/130253217.png" alt="mark"><br><img src="http://ofyfogrgx.bkt.clouddn.com/image/20170410/130301361.png" alt="mark"><br><img src="http://ofyfogrgx.bkt.clouddn.com/image/20170410/130308602.png" alt="mark"><br><img src="http://ofyfogrgx.bkt.clouddn.com/image/20170410/130315954.png" alt="mark"><br><img src="http://ofyfogrgx.bkt.clouddn.com/image/20170410/130322970.png" alt="mark"><br><img src="http://ofyfogrgx.bkt.clouddn.com/image/20170410/130330673.png" alt="mark"><br><img src="http://ofyfogrgx.bkt.clouddn.com/image/20170410/130338673.png" alt="mark"></p>
<hr>
<h2 id="测试SMTP-包括中继模式）"><a href="#测试SMTP-包括中继模式）" class="headerlink" title="测试SMTP(包括中继模式）"></a>测试SMTP(包括中继模式）</h2><ul>
<li><p>创建一个txt文档，如名为email.txt，内容如下：</p>
<figure class="highlight less"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="attribute">FROM</span>:mail.travelwebsite<span class="variable">@travelwebsite</span>.com     #发件箱必须为你在邮件服务器上设置的那个账户，否则没有权限发送</div><div class="line"><span class="attribute">TO</span>:<span class="number">842632422</span><span class="variable">@qq</span>.com</div><div class="line"><span class="attribute">SUBJECT</span>: Test email from SMTP</div><div class="line">This is a test email sent from my SMTP server</div><div class="line"></div><div class="line">[上面要空一行，不然邮件的内容会变成标题]这里是body，邮件内容</div></pre></td></tr></table></figure>
</li>
<li><p>将email.txt复制到如下路径<strong>c:\inetpub\mailroot\pickup</strong>(SMTP的默认目录)</p>
</li>
</ul>
<p>关于报错：<a href="https://torontoprogrammer.ca/2011/04/fixing-the-cannot-get-iis-pickup-directory-error-in-asp-net/" target="_blank" rel="external">IIS 拾取目录</a></p>
<p>windows测试工具：<br><a href="http://ofyfogrgx.bkt.clouddn.com/image/20170413/170002671.exe" target="_blank" rel="external">http://ofyfogrgx.bkt.clouddn.com/image/20170413/170002671.exe</a><br><a href="http://ofyfogrgx.bkt.clouddn.com/image/20170413/170020980.exe" target="_blank" rel="external">http://ofyfogrgx.bkt.clouddn.com/image/20170413/170020980.exe</a></p>
<p>Windows下通过程序实现SMTP发送邮件（本人未测试）：<a href="http://www.jianshu.com/p/5005a8642103" target="_blank" rel="external">http://www.jianshu.com/p/5005a8642103</a></p>
<hr>
<h2 id="Win中免费的邮件系统"><a href="#Win中免费的邮件系统" class="headerlink" title="Win中免费的邮件系统"></a>Win中免费的邮件系统</h2><p><a href="https://www.hmailserver.org/" target="_blank" rel="external">https://www.hmailserver.org/</a><br><a href="https://macallan-mail-solution.en.softonic.com/" target="_blank" rel="external">https://macallan-mail-solution.en.softonic.com/</a><br><a href="http://download.cnet.com/ArGoSoft-Mail-Server-Freeware/3000-2369_4-10038331.html" target="_blank" rel="external">http://download.cnet.com/ArGoSoft-Mail-Server-Freeware/3000-2369_4-10038331.html</a><br><a href="http://www.exchangecn.com/exchange2016" target="_blank" rel="external">http://www.exchangecn.com/exchange2016</a></p>
<hr>
<hr>
<h1 id="Linux搭建邮件服务器"><a href="#Linux搭建邮件服务器" class="headerlink" title="Linux搭建邮件服务器"></a>Linux搭建邮件服务器</h1><p><font color="#A52A2A">待整理(还未完成)：</font><br><a href="http://www.cnblogs.com/llius/p/5076235.html?utm_source=tuicool&amp;utm_medium=referral" target="_blank" rel="external">http://www.cnblogs.com/llius/p/5076235.html?utm_source=tuicool&amp;utm_medium=referral</a><br><a href="https://www.freehao123.com/iredmail/" target="_blank" rel="external">https://www.freehao123.com/iredmail/</a><br><a href="http://rfyiamcool.blog.51cto.com/1030776/948744/" target="_blank" rel="external">http://rfyiamcool.blog.51cto.com/1030776/948744/</a><br><a href="http://www.ilanni.com/?cat=936" target="_blank" rel="external">http://www.ilanni.com/?cat=936</a></p>
<p>centos7邮件：<a href="https://www.fancycoding.com/centos7-mail-server-with-dovecot-postfix-ssl/" target="_blank" rel="external">https://www.fancycoding.com/centos7-mail-server-with-dovecot-postfix-ssl/</a></p>
<hr>
<h1 id="第三方邮件服务（企业）"><a href="#第三方邮件服务（企业）" class="headerlink" title="第三方邮件服务（企业）"></a>第三方邮件服务（企业）</h1><h2 id="Office365"><a href="#Office365" class="headerlink" title="Office365"></a>Office365</h2><p>购买了账号后可以填写到自己的邮件服务器中，用作STMP，IMAP，POP3等中继，这样不用设置域名，证书等等，原理就是把自己的服务器转变为客户端一样去链接微软的服务器。</p>
<p>POP设置（接收）<br>服务器名称: outlook.office365.com<br>端口: 995<br>加密方法: TLS</p>
<p>IMAP设置（接收）<br>服务器名称: outlook.office365.com<br>端口: 993<br>加密方法: TLS</p>
<p>SMTP设置（发送）<br>服务器名称: smtp.office365.com<br>端口: 587<br>加密方法: STARTTLS    （也是可以用TLS加密的）</p>
<hr>
]]></content>
    
    <summary type="html">
    
      &lt;script src=&quot;/assets/js/DPlayer.min.js&quot;&gt; &lt;/script&gt;&lt;script src=&quot;/assets/js/APlayer.min.js&quot;&gt; &lt;/script&gt;&lt;h1 id=&quot;域名解析&quot;&gt;&lt;a href=&quot;#域名解析&quot; class=&quot;hea
    
    </summary>
    
      <category term="环境搭建" scheme="https://www.leolan.top/categories/%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/"/>
    
    
      <category term="邮件服务器" scheme="https://www.leolan.top/tags/%E9%82%AE%E4%BB%B6%E6%9C%8D%E5%8A%A1%E5%99%A8/"/>
    
  </entry>
  
  <entry>
    <title>珠海迈科笔记</title>
    <link href="https://www.leolan.top/posts/57404/"/>
    <id>https://www.leolan.top/posts/57404/</id>
    <published>2017-04-08T02:57:23.000Z</published>
    <updated>2017-04-10T01:54:46.412Z</updated>
    
    <content type="html"><![CDATA[<script src="/assets/js/DPlayer.min.js"> </script><script src="/assets/js/APlayer.min.js"> </script><p>强迫症犯了，陈列在笔记中，于是弄成笔记保存。</p>
<h1 id="MK服务器搭建，常用命令"><a href="#MK服务器搭建，常用命令" class="headerlink" title="MK服务器搭建，常用命令"></a>MK服务器搭建，常用命令</h1><hr>
<h2 id="centos6-X及以下版本"><a href="#centos6-X及以下版本" class="headerlink" title="centos6.X及以下版本"></a>centos6.X及以下版本</h2><p><strong>网卡配置</strong><br><code>vi /etc/sysconfig/network-scripts/ifcfg-eth0</code>      编辑配置文件,添加修改以下内容<br>双网不要配内网网关<br>联通公网：<br><figure class="highlight ini"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="attr">DEVICE</span>=eth0</div><div class="line"><span class="attr">BOOTPROTO</span>=static</div><div class="line"><span class="attr">ONBOOT</span>=<span class="literal">yes</span></div><div class="line"><span class="attr">IPADDR</span>=<span class="number">221</span>.X.XXX.<span class="number">114</span></div><div class="line"><span class="attr">NETMASK</span>=<span class="number">255.255</span>.<span class="number">255.224</span>  </div><div class="line"><span class="attr">GATEWAY</span>=<span class="number">221</span>.X.XXX.<span class="number">97</span></div><div class="line"><span class="attr">DNS1</span>=<span class="number">221</span>.X.XX.<span class="number">88</span></div><div class="line"><span class="attr">DNS2</span>=<span class="number">8.8</span>.<span class="number">8.8</span></div></pre></td></tr></table></figure></p>
<p>内网：<br><figure class="highlight lsl"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">vi /etc/sysconfig/network-scripts/ifcfg-eth1</div><div class="line">DEVICE=eth1</div><div class="line">BOOTPROTO=static</div><div class="line">ONBOOT=yes</div><div class="line">IPADDR=<span class="number">192.168</span><span class="number">.0</span><span class="number">.114</span></div><div class="line">NETMASK=<span class="number">255.255</span><span class="number">.252</span><span class="number">.0</span>  </div><div class="line">GATEWAY=<span class="number">192.168</span><span class="number">.0</span><span class="number">.1</span></div><div class="line">#DNS1=<span class="number">221.</span>X.XX<span class="number">.88</span></div><div class="line">#DNS2=<span class="number">8.8</span><span class="number">.8</span><span class="number">.8</span>   （公网配了DNS和网关了）</div></pre></td></tr></table></figure></p>
<p>修改DNS也可以<br><figure class="highlight lsl"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">vim /etc/resolv.conf</div><div class="line">nameserver <span class="number">221.</span>X.XX<span class="number">.88</span></div><div class="line">nameserver <span class="number">8.8</span><span class="number">.8</span><span class="number">.8</span></div><div class="line">IPV6INIT=no #禁止IPV6</div></pre></td></tr></table></figure></p>
<p>:wq! #保存退出</p>
<figure class="highlight vbnet"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">service ip6tables <span class="keyword">stop</span> <span class="meta">#停止IPV6服务</span></div><div class="line">chkconfig ip6tables <span class="keyword">off</span> <span class="meta">#禁止IPV6开机启动</span></div><div class="line">service yum-updatesd <span class="keyword">stop</span> <span class="meta">#关闭系统自动更新</span></div><div class="line">chkconfig yum-updatesd <span class="keyword">off</span> <span class="meta">#禁止开启启动</span></div><div class="line">service network restart <span class="meta">#重启网络连接</span></div><div class="line">ifconfig <span class="meta">#查看IP地址</span></div></pre></td></tr></table></figure>
<p>设置主机名<br><figure class="highlight lisp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">vi /etc/sysconfig/network (<span class="name">CentOS</span>)</div><div class="line">vi /etc/hosts</div><div class="line">hostname newname    #(<span class="name">newname</span>就是你要改的主机名)</div></pre></td></tr></table></figure></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">service network restart  或  /etc/network restart</div><div class="line">yum <span class="keyword">install</span> wget lrzsz -y</div><div class="line">service sshd <span class="keyword">start</span></div><div class="line">chkconfig sshd <span class="keyword">on</span></div><div class="line"><span class="keyword">shutdown</span> -r <span class="keyword">now</span> #重启系统</div></pre></td></tr></table></figure>
<hr>
<h2 id="Ubuntu14-04及以上版本"><a href="#Ubuntu14-04及以上版本" class="headerlink" title="Ubuntu14.04及以上版本"></a>Ubuntu14.04及以上版本</h2><p>新安装的Ubuntu如果没有root用户密码，用<code>sudo passwd root</code>设置root密码。<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">apt-get <span class="keyword">install</span> wget lrzsz openssh-<span class="keyword">server</span> vim -y</div><div class="line">/etc/init.d/ssh <span class="keyword">start</span></div></pre></td></tr></table></figure></p>
<p><strong>配置文件etc/ssh/sshd_config</strong><br>将 <strong>/etc/ssh/sshd_confg中PermitRootLogin  no 改为yes</strong>，重新启动ssh服务<code>service sshd restart</code><br>最重要的一点是Ubuntu超级用户root用户被禁用掉了，这就是为什么我们登陆时只能以普通用户登陆，而且switch user时没有root选项。<br>必须使用命令启动root。即输入：sudo  passwd。然后输入密码即可启动root。</p>
<p>网卡地址配置<br>Ubuntu的网络配置文件是：<code>/etc/network/interfaces</code></p>
<p>1、为网卡配置静态IP地址<br><code>sudo vi /etc/network/interfaces</code><br>双网不要配内网网关<br><figure class="highlight stylus"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="attribute">auto</span> lo</div><div class="line">iface lo inet loopback</div><div class="line">#ifconfig看到eth0用作公网</div><div class="line"><span class="attribute">auto</span> eth0   （有的可能是eno0或eno1）</div><div class="line">iface eth0 inet static</div><div class="line"><span class="selector-tag">address</span> <span class="number">221</span><span class="selector-class">.X</span><span class="selector-class">.XXX</span>.<span class="number">114</span></div><div class="line">gateway <span class="number">221</span><span class="selector-class">.X</span><span class="selector-class">.XXX</span>.<span class="number">97</span></div><div class="line">netmask <span class="number">255.255</span>.<span class="number">255.224</span></div><div class="line">dns-nameservers <span class="number">221</span><span class="selector-class">.X</span><span class="selector-class">.XX</span>.<span class="number">88</span></div><div class="line">dns-nameservers <span class="number">8.8</span>.<span class="number">8.8</span></div><div class="line"><span class="attribute">auto</span> eth1</div><div class="line">iface eth1 inet static</div><div class="line"><span class="selector-tag">address</span> <span class="number">192.168</span>.<span class="number">0.254</span></div><div class="line">netmask <span class="number">255.255</span>.<span class="number">252.0</span></div><div class="line"><span class="selector-id">#gateway</span> <span class="number">192.168</span>.<span class="number">0.1</span></div><div class="line">:wq 保存退出</div><div class="line">/etc/init.d/networking restart</div></pre></td></tr></table></figure></p>
<p>2、以DHCP 方式配置网卡<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">auto</span> eth0</div><div class="line">iface eth0 inet dhcp</div></pre></td></tr></table></figure></p>
<p>用<code>/etc/init.d/networking restart</code>命令使网络设置生效</p>
<p>修改DNS服务器<br>法一<br><figure class="highlight lsl"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">vi /etc/network/interfaces</div><div class="line">dns-nameservers <span class="number">8.8</span><span class="number">.8</span><span class="number">.8</span></div></pre></td></tr></table></figure></p>
<p>法二<br><figure class="highlight stylus"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">vi /etc/resolvconf/resolv<span class="selector-class">.conf</span><span class="selector-class">.d</span>/head    #重启后生效，重启不失效</div><div class="line">resolvconf -u</div><div class="line">iptables -A INPUT -<span class="selector-tag">p</span> tcp -<span class="selector-tag">i</span> eth0 --dport <span class="number">22</span> -j ACCEPT</div></pre></td></tr></table></figure></p>
<p>修改主机名<br><figure class="highlight vim"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">vi</span> /etc/<span class="built_in">hostname</span>(Ubuntu)</div><div class="line"><span class="keyword">vi</span> /etc/hosts</div><div class="line"><span class="built_in">hostname</span> newname   #newname就是你要改的主机名</div></pre></td></tr></table></figure></p>
<p><code>/etc/init.d/networking restart</code></p>
<p><code>shutdown -r now</code>   重启系统</p>
<hr>
<h1 id="Ubuntu-系统版本升级（如从16-04升到16-10）"><a href="#Ubuntu-系统版本升级（如从16-04升到16-10）" class="headerlink" title="Ubuntu 系统版本升级（如从16.04升到16.10）"></a>Ubuntu 系统版本升级（如从16.04升到16.10）</h1><p>Canonical 已经提供了一个直接升级的方法，非常快捷容易。适用于：Kubuntu、 Xubuntu、 Lubuntu、 Ubuntu GNOME、 Ubuntu Mate。<br>首先更新一下系统：<br><figure class="highlight processing"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">sudo apt-<span class="built_in">get</span> update</div><div class="line">sudo apt-<span class="built_in">get</span> <span class="built_in">dist</span>-upgrade</div></pre></td></tr></table></figure></p>
<p>接下来，需要安装更新管理器的核心：<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">sudo apt-get <span class="keyword">install</span> <span class="keyword">update</span>-manager-core  </div><div class="line">sudo <span class="keyword">do</span>-<span class="keyword">release</span>-<span class="keyword">upgrade</span> -d  或  sudo <span class="keyword">update</span>-manager -d</div></pre></td></tr></table></figure></p>
<p>注：<strong>d-release-upgrade</strong> 命令是帮助我们寻找最新的稳定版本，而 <strong>-d</strong> 参数意思是包括非稳定版本。</p>
<hr>
<hr>
<h1 id="浙江服务器（20160910）"><a href="#浙江服务器（20160910）" class="headerlink" title="浙江服务器（20160910）"></a>浙江服务器（20160910）</h1><p><strong>现在可能已经变了，仅仅只是当时的情况。</strong></p>
<p>例：<br>192.168.0.99   采集服务器</p>
<p>192.168.0.233  安装有hls和lts</p>
<p>192.168.0.234  安装有lts</p>
<p>192.168.0.236  安装有lts</p>
<p>192.168.0.234或192.168.0.236的转码来源可以来自装有hls的192.168.0.233，也可以直接来自其他服务器，</p>
<p>在3台服务器lts源直接填写其他服务器，转码（来源转H265）任务平均分配到192.168.0.234和192.168.0.236上，每台转7个节目，输出udp://127.0.0.1:xxxx/TVxxx   但是，192.168.0.234和192.168.0.236上的输出不能填写udp://127.0.0.1:xxxx/TVxxx 而应该是udp://192.168.0.233:xxxx/TVxxx(必须输出到装有hls模块的机子上，然后在192.168.0.233上才能获取的到)<br>此时在192.168.0.233上才能把3台服务器转出来的作为节目推送出去，同时也能作为源输入进行转H264</p>
<hr>
<hr>
<h1 id="zibibx监控（自定义的文件配置）"><a href="#zibibx监控（自定义的文件配置）" class="headerlink" title="zibibx监控（自定义的文件配置）"></a>zibibx监控（自定义的文件配置）</h1><h2 id="转码节目的监控"><a href="#转码节目的监控" class="headerlink" title="转码节目的监控"></a>转码节目的监控</h2><figure class="highlight awk"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">cd <span class="regexp">/opt/</span>starview<span class="regexp">/cdn/</span>lts<span class="regexp">/cfg/</span>channels<span class="regexp">/</span></div></pre></td></tr></table></figure>
<p>会根据这个目录下的文件来查找进程，如果有没有这个进程就报警（这些文件是由lts模块下发时生成的）</p>
<hr>
<h2 id="采集卡监控"><a href="#采集卡监控" class="headerlink" title="采集卡监控"></a>采集卡监控</h2><p>具体监控那些卡在<strong>/media/caiji</strong> 文件里写明</p>
<hr>
<hr>
<h1 id="采集服务器搭建"><a href="#采集服务器搭建" class="headerlink" title="采集服务器搭建"></a>采集服务器搭建</h1><h2 id="MuMuDVB安装"><a href="#MuMuDVB安装" class="headerlink" title="MuMuDVB安装"></a>MuMuDVB安装</h2><p>MuMuDVB安装:</p>
<ol>
<li><p>安装libdvbcsa库：<br><code>svn co svn://svn.videolan.org/libdvbcsa/trunk libdvbcsa</code><br>或者：</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">wget http:<span class="comment">//download.videolan.org/pub/videolan/libdvbcsa/1.1.0/libdvbcsa-1.1.0.tar.gz</span></div><div class="line">tar -xvf libdvbcsa-<span class="number">1.1</span>.<span class="number">0</span><span class="selector-class">.tar</span><span class="selector-class">.gz</span></div><div class="line">cd libdvbcsa-<span class="number">1.1</span>.<span class="number">0</span></div><div class="line">./bootstrap</div><div class="line">./configure --prefix=/usr</div><div class="line">make</div><div class="line">make install</div></pre></td></tr></table></figure>
</li>
<li><p>mumudvb安装：</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">git clone gi<span class="variable">t:</span>//github.<span class="keyword">com</span>/braice/MuMuDVB.git</div><div class="line"><span class="keyword">cd</span> MuMuDVB</div><div class="line">apt-<span class="built_in">get</span> install autoconf</div><div class="line">autoreconf -i -<span class="keyword">f</span></div><div class="line">./configure --prefix=/usr --enable-cam-support --enable-scam-support</div><div class="line"><span class="keyword">make</span></div><div class="line"><span class="keyword">make</span> install</div></pre></td></tr></table></figure>
</li>
</ol>
<hr>
<h2 id="采集卡安装驱动"><a href="#采集卡安装驱动" class="headerlink" title="采集卡安装驱动"></a>采集卡安装驱动</h2><p>1.安装驱动及mumudvb所需的包：<br><figure class="highlight armasm"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="symbol">apt</span>-<span class="meta">get</span> install git <span class="keyword">subversion </span>make gcc libtool gettext dvb-apps unzip -y</div></pre></td></tr></table></figure></p>
<p>2.驱动安装：<br>首先去tbsdtv官网下载相应的linux版本驱动，网址：<br><a href="http://tbsdtv.com/download" target="_blank" rel="external">http://tbsdtv.com/download</a><br>现在用到的两款分别为：<br>TBS6985 DVB-S2 Quad Tuner PCIe Card [不用管卡是什么型号]<br>TBS6285 DVB-C  Quad Tuner PCIe Card</p>
<p>下载相应驱动,然后执行以下命令(以下载到的驱动文件名为tbs-linux-drivers_v140210.zip为例)：<br><figure class="highlight perl"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">unzip tbs-linux-drivers_v160126.zip -d ./tbs-linux-drivers_v160126</div><div class="line">cd tbs-linux-drivers_v160126</div><div class="line">tar xjvf linux-tbs-drivers.tar.bz2</div><div class="line">cd linux-tbs-drivers</div><div class="line"></div><div class="line">find . -type d -<span class="keyword">exec</span> <span class="keyword">chmod</span> u+wx <span class="string">'&#123;&#125;'</span> \;</div><div class="line">find . -name <span class="string">"*.sh"</span> -o -name <span class="string">"*.pl"</span> -<span class="keyword">exec</span> <span class="keyword">chmod</span> u+<span class="keyword">x</span> <span class="string">'&#123;&#125;'</span> \;</div><div class="line">./v4l/tbs-x86_64.sh</div><div class="line"></div><div class="line"><span class="comment">#[注：如果是TBS6285 DVBC的卡， 则需要另外执行命令： ./v4l/tbs-dvbc-x86_64.sh]</span></div><div class="line"></div><div class="line">make</div><div class="line">sudo make install</div></pre></td></tr></table></figure></p>
<p>重启电脑(必须重启驱动才能识别)：<br><code>shutdown -r now</code></p>
<p>然后执行：<code>dmesg | grep frontend</code></p>
<p>如果出现如下打印，则证明安装成功：<br><strong>如果是TBS6985 DVB-S2 Quad Tuner PCIe Card卡</strong>:<br>[    7.561200] DVB: registering adapter 0 frontend 0 (TurboSight TBS 6985 DVBS/S2 frontend)…<br>[    8.121858] DVB: registering adapter 1 frontend 0 (TurboSight TBS 6985 DVBS/S2 frontend)…<br><strong>如果是TBS6285 DVB-C Quad Tuner PCIe Card卡</strong>:<br>[   10.852763] DVB: registering adapter 0 frontend 0 (TurboSight TBS 62x1 DVBC frontend)…<br>[   13.178521] DVB: registering adapter 1 frontend 0 (TurboSight TBS 62x1 DVBC frontend)…<br>[<br>注:<br>如果不能看到如上打印, 则可执行以下命令：</p>
<figure class="highlight crystal"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">cd /<span class="class"><span class="keyword">lib</span>/<span class="title">modules</span>/(内核版本)/<span class="title">kernel</span>/<span class="title">drivers</span>/</span></div><div class="line"></div><div class="line">mv media media.bak</div></pre></td></tr></table></figure>
<p>本机的内核版本号，可执行命令:<code>uname -r</code><br>获取，如为:  3.13.0-48-generic, 则执行的语句为：<br><figure class="highlight crystal"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">cd /<span class="class"><span class="keyword">lib</span>/<span class="title">modules</span>/3.13.0-48-<span class="title">generic</span>/<span class="title">kernel</span>/<span class="title">drivers</span>/</span></div><div class="line">mv media media.bak]]</div><div class="line"></div><div class="line">make install</div><div class="line">shutdown -r now</div></pre></td></tr></table></figure></p>
<p>重新启动之后，再用上面的<code>dmesg | grep frontend</code>命令确认是否有正确的打印信息。</p>
<hr>
<h1 id="PowerVu安装"><a href="#PowerVu安装" class="headerlink" title="PowerVu安装"></a>PowerVu安装</h1><p>地址：<a href="http://ofyfogrgx.bkt.clouddn.com/PowerVu%E5%AE%89%E8%A3%85.zip" target="_blank" rel="external">PowerVu安装.zip</a>   密码：1087。。。 </p>
<hr>
<hr>
<h1 id="转码服务器搭建"><a href="#转码服务器搭建" class="headerlink" title="转码服务器搭建"></a>转码服务器搭建</h1><h2 id="显卡GPU驱动"><a href="#显卡GPU驱动" class="headerlink" title="显卡GPU驱动"></a>显卡GPU驱动</h2><h3 id="简版（自己整理）"><a href="#简版（自己整理）" class="headerlink" title="简版（自己整理）"></a>简版（自己整理）</h3><figure class="highlight lsl"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">cd /etc/modprobe.d/</div><div class="line">vim disable-nouveau.conf</div><div class="line"></div><div class="line">blacklist nouveau</div><div class="line">options nouveau modeset=<span class="number">0</span></div><div class="line"></div><div class="line">dracut --force</div><div class="line">cd /root</div><div class="line">chmod <span class="number">0777</span> ./cuda_7<span class="number">.5</span><span class="number">.18</span>_linux.run</div><div class="line">chmod <span class="number">0777</span> ./NVIDIA-Linux-x86_64<span class="number">-352.63</span>.run</div><div class="line">vim /etc/inittab     #改<span class="number">5</span>为<span class="number">3</span></div><div class="line"></div><div class="line">reboot</div><div class="line"></div><div class="line">./cuda_7<span class="number">.5</span><span class="number">.18</span>_linux.run             #（依赖库包）【当前目录为/root】</div><div class="line">./NVIDIA-Linux-x86_64<span class="number">-352.63</span>.run    #（最后有一个询问是否要安装X界面的，不用的可以不安装）</div></pre></td></tr></table></figure>
<hr>
<h3 id="详细版"><a href="#详细版" class="headerlink" title="详细版"></a>详细版</h3><h4 id="下载最新的nvidia官网驱动"><a href="#下载最新的nvidia官网驱动" class="headerlink" title="下载最新的nvidia官网驱动"></a>下载最新的nvidia官网驱动</h4><h4 id="禁用开源nouveau驱动"><a href="#禁用开源nouveau驱动" class="headerlink" title="禁用开源nouveau驱动:"></a>禁用开源nouveau驱动:</h4><p>在/etc/modprobe.d 下创建名为disable-nouveau.conf的文件， 内容为：<br><figure class="highlight apache"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="attribute">blacklist</span> nouveau</div><div class="line"><span class="attribute"><span class="nomarkup">options</span></span> nouveau modeset=0</div></pre></td></tr></table></figure></p>
<p><strong>ubuntu执行</strong>: <code>sudo update-initramfs -u</code> 使其生效。</p>
<p><strong>centos执行</strong>: <code>sudo dracut --force</code>      使其生效。</p>
<h4 id="ubuntu配置kernel以text模式启动："><a href="#ubuntu配置kernel以text模式启动：" class="headerlink" title="ubuntu配置kernel以text模式启动："></a>ubuntu配置kernel以text模式启动：</h4><p>修改/etc/default/grub文件：<br>将<strong>GRUB_CMDLINE_LINUX_DEFAULT=”quiet splash”</strong>行改为：<strong>GRUB_CMDLINE_LINUX_DEFAULT=”text”</strong><br>将<strong>GRUB_CMDLINE_LINUX=””</strong>行改为：<strong>GRUB_CMDLINE_LINUX=”rdblacklist=nouveau nouveau.modeset=0”</strong><br>执行: <code>sudo update-grub</code> 使其生效    </p>
<h4 id="centos配置kernel以text模式启动："><a href="#centos配置kernel以text模式启动：" class="headerlink" title="centos配置kernel以text模式启动："></a>centos配置kernel以text模式启动：</h4><p>修改/etc/inittab 将最后一行“<strong>id:5:initdefault:</strong>”修改成“<strong>id:3:initdefault:</strong>”（不包含引号）</p>
<h4 id="重启电脑，在text模式下，-终端中执行安装文件"><a href="#重启电脑，在text模式下，-终端中执行安装文件" class="headerlink" title="重启电脑，在text模式下， 终端中执行安装文件"></a>重启电脑，在text模式下， 终端中执行安装文件</h4><p><strong>centos</strong>:<code>sudo yum install gcc kernel-devel-$(uname -r) kernel-headers-$(uname -r)</code><br>（在XShell中直接通过<strong>chmod 777 </strong>将以下两个文件设为最高权限。通过<strong>./</strong>命令将两个脚本分别执行）</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">yum install kernel-devel<span class="selector-class">.x86_64</span> -y</div><div class="line">sudo ./cuda_7.<span class="number">5.18</span>_linux<span class="selector-class">.run</span></div><div class="line">sudo ./NVIDIA-Linux-x86_64-<span class="number">352.21</span>.run</div></pre></td></tr></table></figure>
<p>安装过程中交互的地方一直选择继续(Y)或者默认参数即可.</p>
<p><code>lspci |grep VGA</code>  查看显卡数量</p>
<h4 id="ubuntu-安装完成之后"><a href="#ubuntu-安装完成之后" class="headerlink" title="(ubuntu) 安装完成之后"></a>(ubuntu) 安装完成之后</h4><p>还原/etc/default/grub文件中的<strong>GRUB_CMDLINE_LINUX_DEFAULT</strong>行， 再执行<code>update-grub</code>，使重启后用图形模式进入系统 。</p>
<h4 id="centos-安装完成之后"><a href="#centos-安装完成之后" class="headerlink" title="(centos) 安装完成之后"></a>(centos) 安装完成之后</h4><p>修改/etc/inittab 将最后一行“<strong>id:3:initdefault:</strong>”修改成“<strong>id:5:initdefault:</strong>”（不包含引号），重启进入图形模式。</p>
<h4 id="检验："><a href="#检验：" class="headerlink" title="检验："></a>检验：</h4><p><code>nvidia-smi</code></p>
<hr>
<h1 id="内核升级和安装OTT"><a href="#内核升级和安装OTT" class="headerlink" title="内核升级和安装OTT"></a>内核升级和安装OTT</h1><h2 id="Linux内核升级"><a href="#Linux内核升级" class="headerlink" title="Linux内核升级"></a>Linux内核升级</h2><p>先安装显卡驱动再安装OTT（重要）<br>貌似Linux内核版本要高于3.0才能安装显卡驱动</p>
<p>内核升级：【内核版本 <a href="https://www.kernel.org/】" target="_blank" rel="external">https://www.kernel.org/】</a><br>参考<a href="http://blog.csdn.net/taiyang1987912/article/details/42744019" target="_blank" rel="external">http://blog.csdn.net/taiyang1987912/article/details/42744019</a><br><figure class="highlight stylus"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">yum install ncurses-devel -y</div><div class="line">yum install hmaccalc zlib-devel binutils-devel elfutils-libelf-devel -y</div><div class="line">wget  https:<span class="comment">//www.kernel.org/pub/linux/kernel/v3.x/linux-3.10.28.tar.xz     </span></div><div class="line">tar -xf linux-<span class="number">3.10</span>.<span class="number">28</span><span class="selector-class">.tar</span><span class="selector-class">.xz</span></div><div class="line">mv linux-<span class="number">3.10</span>.<span class="number">28</span> /usr/src/</div><div class="line">cd /usr/src/linux-<span class="number">3.10</span>.<span class="number">28</span>/</div><div class="line">cp /boot/config-<span class="number">2.6</span>.<span class="number">32</span>-<span class="number">573</span><span class="selector-class">.el6</span><span class="selector-class">.x86_64</span> <span class="selector-class">.config</span></div><div class="line">sh -c <span class="string">'yes "" | make oldconfig'</span></div><div class="line">make oldconfig</div></pre></td></tr></table></figure></p>
<p>cpu核数 <code>cat /proc/cpuinfo| grep &quot;processor&quot;| wc -l</code>   下面-j后面的48是cpu核数（指定编译核数）<br><figure class="highlight gauss"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">make</span> -j48 bzImage</div><div class="line"><span class="built_in">make</span> -j48 modules</div><div class="line"><span class="built_in">make</span> -j48 modules_install</div><div class="line"><span class="built_in">make</span> install</div></pre></td></tr></table></figure></p>
<p><code>vi /etc/grub.conf</code><br> 【看新安装的内核在第几段，一般是在第一段，从0开始数看title CentOS (3.10.28) 在第一段为default=0，第二段为default=1】<br>例如:<br><figure class="highlight lsl"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">#boot=/dev/sdb</div><div class="line"><span class="section">default</span>=<span class="number">0</span></div><div class="line">timeout=<span class="number">5</span></div><div class="line">splashimage=(hd0,<span class="number">0</span>)/grub/splash.xpm.gz</div><div class="line">hiddenmenu</div><div class="line">title CentOS (<span class="number">3.10</span><span class="number">.28</span>)</div><div class="line">        root (hd0,<span class="number">0</span>)</div><div class="line">        kernel /vmlinuz<span class="number">-3.10</span><span class="number">.28</span> ro root=UUID=<span class="number">28</span>fbaad8<span class="number">-35</span>a6<span class="number">-4348</span>-b1e0-bf204537f8b0 rd_NO_LUKS rd_NO_LVM LANG=en_US.UTF<span class="number">-8</span> rd_NO_MD SYSFONT=latarcyrheb-sun16 crashkernel=auto  KEYBOARDTYPE=pc KEYTABLE=us rd_NO_DM rhgb quiet</div><div class="line">        initrd /initramfs<span class="number">-3.10</span><span class="number">.28</span>.img</div><div class="line">title CentOS (<span class="number">2.6</span><span class="number">.32</span><span class="number">-642.3</span><span class="number">.1</span>.el6.x86_64)</div><div class="line">        root (hd0,<span class="number">0</span>)</div><div class="line">        kernel /vmlinuz<span class="number">-2.6</span><span class="number">.32</span><span class="number">-642.3</span><span class="number">.1</span>.el6.x86_64 ro root=UUID=<span class="number">28</span>fbaad8<span class="number">-35</span>a6<span class="number">-4348</span>-b1e0-bf204537f8b0 rd_NO_LUKS rd_NO_LVM LANG=en_US.UTF<span class="number">-8</span> rd_NO_MD SYSFONT=latarcyrheb-sun16 crashkernel=auto  KEYBOARDTYPE=pc KEYTABLE=us rd_NO_DM rhgb quiet</div><div class="line">        initrd /initramfs<span class="number">-2.6</span><span class="number">.32</span><span class="number">-642.3</span><span class="number">.1</span>.el6.x86_64.img</div><div class="line">title CentOS <span class="number">6</span> (<span class="number">2.6</span><span class="number">.32</span><span class="number">-573.</span>el6.x86_64)</div><div class="line">        root (hd0,<span class="number">0</span>)</div><div class="line">        kernel /vmlinuz<span class="number">-2.6</span><span class="number">.32</span><span class="number">-573.</span>el6.x86_64 ro root=UUID=<span class="number">28</span>fbaad8<span class="number">-35</span>a6<span class="number">-4348</span>-b1e0-bf204537f8b0 rd_NO_LUKS rd_NO_LVM LANG=en_US.UTF<span class="number">-8</span> rd_NO_MD SYSFONT=latarcyrheb-sun16 crashkernel=auto  KEYBOARDTYPE=pc KEYTABLE=us rd_NO_DM rhgb quiet</div><div class="line">        initrd /initramfs<span class="number">-2.6</span><span class="number">.32</span><span class="number">-573.</span>el6.x86_64.img</div></pre></td></tr></table></figure></p>
<p>改好后<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">uname -r    #查看内核版本</div></pre></td></tr></table></figure></p>
<hr>
<h2 id="安装OTT"><a href="#安装OTT" class="headerlink" title="安装OTT"></a>安装OTT</h2><figure class="highlight vim"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">cd</span> /<span class="keyword">opt</span>/</div><div class="line">rm -rf emailhtml/ nginx/ rh/ starview/</div><div class="line"></div><div class="line"><span class="keyword">cd</span> /<span class="keyword">opt</span>/upgrade/</div><div class="line">tar -Pzxvf common_tools.tar.gz</div><div class="line"><span class="keyword">cd</span> /<span class="keyword">opt</span>/starview/tools/install/</div><div class="line">./install.<span class="keyword">sh</span></div><div class="line"><span class="keyword">cd</span> /<span class="keyword">opt</span>/starview/cdn/</div><div class="line">./get_host_info</div><div class="line"><span class="keyword">cd</span> /<span class="keyword">opt</span>/starview/boss/cms/bin/</div><div class="line">./shutdown.<span class="keyword">sh</span></div><div class="line">./startup.<span class="keyword">sh</span></div><div class="line"><span class="keyword">cd</span> /<span class="keyword">opt</span>/starview/cdn/hls/bin/</div><div class="line">./shutdown.<span class="keyword">sh</span></div><div class="line">./startup.<span class="keyword">sh</span></div><div class="line"><span class="keyword">cd</span> /<span class="keyword">opt</span>/starview/cdn/lts/bin/</div><div class="line">./shutdown.<span class="keyword">sh</span></div><div class="line">./startup.<span class="keyword">sh</span></div></pre></td></tr></table></figure>
<hr>
<hr>
]]></content>
    
    <summary type="html">
    
      &lt;script src=&quot;/assets/js/DPlayer.min.js&quot;&gt; &lt;/script&gt;&lt;script src=&quot;/assets/js/APlayer.min.js&quot;&gt; &lt;/script&gt;&lt;p&gt;强迫症犯了，陈列在笔记中，于是弄成笔记保存。&lt;/p&gt;
&lt;h1 id=&quot;MK
    
    </summary>
    
      <category term="杂项" scheme="https://www.leolan.top/categories/%E6%9D%82%E9%A1%B9/"/>
    
    
      <category term="珠海迈科笔记" scheme="https://www.leolan.top/tags/%E7%8F%A0%E6%B5%B7%E8%BF%88%E7%A7%91%E7%AC%94%E8%AE%B0/"/>
    
  </entry>
  
  <entry>
    <title>Rsync</title>
    <link href="https://www.leolan.top/posts/55326/"/>
    <id>https://www.leolan.top/posts/55326/</id>
    <published>2017-03-18T15:35:41.000Z</published>
    <updated>2018-10-08T07:11:51.116Z</updated>
    
    <content type="html"><![CDATA[<script src="/assets/js/DPlayer.min.js"> </script><script src="/assets/js/APlayer.min.js"> </script><h1 id="搭建同步环境"><a href="#搭建同步环境" class="headerlink" title="搭建同步环境"></a>搭建同步环境</h1><h2 id="Windows"><a href="#Windows" class="headerlink" title="Windows"></a>Windows</h2><p>下载链接：<br>服务端：<a href="http://ofyfogrgx.bkt.clouddn.com/image/20170318/234212383.exe" target="_blank" rel="external">http://ofyfogrgx.bkt.clouddn.com/image/20170318/234212383.exe</a><br>客户端：<a href="http://ofyfogrgx.bkt.clouddn.com/image/20170318/234502534.exe" target="_blank" rel="external">http://ofyfogrgx.bkt.clouddn.com/image/20170318/234502534.exe</a></p>
<p>Windows上安装比较简单，直接安装服务端，设置账户密码时不要更改（更改后会认证失败），安装服务端后修改安装目录下的rsyncd.conf文件，增加：<br><figure class="highlight ini"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="attr">uid</span> = <span class="number">0</span></div><div class="line"><span class="attr">gid</span> = <span class="number">0</span></div></pre></td></tr></table></figure></p>
<p>安装客户端后要用绝对路径运行，增加了环境变量才能直接运行。</p>
<p>配置参考(配置文件不建议用上面的，在win中会导致各种问题，用默认的即可，排除文件可以参考)：<br><a href="http://www.jb51.net/article/59034.htm" target="_blank" rel="external">在Windows中配置Rsync同步文件的方法</a><br><a href="http://blog.csdn.net/lenovouser/article/details/48626371" target="_blank" rel="external">使用cwRsync实现windows下文件定时同步</a><br><a href="http://tech.huweishen.com/gongju/1617.html" target="_blank" rel="external">文件同步工具CwRsync的使用方法及常用命令详解</a></p>
<hr>
<h2 id="同步代码"><a href="#同步代码" class="headerlink" title="同步代码"></a>同步代码</h2><p><strong>参数说明</strong><br><figure class="highlight haml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div></pre></td><td class="code"><pre><div class="line">-<span class="ruby">v, --verbose 详细模式输出</span></div><div class="line">-<span class="ruby">q, --quiet 精简输出模式</span></div><div class="line">-<span class="ruby">c, --checksum 打开校验开关，强制对文件传输进行校验</span></div><div class="line">-<span class="ruby">a, --archive 归档模式，表示以递归方式传输文件，并保持所有文件属性，等于-rlptgoD</span></div><div class="line">-<span class="ruby">r, --recursive 对子目录以递归模式处理</span></div><div class="line">-<span class="ruby">R, --relative 使用相对路径信息</span></div><div class="line">-<span class="ruby">b, --backup 创建备份，也就是对于目的已经存在有同样的文件名时，将老的文件重新命名为~filename。可以使用--suffix选项来指定不同的备份文件前缀。</span></div><div class="line">-<span class="ruby">-backup-dir 将备份文件(如~filename)存放在在目录下。</span></div><div class="line">-<span class="ruby">suffix=SUFFIX 定义备份文件前缀</span></div><div class="line">-<span class="ruby">u, --update 仅仅进行更新，也就是跳过所有已经存在于DST，并且文件时间晚于要备份的文件。(不覆盖更新的文件)</span></div><div class="line">-<span class="ruby">l, --links 保留软链结</span></div><div class="line">-<span class="ruby">L, --copy-links 想对待常规文件一样处理软链结</span></div><div class="line">-<span class="ruby">-copy-unsafe-links 仅仅拷贝指向SRC路径目录树以外的链结</span></div><div class="line">-<span class="ruby">-safe-links 忽略指向SRC路径目录树以外的链结</span></div><div class="line">-<span class="ruby">H, --hard-links 保留硬链结</span></div><div class="line">-<span class="ruby">p, --perms 保持文件权限</span></div><div class="line">-<span class="ruby">o, --owner 保持文件属主信息</span></div><div class="line">-<span class="ruby">g, --group 保持文件属组信息</span></div><div class="line">-<span class="ruby">D, --devices 保持设备文件信息</span></div><div class="line">-<span class="ruby">t, --times 保持文件时间信息</span></div><div class="line">-<span class="ruby">S, --sparse 对稀疏文件进行特殊处理以节省DST的空间</span></div><div class="line">-<span class="ruby">n, --dry-run现实哪些文件将被传输</span></div><div class="line">-<span class="ruby">W, --whole-file 拷贝文件，不进行增量检测</span></div><div class="line">-<span class="ruby">x, --one-file-system 不要跨越文件系统边界</span></div><div class="line">-<span class="ruby">B, --block-size=SIZE 检验算法使用的块尺寸，默认是<span class="number">700</span>字节</span></div><div class="line">-<span class="ruby">e, --rsh=COMMAND 指定使用rsh、ssh方式进行数据同步</span></div><div class="line">-<span class="ruby">-rsync-path=PATH 指定远程服务器上的rsync命令所在路径信息</span></div><div class="line">-<span class="ruby">C, --cvs-exclude 使用和CVS一样的方法自动忽略文件，用来排除那些不希望传输的文件</span></div><div class="line">-<span class="ruby">-existing 仅仅更新那些已经存在于DST的文件，而不备份那些新创建的文件</span></div><div class="line">-<span class="ruby">-delete 删除那些DST中SRC没有的文件,与服务端保持一致</span></div><div class="line">-<span class="ruby">-delete-excluded 同样删除接收端那些被该选项指定排除的文件</span></div><div class="line">-<span class="ruby">-delete-after 传输结束以后再删除</span></div><div class="line">-<span class="ruby">-ignore-errors 及时出现IO错误也进行删除</span></div><div class="line">-<span class="ruby">-max-delete=NUM 最多删除NUM个文件</span></div><div class="line">-<span class="ruby">-partial 保留那些因故没有完全传输的文件，以是加快随后的再次传输</span></div><div class="line">-<span class="ruby">-force 强制删除目录，即使不为空</span></div><div class="line">-<span class="ruby">-numeric-ids 不将数字的用户和组ID匹配为用户名和组名</span></div><div class="line">-<span class="ruby">-timeout=TIME IP超时时间，单位为秒</span></div><div class="line">-<span class="ruby">I, --ignore-times 不跳过那些有同样的时间和长度的文件</span></div><div class="line">-<span class="ruby">-size-only 当决定是否要备份文件时，仅仅察看文件大小而不考虑文件时间</span></div><div class="line">-<span class="ruby">-modify-window=NUM 决定文件是否时间相同时使用的时间戳窗口，默认为<span class="number">0</span></span></div><div class="line">-<span class="ruby">T --temp-dir=DIR 在DIR中创建临时文件</span></div><div class="line">-<span class="ruby">-compare-dest=DIR 同样比较DIR中的文件来决定是否需要备份</span></div><div class="line">-<span class="ruby">P 等同于 --partial</span></div><div class="line">-<span class="ruby">-progress 显示备份过程</span></div><div class="line">-<span class="ruby">z, --compress 对备份的文件在传输时进行压缩处理</span></div><div class="line">-<span class="ruby">-exclude=PATTERN 指定排除不需要传输的文件模式</span></div><div class="line">-<span class="ruby">-<span class="keyword">include</span>=PATTERN 指定不排除而需要传输的文件模式</span></div><div class="line">-<span class="ruby">-exclude-from=FILE 排除FILE中指定模式的文件</span></div><div class="line">-<span class="ruby">-<span class="keyword">include</span>-from=FILE 不排除FILE指定模式匹配的文件</span></div><div class="line">-<span class="ruby">-version 打印版本信息</span></div><div class="line">-<span class="ruby">-address 绑定到特定的地址</span></div><div class="line">-<span class="ruby">-config=FILE 指定其他的配置文件，不使用默认的rsyncd.conf文件</span></div><div class="line">-<span class="ruby">-port=PORT 指定其他的rsync服务端口</span></div><div class="line">-<span class="ruby">-blocking-io 对远程shell使用阻塞IO</span></div><div class="line">-<span class="ruby">stats 给出某些文件的传输状态</span></div><div class="line">-<span class="ruby">-progress 在传输时现实传输过程</span></div><div class="line">-<span class="ruby">-log-format=formAT 指定日志文件格式</span></div><div class="line">-<span class="ruby">-password-file=FILE 从FILE中得到密码</span></div><div class="line">-<span class="ruby">-bwlimit=KBPS 限制I/O带宽，KBytes per second</span></div><div class="line">-<span class="ruby">h, --help 显示帮助信息</span></div></pre></td></tr></table></figure></p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">rsync -auvz --delete SvcCWRSYNC<span class="variable">@172</span>.<span class="number">16.16</span>.<span class="number">80</span><span class="symbol">:</span><span class="symbol">:api</span> /cygdrive/c/Project</div><div class="line">rsync -auvz --delete SvcCWRSYNC<span class="variable">@172</span>.<span class="number">16.16</span>.<span class="number">80</span><span class="symbol">:</span><span class="symbol">:api2</span> /cygdrive/c/Project/APIS_Mobile</div></pre></td></tr></table></figure>
<hr>
]]></content>
    
    <summary type="html">
    
      &lt;script src=&quot;/assets/js/DPlayer.min.js&quot;&gt; &lt;/script&gt;&lt;script src=&quot;/assets/js/APlayer.min.js&quot;&gt; &lt;/script&gt;&lt;h1 id=&quot;搭建同步环境&quot;&gt;&lt;a href=&quot;#搭建同步环境&quot; class=
    
    </summary>
    
      <category term="环境搭建" scheme="https://www.leolan.top/categories/%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/"/>
    
    
      <category term="Rsync" scheme="https://www.leolan.top/tags/Rsync/"/>
    
  </entry>
  
  <entry>
    <title>cmd_bat脚本</title>
    <link href="https://www.leolan.top/posts/58627/"/>
    <id>https://www.leolan.top/posts/58627/</id>
    <published>2017-03-18T14:31:02.000Z</published>
    <updated>2017-04-27T10:14:48.487Z</updated>
    
    <content type="html"><![CDATA[<script src="/assets/js/DPlayer.min.js"> </script><script src="/assets/js/APlayer.min.js"> </script><h1 id="bat-cmd常用命令"><a href="#bat-cmd常用命令" class="headerlink" title="bat_cmd常用命令"></a>bat_cmd常用命令</h1><p><strong>::</strong>　　　注释<br><strong>md</strong>　　　创建目录<br><strong>xcopy</strong>　　　xcopy要用绝对路径才能在脚本里运行，遇到目录会提示，要指定参数，具体参数看帮助<code>xcopy /?</code><br><strong>rd /s /q</strong>　　　删除目录<br>如果要删除一个目录下的所有文件，用del命令是无法删除目录的，可以先<strong>rd</strong>后<strong>md</strong>。<br>同样<strong>移动文件夹</strong>时<strong>move</strong>只能移动文件，而不能移动文件夹；可以先<strong>xcopy</strong>然后<strong>rd</strong>。</p>
<p><strong>puase</strong>　　　结尾加上这个，不用<strong>goto exit</strong>则会等待用户按任意键后才会退出脚本。</p>
<hr>
<h1 id="关于时间的获取-格式：20170318-："><a href="#关于时间的获取-格式：20170318-：" class="headerlink" title="关于时间的获取(格式：20170318)："></a><font color="#0000EE">关于时间的获取</font>(格式：20170318)：</h1><p>win7中：<code>%DATE:~0,4%%DATE:~5,2%%DATE:~8,2%</code><br>win_server：<code>%date:~10,4%%date:~4,2%%date:~7,2%</code></p>
<hr>
<h1 id="电源管理-具体参数看：shutdown-："><a href="#电源管理-具体参数看：shutdown-：" class="headerlink" title="电源管理(具体参数看：shutdown /?)："></a><font color="#0000EE">电源管理</font>(具体参数看：shutdown /?)：</h1><p>在5：30分自动关机：<code>at 05:30 shutdown -s -f</code><br>在XXX分钟后重启：<code>shutdown -r -t 60</code></p>
<hr>
<h1 id="forfiles命令（针对文件的操作命令）："><a href="#forfiles命令（针对文件的操作命令）：" class="headerlink" title="forfiles命令（针对文件的操作命令）："></a><font color="#0000EE">forfiles</font>命令（针对文件的操作命令）：</h1><p>/p 指定的路径<br>/s 包括子目录<br>/m 查找的文件名掩码<br>/d 指定日期,有绝对日期和相对日期, 此处-7指当前日期 的7天前<br>/c 运行的命令行   表示为每个文件执行的命令。命令字符串应该用双引号括起来。默认命令是 “cmd /c echo @file”。下列变量可以用在命令字符串中:</p>
<ul>
<li>@file    - 返回文件名。</li>
<li>@fname   - 返回不带扩展名的文件名。</li>
<li>@ext     - 只返回文件的扩展。</li>
<li>@path    - 返回文件的完整路径。</li>
<li>@relpath - 返回文件的相对路径。</li>
<li>@isdir   - 如果文件类型是目录，返回 “TRUE”；如果是文件，返回 “FALSE”。</li>
<li>@fsize   - 以字节为单位返回文件大小。</li>
<li>@fdate   - 返回文件上一次修改的日期。</li>
<li>@ftime   - 返回文件上一次修改的时间。</li>
</ul>
<p><strong>示例</strong><br>要列出驱动器 C: 上的所有批处理文件，请键入：<br><figure class="highlight gradle"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">forfiles <span class="regexp">/p c:/</span> <span class="regexp">/s /m</span>*.bat <span class="regexp">/c"cmd /</span>c echo @<span class="keyword">file</span> is a batch <span class="keyword">file</span><span class="string">"</span></div></pre></td></tr></table></figure></p>
<p>要列出驱动器 C: 上的所有目录，请键入：<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">forfiles <span class="regexp">/p c:/</span> <span class="regexp">/s /</span>m*.* <span class="regexp">/c"cmd /</span>c <span class="keyword">if</span> <span class="meta">@isdir</span>==<span class="literal">true</span> echo <span class="meta">@file</span> is a directory<span class="string">"</span></div></pre></td></tr></table></figure></p>
<p>要列出驱动器 C: 上存在时间多于 100 天的所有文件，请键入：<br><figure class="highlight awk"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">forfiles <span class="regexp">/p c:/</span> <span class="regexp">/s /m</span>*.* <span class="regexp">/dt-100 /</span>c<span class="string">"cmd /c echo @file :date &gt;= 100 days"</span></div></pre></td></tr></table></figure></p>
<p>要列出驱动器 C: 上 1993 年 1 月 1 日以前创建的所有文件，而且对于日期早于 1993 年 1 月 1 日的文件显示“file is quite old!”，请键入：<br><figure class="highlight awk"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">forfiles <span class="regexp">/p c:/</span> <span class="regexp">/s /m</span>*.* <span class="regexp">/dt-01011993 /</span>c<span class="string">"cmd /c echo @file is quite old!"</span></div></pre></td></tr></table></figure></p>
<p>要按列格式列出驱动器 C: 上所有文件的扩展名，请键入：<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">forfiles <span class="regexp">/p c:/</span> <span class="regexp">/s /</span>m*.* <span class="regexp">/c "cmd /</span>c echo extension of <span class="meta">@file</span> is <span class="number">0x09</span><span class="meta">@ext</span>0x09<span class="string">" With:</span></div></pre></td></tr></table></figure></p>
<p>要列出驱动器 C: 上的所有批处理文件，请键入：<br><figure class="highlight gradle"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">forfiles <span class="regexp">/p c:/</span> <span class="regexp">/s /m</span> *.bat <span class="regexp">/c "cmd /</span>c echo @<span class="keyword">file</span> is a batch <span class="keyword">file</span><span class="string">"</span></div></pre></td></tr></table></figure></p>
<p>要列出驱动器 C: 上的所有目录，请键入：<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">forfiles <span class="regexp">/p c:/</span> <span class="regexp">/s /</span>m *.* <span class="regexp">/c "cmd /</span>c <span class="keyword">if</span> <span class="meta">@isdir</span>==<span class="literal">true</span> echo <span class="meta">@file</span> is a directory<span class="string">"</span></div></pre></td></tr></table></figure></p>
<p>要列出驱动器 C: 上存在时间多于 100 天的所有文件，请键入：<br><figure class="highlight awk"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">forfiles <span class="regexp">/p c:/</span> <span class="regexp">/s /m</span> *.* <span class="regexp">/d t-100 /</span>c <span class="string">"cmd /c echo @file :date &gt;= 100 days"</span></div></pre></td></tr></table></figure></p>
<p>要列出驱动器 C: 上 1993 年 1 月 1 日以前创建的所有文件，而且对于日期早于 1993 年 1 月 1 日的文件显示“file is quite old!”，请键入：<br><figure class="highlight awk"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">forfiles <span class="regexp">/p c:/</span> <span class="regexp">/s /m</span> *.* <span class="regexp">/d t-01011993 /</span>c <span class="string">"cmd /c echo @file is quite old!"</span></div></pre></td></tr></table></figure></p>
<p>要按列格式列出驱动器 C: 上所有文件的扩展名，请键入：<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">forfiles <span class="regexp">/p c:/</span> <span class="regexp">/s /</span>m*.* <span class="regexp">/c "cmd /</span>c echo extension of <span class="meta">@file</span> is <span class="number">0x09</span><span class="meta">@ext</span>0x09<span class="string">"</span></div></pre></td></tr></table></figure></p>
<hr>
<h1 id="for循环"><a href="#for循环" class="headerlink" title="for循环"></a><font color="#0000EE">for循环</font></h1><p>for /?<br>FOR 变量参照的替换已被增强。您现在可以使用下列<br>选项语法:</p>
<pre><code> ~I         - 删除任何引号(&quot;)，扩充 %I
 %~fI        - 将 %I 扩充到一个完全合格的路径名
 %~dI        - 仅将 %I 扩充到一个驱动器号
 %~pI        - 仅将 %I 扩充到一个路径
%~nI        - 仅将 %I 扩充到一个文件名
 %~xI        - 仅将 %I 扩充到一个文件扩展名
 %~sI        - 扩充的路径只含有短名
 %~aI        - 将 %I 扩充到文件的文件属性
 %~tI        - 将 %I 扩充到文件的日期/时间
 %~zI        - 将 %I 扩充到文件的大小
 %~$PATH:I   - 查找列在路径环境变量的目录，并将 %I 扩充
               到找到的第一个完全合格的名称。如果环境变量名
               未被定义，或者没有找到文件，此组合键会扩充到
               空字符串
</code></pre><p>可以组合修饰符来得到多重结果:</p>
<pre><code>%~dpI       - 仅将 %I 扩充到一个驱动器号和路径
%~nxI       - 仅将 %I 扩充到一个文件名和扩展名
%~fsI       - 仅将 %I 扩充到一个带有短名的完整路径名
%~dp$PATH:i - 查找列在路径环境变量的目录，并将 %I 扩充
              到找到的第一个驱动器号和路径。 
%~ftzaI     - 将 %I 扩充到类似输出线路的 DIR
</code></pre><h2 id="删除D-Logs下的空目录"><a href="#删除D-Logs下的空目录" class="headerlink" title="删除D:\Logs下的空目录"></a>删除D:\Logs下的空目录</h2><figure class="highlight dos"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">for</span> /f "delims=" <span class="variable">%%a</span> <span class="keyword">in</span> ('<span class="built_in">dir</span> D:\Logs /b /ad /s ^|sort /r' ) <span class="keyword">do</span> <span class="built_in">rd</span> /q "<span class="variable">%%a</span>" <span class="number">2</span>&gt;<span class="built_in">nul</span></div></pre></td></tr></table></figure>
<hr>
<h2 id="示例脚本1"><a href="#示例脚本1" class="headerlink" title="示例脚本1"></a>示例脚本1</h2><p>这个脚本是复制备份文件到指定目录（目录以20170318这种格式创建），并递归查找7天以上的旧内容并删除。<br><figure class="highlight sqf"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">@<span class="built_in">echo</span> off</div><div class="line"><span class="built_in">echo</span>  ----------------------------------------------------------- &gt;&gt;SQL_bat.<span class="built_in">log</span></div><div class="line"><span class="built_in">echo</span> SQL Databases backup start %<span class="built_in">Date</span>% - %<span class="built_in">time</span>% &gt;&gt;SQL_bat.<span class="built_in">log</span></div><div class="line"></div><div class="line">::<span class="built_in">set</span> yymmdd=%<span class="built_in">DATE</span>:~<span class="number">0</span>,<span class="number">4</span>%%<span class="built_in">DATE</span>:~<span class="number">5</span>,<span class="number">2</span>%%<span class="built_in">DATE</span>:~<span class="number">8</span>,<span class="number">2</span>%</div><div class="line"><span class="built_in">set</span> yymmdd=%<span class="built_in">date</span>:~<span class="number">10</span>,<span class="number">4</span>%%<span class="built_in">date</span>:~<span class="number">4</span>,<span class="number">2</span>%%<span class="built_in">date</span>:~<span class="number">7</span>,<span class="number">2</span>%</div><div class="line">md F:\DB_Buckup\%yymmdd%</div><div class="line">C:\Windows\System32\xcopy.exe C:\DBBackUp_Plan\* F:\DB_Buckup\%yymmdd% /s /e</div><div class="line">C:\Windows\System32\xcopy.exe /e /i C:\DBBackUp_Plan\* F:\DB_Buckup\%yymmdd%</div><div class="line">rd /s /q C:\DBBackUp_Plan</div><div class="line"></div><div class="line">::下面这段是搜索<span class="number">7</span>天以上旧内容并删除</div><div class="line"><span class="built_in">set</span> file_dir=<span class="string">"F:\DB_Buckup"</span></div><div class="line"><span class="built_in">set</span> bak_dat=<span class="number">7</span></div><div class="line">forfiles /p %file_dir% /S /M *.* /D -%bak_dat% /C <span class="string">"cmd /c echo del@relpath file… &amp; echo. &amp; del /s /q @file"</span> &gt;&gt;SQL_bat.<span class="built_in">log</span></div><div class="line"></div><div class="line"><span class="built_in">echo</span> SQL Databases backup <span class="built_in">stop</span> %<span class="built_in">Date</span>% - %<span class="built_in">time</span>% &gt;&gt;SQL_bat.<span class="built_in">log</span></div><div class="line"></div><div class="line"><span class="built_in">echo</span>  ----------------------------------------------------------- &gt;&gt;SQL_bat.<span class="built_in">log</span></div><div class="line"><span class="built_in">goto</span> <span class="keyword">exit</span></div><div class="line">:<span class="keyword">exit</span></div></pre></td></tr></table></figure></p>
<hr>
<h1 id="功能实现"><a href="#功能实现" class="headerlink" title="功能实现"></a>功能实现</h1><h2 id="远程执行程序、脚本"><a href="#远程执行程序、脚本" class="headerlink" title="远程执行程序、脚本"></a>远程执行程序、脚本</h2><p>下载PsExec：<a href="https://technet.microsoft.com/en-us/sysinternals/bb897553.aspx" target="_blank" rel="external">https://technet.microsoft.com/en-us/sysinternals/bb897553.aspx</a><br><strong>下载页面有相关的使用说明</strong><br>解压文件后把psexec放到你需要的位置，如果没有添加环境变量就要用绝对路径去执行。目标主机的防火墙要开135,139这两个端口。</p>
<p><font color="#EE9A00">常见用法</font><br><strong>语法</strong>：<code>psexec 远程主机名/IP -u 用户名 -p 密码 [参数] [被执行的程序]</code><br>只在局域网内应用成功，外网没有测试过，用IP可能会连接不了远程主机，可能是防火墙的问题，可以改用主机名，在cmd里输入hostname查看主机名。</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">psexec \\hostname -u Administrator -<span class="selector-tag">p</span> mypassword -<span class="selector-tag">i</span> <span class="string">"D:\123.bat"</span></div><div class="line">psexec \\hostname -u Administrator -<span class="selector-tag">p</span> mypassword -c <span class="string">"D:\123.bat"</span></div></pre></td></tr></table></figure>
<p><strong>参数</strong>：<br>-i　　是执行远程相应位置的脚本。<br>-c　　是复制本地脚本到远程执行。</p>
<p>参考：<br><a href="http://blog.csdn.net/miss_easy/article/details/47780797" target="_blank" rel="external">http://blog.csdn.net/miss_easy/article/details/47780797</a><br><a href="http://blog.sina.com.cn/s/blog_4e46983d0101ovkw.html" target="_blank" rel="external">http://blog.sina.com.cn/s/blog_4e46983d0101ovkw.html</a></p>
<hr>
<h1 id="备份数据库"><a href="#备份数据库" class="headerlink" title="备份数据库"></a>备份数据库</h1><p>备份SqlServer数据库：<a href="http://www.jb51.net/article/61423.htm" target="_blank" rel="external">SqlServer备份数据库的4种方式介绍</a></p>
<hr>
]]></content>
    
    <summary type="html">
    
      &lt;script src=&quot;/assets/js/DPlayer.min.js&quot;&gt; &lt;/script&gt;&lt;script src=&quot;/assets/js/APlayer.min.js&quot;&gt; &lt;/script&gt;&lt;h1 id=&quot;bat-cmd常用命令&quot;&gt;&lt;a href=&quot;#bat-cmd常用
    
    </summary>
    
      <category term="Dev" scheme="https://www.leolan.top/categories/Dev/"/>
    
    
      <category term="bat脚本" scheme="https://www.leolan.top/tags/bat%E8%84%9A%E6%9C%AC/"/>
    
  </entry>
  
</feed>
